rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isEmailVerified() {
      return request.auth != null && request.auth.token.email_verified;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().accessLevel == role;
    }
    
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().accessLevel in roles;
    }
    
    function hasAccessLevel(level) {
      return isAuthenticated() && getUserData().accessLevel == level;
    }
    
    function hasAnyAccessLevel(levels) {
      return isAuthenticated() && getUserData().accessLevel in levels;
    }
    
    function isActive() {
      return isAuthenticated() && getUserData().status == 'ACTIVE';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // More permissive helper for initial testing/development
    function canAccessHealthcareData() {
      return isAuthenticated() && isActive();
    }
    
    // Users collection (main user data)
    match /users/{userId} {
      // Users can read their own profile, admins can read any
      allow read: if isOwner(userId) || hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      
      // Allow creation for new user registration
      allow create: if isOwner(userId);
      
      // Users can update their own profile
      allow update: if isOwner(userId) || hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      
      // Only admins can delete users
      allow delete: if false; // Prevent deletion for compliance
    }
    
    // User profiles collection (legacy/alternative path)
    match /user-profiles/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId) || hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      
      // Only admins can create users (after auth creation)
      allow create: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) || 
                      (isOwner(userId) && request.auth.token.email_verified);
      
      // Users can update their own profile, but cannot change their accessLevel, status, or access level.
      // Admins have full update rights.
      allow update: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) ||
                      (isOwner(userId) &&
                       request.resource.data.accessLevel == resource.data.accessLevel &&
                       request.resource.data.status == resource.data.status);
      
      // Only admins can delete users
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Audit logs - immutable audit trail for 21 CFR Part 11
    match /audit_logs/{logId} {
      // Anyone authenticated can read audit logs (for transparency)
      allow read: if isAuthenticated() && isActive();
      
      // Audit logs can only be created, never updated or deleted
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.timestamp == request.time;
      allow update: if false;
      allow delete: if false;
    }
    
    // Authentication logs
    match /auth_logs/{logId} {
      // Only admins and the user themselves can read auth logs
      allow read: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) || 
                    (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // System can create auth logs
      allow create: if true; // Auth service needs to log failed attempts
      allow update: if false;
      allow delete: if false;
    }
    
    // Studies collection
    match /studies/{studyId} {
      // Read access based on accessLevel and study assignment
      allow read: if isAuthenticated() && 
                    isActive() && 
                    (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR']) || 
                     request.auth.uid in resource.data.assignedUsers);
      
      // Only admins and investigators can create studies
      allow create: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR']) && isActive();
      
      // Only admins and assigned investigators can update
      allow update: if isActive() && 
                      (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) || 
                       (hasAccessLevel('INVESTIGATOR') && request.auth.uid in resource.data.managers));
      
      // Only admins can delete studies
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      
      // Patient references subcollection under studies
      match /patients/{patientId} {
        // Read access for healthcare roles
        allow read: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY']);
        
        // Create access for healthcare roles
        allow create: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
        
        // Update access for healthcare roles
        allow update: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
        
        // Delete access for admins only
        allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      }
    }
    
    // Study Sections collection
    match /studySections/{sectionId} {
      // Read access for authenticated and active users
      allow read: if isAuthenticated() && isActive();
      
      // Create access for admin and investigator roles
      allow create: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR']) && isActive();
      
      // Update access for admin and investigator roles
      allow update: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR']) && isActive();
      
      // Delete access for admins only
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Forms collection (eCRFs)
    match /forms/{formId} {
      allow read: if isAuthenticated() && isActive();
      allow create: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR']) && isActive();
      allow update: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR']) && 
                      isActive() && 
                      request.resource.data.version > resource.data.version;
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Form submissions
    match /studies/{studyId}/submissions/{submissionId} {
      // Users can read their own submissions or based on accessLevel
      allow read: if isAuthenticated() && 
                    isActive() && 
                    (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR']) || 
                     resource.data.submittedBy == request.auth.uid);
      
      // Data entry users can create submissions
      allow create: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY']) &&
                      request.resource.data.submittedBy == request.auth.uid;
      
      // Updates must maintain data integrity
      allow update: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY']) &&
                      request.resource.data.previousVersion == resource.data.version;
      
      // No deletions allowed (data integrity)
      allow delete: if false;
    }
    
    // Compliance documents
    match /compliance/{docId} {
      allow read: if isAuthenticated() && isActive();
      allow write: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Form Templates collection
    match /formTemplates/{templateId} {
      // Read access for all authenticated users
      allow read: if isAuthenticated() && isActive();
      
      // Create access for admin, investigator, and monitor roles
      allow create: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR']) &&
                      request.resource.data.createdBy == request.auth.uid;
      
      // Update access for admin, template creator, and investigators
      allow update: if isAuthenticated() && 
                      isActive() && 
                      (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) || 
                       resource.data.createdBy == request.auth.uid ||
                       hasAccessLevel('INVESTIGATOR')) &&
                      request.resource.data.updatedBy == request.auth.uid;
      
      // Delete access for admin and template creator
      allow delete: if isAuthenticated() && 
                      isActive() && 
                      (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) || 
                       resource.data.createdBy == request.auth.uid);
    }
    
    // Study Phases collection - CRITICAL FOR PHASE FORMS
    match /studyPhases/{phaseId} {
      // Read access for authenticated and active users
      allow read: if isAuthenticated() && isActive();
      
      // Create access for admin and investigator roles
      allow create: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR']);
      
      // Update access for admin and investigator roles
      allow update: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR']);
      
      // Delete access for admins only
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      
      // Phase progress subcollection
      match /progress/{progressId} {
        allow read: if isAuthenticated() && isActive();
        allow write: if isAuthenticated() && 
                       isActive() && 
                       hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
      }
    }
    
    // PHI Data collection - Protected Health Information
    match /phi/{phiId} {
      // Read access for healthcare roles only
      allow read: if isAuthenticated() && 
                    isActive() && 
                    hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR']);
      
      // Write access for authorized roles
      allow write: if isAuthenticated() && 
                     isActive() && 
                     hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR']);
      
      // No deletions for compliance
      allow delete: if false;
    }
    
    // Patient Folders collection
    match /patientFolders/{folderId} {
      // Read access for healthcare roles
      allow read: if isAuthenticated() && 
                    isActive() && 
                    hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY', 'VIEWER']);
      
      // Write access for data management roles
      allow write: if isAuthenticated() && 
                     isActive() && 
                     hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
    }
    
    // PATIENTS COLLECTION - Main patient records
    match /patients/{patientId} {
      // Read access for healthcare roles
      allow read: if isAuthenticated() && 
                    isActive() && 
                    hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY']);
      
      // Create access for healthcare roles
      allow create: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
      
      // Update access for healthcare roles
      allow update: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
      
      // Delete access restricted to admin only
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      
      // Visits subcollection
      match /visits/{visitId} {
        allow read: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY', 'VIEWER']);
        
        allow create: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
        
        allow update: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
        
        allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
        
        // Visit subcomponents (forms within visits)
        match /subcomponents/{subcomponentId} {
          allow read: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY', 'VIEWER']);
          
          allow create: if isAuthenticated() && 
                          isActive() && 
                          hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
          
          allow update: if isAuthenticated() && 
                          isActive() && 
                          hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
          
          allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
        }
      }
      
      // Documents subcollection
      match /documents/{documentId} {
        allow read: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY', 'VIEWER']);
        
        allow create: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
        
        allow update: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
        
        allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      }
      
      // Audit trail subcollection
      match /auditTrail/{auditId} {
        allow read: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR']);
        
        allow create: if isAuthenticated() && 
                        isActive();
        
        allow update: if false; // Audit trails are immutable
        allow delete: if false; // Audit trails cannot be deleted
      }
      
      // Visit Subcomponents subcollection (patient folders)
      match /visitSubcomponents/{subcomponentId} {
        allow read: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY', 'VIEWER']);
        
        allow create: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
        
        allow update: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
        
        allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      }
      
      // Patient Phase Progress collection
      match /patientPhaseProgress/{progressId} {
        allow read: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY', 'VIEWER']);
        
        allow create: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
        
        allow update: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
        
        allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      }
      
      // Any other subcollections under patients
      match /{subcollection=**} {
        allow read: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY']);
        
        allow write: if isAuthenticated() && 
                       isActive() && 
                       hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
      }
    }
    
    // Patient Phase Progress collection (top-level)
    match /patientPhaseProgress/{progressId} {
      allow read: if isAuthenticated() && 
                    isActive() && 
                    hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY', 'VIEWER']);
      
      allow create: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
      
      allow update: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
      
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Form Instances collection
    match /formInstances/{instanceId} {
      // Read access for healthcare roles
      allow read: if isAuthenticated() && 
                    isActive() && 
                    hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY', 'VIEWER']);
      
      // Create access for data entry roles
      allow create: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']) &&
                      request.resource.data.createdBy == request.auth.uid;
      
      // Update access with version control
      allow update: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
      
      // Delete access restricted to admin only
      allow delete: if isAuthenticated() && 
                       isActive() && 
                       hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Surveys collection
    match /surveys/{surveyId} {
      // Read access for authenticated and active users
      allow read: if isAuthenticated() && 
                    isActive() && 
                    hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY']);
      
      // Create access for admin and investigator roles
      allow create: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']) &&
                      request.resource.data.keys().hasAll(['createdBy', 'createdAt']) &&
                      request.resource.data.createdBy == request.auth.uid;
      
      // Update access for admin, survey creator, and data entry roles
      allow update: if isAuthenticated() && 
                      isActive() && 
                      (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']) || 
                       (resource.data.createdBy == request.auth.uid)) &&
                      request.resource.data.keys().hasAll(['lastModifiedBy', 'lastModifiedAt']) &&
                      request.resource.data.lastModifiedBy == request.auth.uid;
      
      // Delete access restricted to admin only
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      
      // Survey responses subcollection
      match /responses/{responseId} {
        // Read access based on role or if user submitted the response
        allow read: if isAuthenticated() && 
                      isActive() && 
                      (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR']) || 
                       resource.data.submittedBy == request.auth.uid);
        
        // Create access for data entry roles
        allow create: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']) &&
                        request.resource.data.submittedBy == request.auth.uid;
        
        // Update access with restrictions
        allow update: if isAuthenticated() && 
                        isActive() && 
                        (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) || 
                         (resource.data.submittedBy == request.auth.uid && 
                          resource.data.status != 'SUBMITTED'));
        
        // No deletions allowed for data integrity
        allow delete: if false;
      }
    }
    
    
    // Healthcare API collections
    match /healthcareData/{dataId} {
      // Read access for healthcare roles
      allow read: if isAuthenticated() && 
                    isActive() && 
                    hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY']);
      
      // Write access for data management roles
      allow write: if isAuthenticated() && 
                     isActive() && 
                     hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
    }
    
    // Visit Subcomponents collection (standalone)
    match /visitSubcomponents/{subcomponentId} {
      allow read: if isAuthenticated() && 
                    isActive() && 
                    hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY', 'VIEWER']);
      
      allow write: if isAuthenticated() && 
                     isActive() && 
                     hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
    }
    
    // Phase Progress collection (standalone)
    match /phaseProgress/{progressId} {
      allow read: if isAuthenticated() && isActive();
      allow write: if isAuthenticated() && 
                     isActive() && 
                     hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
    }
    
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }
  }
}