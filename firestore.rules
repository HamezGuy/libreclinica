rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isEmailVerified() {
      return request.auth != null && request.auth.token.email_verified;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().accessLevel == role;
    }
    
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().accessLevel in roles;
    }
    
    function hasAccessLevel(level) {
      return isAuthenticated() && getUserData().accessLevel == level;
    }
    
    function hasAnyAccessLevel(levels) {
      return isAuthenticated() && getUserData().accessLevel in levels;
    }
    
    function isActive() {
      return isAuthenticated() && getUserData().status == 'ACTIVE';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection (main user data)
    match /users/{userId} {
      // Users can read their own profile, admins can read any
      allow read: if isOwner(userId) || hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      
      // Allow creation for new user registration
      allow create: if isOwner(userId);
      
      // Users can update their own profile
      allow update: if isOwner(userId) || hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      
      // Only admins can delete users
      allow delete: if false; // Prevent deletion for compliance
    }
    
    // User profiles collection (legacy/alternative path)
    match /user-profiles/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId) || hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      
      // Only admins can create users (after auth creation)
      allow create: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) || 
                      (isOwner(userId) && request.auth.token.email_verified);
      
      // Users can update their own profile, but cannot change their accessLevel, status, or access level.
      // Admins have full update rights.
      allow update: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) ||
                      (isOwner(userId) &&
                       request.resource.data.accessLevel == resource.data.accessLevel &&
                       request.resource.data.status == resource.data.status);
      
      // Only admins can delete users
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Audit logs - immutable audit trail for 21 CFR Part 11
    match /audit_logs/{logId} {
      // Anyone authenticated can read audit logs (for transparency)
      allow read: if isAuthenticated() && isActive();
      
      // Audit logs can only be created, never updated or deleted
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.timestamp == request.time;
      allow update: if false;
      allow delete: if false;
    }
    
    // Authentication logs
    match /auth_logs/{logId} {
      // Only admins and the user themselves can read auth logs
      allow read: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) || 
                    (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // System can create auth logs
      allow create: if true; // Auth service needs to log failed attempts
      allow update: if false;
      allow delete: if false;
    }
    
    // Studies collection
    match /studies/{studyId} {
      // Read access based on accessLevel and study assignment
      allow read: if isAuthenticated() && 
                    isActive() && 
                    (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR']) || 
                     request.auth.uid in resource.data.assignedUsers);
      
      // Only admins and investigators can create studies
      allow create: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR']) && isActive();
      
      // Only admins and assigned investigators can update
      allow update: if isActive() && 
                      (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) || 
                       (hasAccessLevel('INVESTIGATOR') && request.auth.uid in resource.data.managers));
      
      // Only admins can delete studies
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Forms collection (eCRFs)
    match /forms/{formId} {
      allow read: if isAuthenticated() && isActive();
      allow create: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR']) && isActive();
      allow update: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR']) && 
                      isActive() && 
                      request.resource.data.version > resource.data.version;
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Form submissions
    match /studies/{studyId}/submissions/{submissionId} {
      // Users can read their own submissions or based on accessLevel
      allow read: if isAuthenticated() && 
                    isActive() && 
                    (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR']) || 
                     resource.data.submittedBy == request.auth.uid);
      
      // Data entry users can create submissions
      allow create: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY']) &&
                      request.resource.data.submittedBy == request.auth.uid;
      
      // Updates must maintain data integrity
      allow update: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY']) &&
                      request.resource.data.previousVersion == resource.data.version;
      
      // No deletions allowed (data integrity)
      allow delete: if false;
    }
    
    // Compliance documents
    match /compliance/{docId} {
      allow read: if isAuthenticated() && isActive();
      allow write: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Form Templates collection
    match /formTemplates/{templateId} {
      // Read access for all authenticated users
      allow read: if isAuthenticated() && isActive();
      
      // Create access for admin, investigator, and monitor roles
      allow create: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR']) &&
                      request.resource.data.createdBy == request.auth.uid;
      
      // Update access for admin, template creator, and investigators
      allow update: if isAuthenticated() && 
                      isActive() && 
                      (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) || 
                       resource.data.createdBy == request.auth.uid ||
                       hasAccessLevel('INVESTIGATOR')) &&
                      request.resource.data.updatedBy == request.auth.uid;
      
      // Delete access for admin and template creator
      allow delete: if isAuthenticated() && 
                      isActive() && 
                      (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) || 
                       resource.data.createdBy == request.auth.uid);
    }
    
    // Patients collection (FHIR Patient resources)
    match /patients/{patientId} {
      // Read access for healthcare roles
      allow read: if isAuthenticated() && 
                    isActive() && 
                    hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY']);
      
      // Create access for healthcare roles
      allow create: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
      
      // Update access for healthcare roles
      allow update: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
      
      // Delete access restricted to admin only
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Form Instances collection
    match /formInstances/{instanceId} {
      // Read access for healthcare roles
      allow read: if isAuthenticated() && 
                    isActive() && 
                    hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY']);
      
      // Create access for data entry roles
      allow create: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']) &&
                      request.resource.data.createdBy == request.auth.uid;
      
      // Update access with version control
      allow update: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']);
      
      // Delete access restricted to admin only
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Surveys collection
    match /surveys/{surveyId} {
      // Read access for authenticated and active users
      allow read: if isAuthenticated() && 
                    isActive() && 
                    hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY']);
      
      // Create access for admin and investigator roles
      allow create: if isAuthenticated() && 
                      isActive() && 
                      hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']) &&
                      request.resource.data.keys().hasAll(['createdBy', 'createdAt']) &&
                      request.resource.data.createdBy == request.auth.uid;
      
      // Update access for admin, survey creator, and data entry roles
      allow update: if isAuthenticated() && 
                      isActive() && 
                      (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']) || 
                       (resource.data.createdBy == request.auth.uid)) &&
                      request.resource.data.keys().hasAll(['lastModifiedBy', 'lastModifiedAt']) &&
                      request.resource.data.lastModifiedBy == request.auth.uid;
      
      // Delete access restricted to admin only
      allow delete: if hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
      
      // Survey responses subcollection
      match /responses/{responseId} {
        // Read access based on role or if user submitted the response
        allow read: if isAuthenticated() && 
                      isActive() && 
                      (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR']) || 
                       resource.data.submittedBy == request.auth.uid);
        
        // Create access for data entry roles
        allow create: if isAuthenticated() && 
                        isActive() && 
                        hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']) &&
                        request.resource.data.submittedBy == request.auth.uid;
        
        // Update access with restrictions
        allow update: if isAuthenticated() && 
                        isActive() && 
                        (hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']) || 
                         (resource.data.submittedBy == request.auth.uid && 
                          resource.data.status != 'SUBMITTED'));
        
        // No deletions allowed for data integrity
        allow delete: if false;
      }
    }
    
    // Patients collection
    match /patients/{patientId} {
      // Read access for authenticated and active users with appropriate roles
      allow read: if isAuthenticated() && 
                     isActive() && 
                     hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'MONITOR', 'DATA_ENTRY', 'VIEWER']);
      
      // Create access for users with data entry permissions
      allow create: if isAuthenticated() && 
                       isActive() && 
                       hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']) &&
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.createdAt is timestamp;
      
      // Update access for users with appropriate permissions
      allow update: if isAuthenticated() && 
                       isActive() && 
                       hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN', 'INVESTIGATOR', 'DATA_ENTRY']) &&
                       request.resource.data.lastModifiedBy == request.auth.uid &&
                       request.resource.data.lastModifiedAt is timestamp;
      
      // Delete access restricted to admins only
      allow delete: if isAuthenticated() && 
                       isActive() && 
                       hasAnyAccessLevel(['ADMIN', 'SUPER_ADMIN']);
    }
    
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }
  }
}