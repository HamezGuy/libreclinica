<!-- Patient Form Modal -->
<div class="modal-overlay patient-form-modal" *ngIf="show" (click)="onBackdropClick($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <i class="material-icons">person</i>
        New Patient: {{ template?.name }}
      </h2>
      <button class="close-button" (click)="onClose()" [disabled]="isSubmitting">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body patient-form-container">
      <div class="phi-warning">
        <i class="material-icons">security</i>
        <span>This form contains Protected Health Information (PHI). Data will be encrypted and access will be logged.</span>
      </div>
      
      <div class="patient-form" *ngIf="template">
        <form [formGroup]="patientForm" (ngSubmit)="onSubmit()">
          <div 
            *ngFor="let field of template.fields" 
            class="form-group" 
            [class.phi-field]="field.isPhiField">
            
            <label [for]="field.id">
              {{ field.label }}
              <span class="required" *ngIf="field.required">*</span>
              <span class="phi-badge" *ngIf="field.isPhiField">PHI</span>
            </label>
            
            <!-- Text Input -->
            <input 
              *ngIf="field.type === 'text' || field.type === 'email' || field.type === 'phone'"
              [type]="field.type === 'phone' ? 'tel' : field.type"
              [id]="field.id"
              [formControlName]="field.id"
              [placeholder]="field.placeholder"
              class="form-control"
              [class.error]="getFieldControl(field.id).invalid && getFieldControl(field.id).touched">
            
            <!-- Number Input -->
            <input 
              *ngIf="field.type === 'number'"
              type="number"
              [id]="field.id"
              [formControlName]="field.id"
              [placeholder]="field.placeholder"
              class="form-control"
              [class.error]="getFieldControl(field.id).invalid && getFieldControl(field.id).touched">
            
            <!-- Date Input -->
            <input 
              *ngIf="field.type === 'date'"
              type="date"
              [id]="field.id"
              [formControlName]="field.id"
              class="form-control"
              [class.error]="getFieldControl(field.id).invalid && getFieldControl(field.id).touched">
            
            <!-- Select Dropdown -->
            <select 
              *ngIf="field.type === 'select'"
              [id]="field.id"
              [formControlName]="field.id"
              class="form-control"
              [class.error]="getFieldControl(field.id).invalid && getFieldControl(field.id).touched">
              <option value="">{{ field.placeholder || 'Select...' }}</option>
              <option *ngFor="let option of field.options" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
            
            <!-- Radio Buttons -->
            <div *ngIf="field.type === 'radio'" class="radio-group">
              <label *ngFor="let option of field.options" class="radio-label">
                <input 
                  type="radio"
                  [name]="field.id"
                  [value]="option.value"
                  [formControlName]="field.id">
                <span>{{ option.label }}</span>
              </label>
            </div>
            
            <!-- Checkbox -->
            <label *ngIf="field.type === 'checkbox'" class="checkbox-label">
              <input 
                type="checkbox"
                [id]="field.id"
                [formControlName]="field.id">
              <span>{{ field.label }}</span>
            </label>
            
            <!-- Textarea -->
            <textarea 
              *ngIf="field.type === 'textarea'"
              [id]="field.id"
              [formControlName]="field.id"
              [placeholder]="field.placeholder"
              rows="3"
              class="form-control"
              [class.error]="getFieldControl(field.id).invalid && getFieldControl(field.id).touched">
            </textarea>
            
            <!-- PHI Fields -->
            <div *ngIf="field.phiClassification?.phiType === phiFieldTypes.NAME" class="name-fields">
              <input 
                type="text"
                [formControlName]="field.id + '_first'"
                placeholder="First Name"
                class="form-control">
              <input 
                type="text"
                [formControlName]="field.id + '_last'"
                placeholder="Last Name"
                class="form-control">
            </div>
            
            <input 
              *ngIf="field.phiClassification?.phiType === phiFieldTypes.SSN"
              type="text"
              [id]="field.id"
              [formControlName]="field.id"
              placeholder="XXX-XX-XXXX"
              pattern="^\d{3}-\d{2}-\d{4}$"
              class="form-control"
              [class.error]="getFieldControl(field.id).invalid && getFieldControl(field.id).touched">
            
            <input 
              *ngIf="field.phiClassification?.phiType === phiFieldTypes.DOB"
              type="date"
              [id]="field.id"
              [formControlName]="field.id"
              class="form-control"
              [class.error]="getFieldControl(field.id).invalid && getFieldControl(field.id).touched">
            
            <!-- Help Text -->
            <small class="help-text" *ngIf="field.helpText">{{ field.helpText }}</small>
            
            <!-- Error Messages -->
            <div class="error-messages" *ngIf="getFieldErrors(field).length > 0">
              <span class="error-message" *ngFor="let error of getFieldErrors(field)">
                {{ error }}
              </span>
            </div>
          </div>
          
          <!-- Study Assignment (if applicable) -->
          <div class="form-group" *ngIf="availableStudies.length > 0">
            <label for="studyAssignment">
              Assign to Study
              <span class="help-text">Optional: Enroll patient in a study</span>
            </label>
            <select id="studyAssignment" formControlName="studyId" class="form-control">
              <option value="">No study assignment</option>
              <option *ngFor="let study of availableStudies" [value]="study.id">
                {{ study.title }} ({{ study.protocolNumber }})
              </option>
            </select>
          </div>
        </form>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="onClose()" [disabled]="isSubmitting">
        Cancel
      </button>
      <button 
        class="btn btn-primary" 
        (click)="onSubmit()"
        [disabled]="patientForm.invalid || isSubmitting">
        <span *ngIf="!isSubmitting">Create Patient</span>
        <span *ngIf="isSubmitting">
          <i class="material-icons spin">refresh</i>
          Creating...
        </span>
      </button>
    </div>
  </div>
</div>
