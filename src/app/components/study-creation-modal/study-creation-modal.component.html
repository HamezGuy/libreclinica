<!-- Study Creation Modal -->
<div class="modal-overlay" *ngIf="show" (click)="onBackdropClick($event)">
  <div class="modal-content large-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ 'study-creation-modal.create_new_study' | translate }}</h2>
      <button class="close-button" (click)="onClose()" [disabled]="isCreatingStudy">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
        <div class="step-number">1</div>
        <div class="step-label">{{ 'study-creation-modal.basic_information' | translate }}</div>
      </div>
      <div class="step-connector" [class.completed]="currentStep > 1"></div>
      <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
        <div class="step-number">2</div>
        <div class="step-label">{{ 'study-creation-modal.phases_templates' | translate }}</div>
      </div>
      <div class="step-connector" [class.completed]="currentStep > 2"></div>
      <div class="step" [class.active]="currentStep === 3">
        <div class="step-number">3</div>
        <div class="step-label">{{ 'study-creation-modal.review_create' | translate }}</div>
      </div>
    </div>
    
    <form [formGroup]="studyCreationForm" (ngSubmit)="onSubmit()" class="study-creation-form">
      <div class="modal-body">
        
        <!-- Step 1: Basic Information -->
        <div class="step-content" *ngIf="currentStep === 1">
        <!-- Basic Information Section -->
        <div class="form-section">
          <h3>{{ 'study-creation-modal.basic_information' | translate }}</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="protocolNumber">{{ 'study-creation-modal.protocol_number' | translate }}<span class="required">*</span></label>
              <input type="text" id="protocolNumber" formControlName="protocolNumber" class="form-control" [placeholder]="'study-creation-modal.eg_study2024001' | translate">
              <div class="error-message" *ngIf="studyCreationForm.get('protocolNumber')?.touched && studyCreationForm.get('protocolNumber')?.errors">
                <span *ngIf="studyCreationForm.get('protocolNumber')?.errors?.['required']">{{ 'study-creation-modal.protocol_number_is_required' | translate }}</span>
                <span *ngIf="studyCreationForm.get('protocolNumber')?.errors?.['pattern']">{{ 'study-creation-modal.use_uppercase_letters_numbers_and_hyphens_only' | translate }}</span>
              </div>
            </div>
            
            <div class="form-group">
              <label for="version">{{ 'study-creation-modal.version' | translate }}<span class="required">*</span></label>
              <input type="text" id="version" formControlName="version" class="form-control" placeholder="1.0">
            </div>
          </div>
          
          <div class="form-group">
            <label for="title">{{ 'study-creation-modal.study_title' | translate }}<span class="required">*</span></label>
            <input type="text" id="title" formControlName="title" class="form-control" [placeholder]="'study-creation-modal.enter_the_full_study_title' | translate">
            <div class="error-message" *ngIf="studyCreationForm.get('title')?.touched && studyCreationForm.get('title')?.errors">
              <span *ngIf="studyCreationForm.get('title')?.errors?.['required']">{{ 'study-creation-modal.title_is_required' | translate }}</span>
              <span *ngIf="studyCreationForm.get('title')?.errors?.['minlength']">{{ 'study-creation-modal.title_must_be_at_least_5_characters' | translate }}</span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="shortTitle">{{ 'study-creation-modal.short_title' | translate }}</label>
            <input type="text" id="shortTitle" formControlName="shortTitle" class="form-control" [placeholder]="'study-creation-modal.brief_title_or_acronym' | translate">
          </div>
          
          <div class="form-group full-width">
            <label for="description">{{ 'study-creation-modal.study_description' | translate }}<span class="required">*</span></label>
            <textarea id="description" formControlName="description" class="form-control" rows="4" [placeholder]="'study-creation-modal.provide_a_detailed_description_of_the_study_object' | translate"></textarea>
            <div class="error-message" *ngIf="studyCreationForm.get('description')?.touched && studyCreationForm.get('description')?.errors">
              <span *ngIf="studyCreationForm.get('description')?.errors?.['required']">{{ 'study-creation-modal.description_is_required' | translate }}</span>
              <span *ngIf="studyCreationForm.get('description')?.errors?.['minlength']">{{ 'study-creation-modal.description_must_be_at_least_20_characters' | translate }}</span>
            </div>
          </div>
        </div>
        
        <!-- Study Classification Section -->
        <div class="form-section">
          <h3>{{ 'study-creation-modal.study_classification' | translate }}</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="phase">{{ 'study-creation-modal.study_phase' | translate }}<span class="required">*</span></label>
              <select id="phase" formControlName="phase" class="form-control">
                <option value="phase_i">{{ 'study-creation-modal.phase_i' | translate }}</option>
                <option value="phase_ii">{{ 'study-creation-modal.phase_ii' | translate }}</option>
                <option value="phase_iii">{{ 'study-creation-modal.phase_iii' | translate }}</option>
                <option value="phase_iv">{{ 'study-creation-modal.phase_iv' | translate }}</option>
                <option value="pre_clinical">{{ 'study-creation-modal.preclinical' | translate }}</option>
                <option value="pilot">{{ 'study-creation-modal.pilot_study' | translate }}</option>
                <option value="feasibility">{{ 'study-creation-modal.feasibility_study' | translate }}</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="studyType">{{ 'study-creation-modal.study_type' | translate }}<span class="required">*</span></label>
              <select id="studyType" formControlName="studyType" class="form-control">
                <option value="interventional">{{ 'study-creation-modal.interventional' | translate }}</option>
                <option value="observational">{{ 'study-creation-modal.observational' | translate }}</option>
                <option value="registry">{{ 'study-creation-modal.registry' | translate }}</option>
                <option value="expanded_access">{{ 'study-creation-modal.expanded_access' | translate }}</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="status">{{ 'study-creation-modal.study_status' | translate }}<span class="required">*</span></label>
              <select id="status" formControlName="status" class="form-control">
                <option value="planning">{{ 'study-creation-modal.planning' | translate }}</option>
                <option value="protocol_development">{{ 'study-creation-modal.protocol_development' | translate }}</option>
                <option value="regulatory_submission">{{ 'study-creation-modal.regulatory_submission' | translate }}</option>
                <option value="approved">{{ 'study-creation-modal.approved' | translate }}</option>
                <option value="enrolling">{{ 'study-creation-modal.enrolling' | translate }}</option>
                <option value="active">{{ 'study-creation-modal.active' | translate }}</option>
                <option value="closed_to_enrollment">{{ 'study-creation-modal.closed_to_enrollment' | translate }}</option>
                <option value="data_analysis">{{ 'study-creation-modal.data_analysis' | translate }}</option>
                <option value="completed">{{ 'study-creation-modal.completed' | translate }}</option>
                <option value="terminated">{{ 'study-creation-modal.terminated' | translate }}</option>
                <option value="suspended">{{ 'study-creation-modal.suspended' | translate }}</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="therapeuticArea">{{ 'study-creation-modal.therapeutic_area' | translate }}<span class="required">*</span></label>
              <input type="text" id="therapeuticArea" formControlName="therapeuticArea" class="form-control" [placeholder]="'study-creation-modal.eg_oncology_cardiology' | translate">
              <div class="error-message" *ngIf="studyCreationForm.get('therapeuticArea')?.touched &amp;&amp; studyCreationForm.get('therapeuticArea')?.errors?.['required']">{{ 'study-creation-modal.therapeutic_area_is_required' | translate }}</div>
            </div>
            
            <div class="form-group">
              <label for="indication">{{ 'study-creation-modal.indication' | translate }}<span class="required">*</span></label>
              <input type="text" id="indication" formControlName="indication" class="form-control" [placeholder]="'study-creation-modal.eg_type_2_diabetes_mellitus' | translate">
              <div class="error-message" *ngIf="studyCreationForm.get('indication')?.touched &amp;&amp; studyCreationForm.get('indication')?.errors?.['required']">{{ 'study-creation-modal.indication_is_required' | translate }}</div>
            </div>
          </div>
        </div>
        
        <!-- Enrollment Section -->
        <div class="form-section">
          <h3>{{ 'study-creation-modal.enrollment_information' | translate }}</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="plannedEnrollment">{{ 'study-creation-modal.planned_enrollment' | translate }}<span class="required">*</span></label>
              <input type="number" id="plannedEnrollment" formControlName="plannedEnrollment" class="form-control" min="1" [placeholder]="'study-creation-modal.number_of_subjects' | translate">
              <div class="error-message" *ngIf="studyCreationForm.get('plannedEnrollment')?.touched && studyCreationForm.get('plannedEnrollment')?.errors">
                <span *ngIf="studyCreationForm.get('plannedEnrollment')?.errors?.['required']">{{ 'study-creation-modal.planned_enrollment_is_required' | translate }}</span>
                <span *ngIf="studyCreationForm.get('plannedEnrollment')?.errors?.['min']">{{ 'study-creation-modal.must_be_at_least_1' | translate }}</span>
              </div>
            </div>
            
            <div class="form-group">
              <label for="actualEnrollment">{{ 'study-creation-modal.actual_enrollment' | translate }}</label>
              <input type="number" id="actualEnrollment" formControlName="actualEnrollment" class="form-control" min="0" [placeholder]="'study-creation-modal.current_enrolled' | translate">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="plannedStartDate">{{ 'study-creation-modal.planned_start_date' | translate }}</label>
              <input type="date" id="plannedStartDate" formControlName="plannedStartDate" class="form-control">

            </div>
            
            <div class="form-group">
              <label for="plannedEndDate">{{ 'study-creation-modal.planned_end_date' | translate }}</label>
              <input type="date" id="plannedEndDate" formControlName="plannedEndDate" class="form-control">

            </div>
          </div>
        </div>
        
        <!-- Study Team Section -->
        <div class="form-section">
          <h3>{{ 'study-creation-modal.study_team' | translate }}</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="principalInvestigator">{{ 'study-creation-modal.principal_investigator' | translate }}</label>
              <input type="text" id="principalInvestigator" formControlName="principalInvestigator" class="form-control" [placeholder]="'study-creation-modal.pi_name' | translate">

            </div>
            
            <div class="form-group">
              <label for="studyCoordinator">{{ 'study-creation-modal.study_coordinator' | translate }}</label>
              <input type="text" id="studyCoordinator" formControlName="studyCoordinator" class="form-control" [placeholder]="'study-creation-modal.coordinator_name' | translate">
            </div>
          </div>
          
          <div class="form-group">
            <label for="dataManager">{{ 'study-creation-modal.data_manager' | translate }}</label>
            <input type="text" id="dataManager" formControlName="dataManager" class="form-control" [placeholder]="'study-creation-modal.data_manager_name' | translate">
          </div>
        </div>
        
        <!-- Regulatory & Compliance Section -->
        <div class="form-section">
          <h3>{{ 'study-creation-modal.regulatory_compliance' | translate }}</h3>
          <div class="form-row">
            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" formControlName="irbApprovalRequired">
                <span class="checkbox-label">{{ 'study-creation-modal.irb_approval_required' | translate }}</span>
              </label>
            </div>
            
            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" formControlName="consentRequired">
                <span class="checkbox-label">{{ 'study-creation-modal.informed_consent_required' | translate }}</span>
              </label>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" formControlName="requiresElectronicSignatures">
                <span class="checkbox-label">{{ 'study-creation-modal.electronic_signatures_required' | translate }}</span>
              </label>
            </div>
            
            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" formControlName="auditTrailRequired">
                <span class="checkbox-label">{{ 'study-creation-modal.audit_trail_required' | translate }}</span>
              </label>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="dataIntegrityLevel">{{ 'study-creation-modal.data_integrity_level' | translate }}<span class="required">*</span></label>
              <select id="dataIntegrityLevel" formControlName="dataIntegrityLevel" class="form-control">
                <option value="basic">{{ 'study-creation-modal.basic' | translate }}</option>
                <option value="enhanced">{{ 'study-creation-modal.enhanced' | translate }}</option>
                <option value="maximum">{{ 'study-creation-modal.maximum' | translate }}</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="dataRetentionPeriod">{{ 'study-creation-modal.data_retention_period_months' | translate }}<span class="required">*</span></label>
              <input type="number" id="dataRetentionPeriod" formControlName="dataRetentionPeriod" min="12" placeholder="120" class="form-control">
              <div class="error-message" *ngIf="studyCreationForm.get('dataRetentionPeriod')?.touched && studyCreationForm.get('dataRetentionPeriod')?.errors">
                <span *ngIf="studyCreationForm.get('dataRetentionPeriod')?.errors?.['required']">{{ 'study-creation-modal.retention_period_is_required' | translate }}</span>
                <span *ngIf="studyCreationForm.get('dataRetentionPeriod')?.errors?.['min']">{{ 'study-creation-modal.must_be_at_least_12_months' | translate }}</span>
              </div>
            </div>
          </div>
        </div>
        </div> <!-- End Step 1 -->
        
        <!-- Step 2: Phases & Templates -->
        <div class="step-content" *ngIf="currentStep === 2">
          <div class="form-section">
            <div class="section-header">
              <h3>{{ 'study-creation-modal.study_phasessections' | translate }}</h3>
              <button type="button" class="btn btn-primary btn-sm" (click)="addSection()">
                <i class="material-icons">add</i>{{ 'study-creation-modal.add_phasesection' | translate }}</button>
            </div>
            
            <div class="sections-container" formArrayName="sections" *ngIf="sectionsArray">
              <div class="section-card" *ngFor="let section of sectionsArray.controls; let i = index" [formGroupName]="i">
                <div class="section-header">
                  <h4>Phase {{i + 1}}</h4>
                  <button type="button" class="btn btn-danger btn-sm" (click)="removeSection(i)">
                    <i class="material-icons">delete</i>
                  </button>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label>{{ 'study-creation-modal.phasesection_name' | translate }}<span class="required">*</span></label>
                    <input type="text" formControlName="name" class="form-control" [class.is-invalid]="section.get('name')?.invalid &amp;&amp; section.get('name')?.touched" [placeholder]="'study-creation-modal.eg_screening_visit' | translate">
                    <div class="invalid-feedback" *ngIf="section.get('name')?.invalid &amp;&amp; section.get('name')?.touched">{{ 'study-creation-modal.phase_name_is_required' | translate }}</div>
                  </div>
                  <div class="form-group">
                    <label>{{ 'common.type' | translate }}<span class="required">*</span></label>
                    <select formControlName="type" class="form-control" [class.is-invalid]="section.get('type')?.invalid &amp;&amp; section.get('type')?.touched">
                      <option value="visit">{{ 'study-creation-modal.visit' | translate }}</option>
                      <option value="screening">{{ 'study-creation-modal.screening' | translate }}</option>
                      <option value="baseline">{{ 'study-creation-modal.baseline' | translate }}</option>
                      <option value="treatment">{{ 'study-creation-modal.treatment' | translate }}</option>
                      <option value="followup">{{ 'study-creation-modal.followup' | translate }}</option>
                      <option value="unscheduled">{{ 'study-creation-modal.unscheduled' | translate }}</option>
                    </select>
                    <div class="invalid-feedback" *ngIf="section.get('type')?.invalid &amp;&amp; section.get('type')?.touched">{{ 'study-creation-modal.phase_type_is_required' | translate }}</div>
                  </div>
                  <div class="form-group">
                    <label>{{ 'common.description' | translate }}</label>
                    <textarea formControlName="description" class="form-control" rows="2" [placeholder]="'study-creation-modal.phase_description' | translate"></textarea>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label>{{ 'study-creation-modal.scheduled_day' | translate }}</label>
                    <input type="number" formControlName="scheduledDay" class="form-control" [placeholder]="'study-creation-modal.day_number' | translate">
                  </div>
                  <div class="form-group">
                    <label>{{ 'study-creation-modal.window_start_days_before' | translate }}</label>
                    <input type="number" formControlName="windowStart" class="form-control" [placeholder]="'study-creation-modal.eg_3' | translate">
                  </div>
                  <div class="form-group">
                    <label>{{ 'study-creation-modal.window_end_days_after' | translate }}</label>
                    <input type="number" formControlName="windowEnd" class="form-control" [placeholder]="'study-creation-modal.eg_3' | translate">
                  </div>
                  <div class="form-group checkbox-group">
                    <label>
                      <input type="checkbox" formControlName="isOptional">{{ 'study-creation-modal.optional_phase' | translate }}</label>
                  </div>
                </div>
                
                <!-- Templates Assignment -->
                <div class="templates-section">
                  <h5>{{ 'study-creation-modal.assigned_templates' | translate }}</h5>
                  <div class="assigned-templates">
                    <div class="template-item" *ngFor="let template of getFormTemplatesArray(i).controls; let j = index">
                      <span class="template-name">{{ template.get('templateName')?.value }}</span>
                      <label class="required-toggle">
                        <input type="checkbox" [checked]="template.get('isRequired')?.value" (change)="toggleTemplateRequired(i, j)">{{ 'study-creation-modal.required' | translate }}</label>
                      <button type="button" class="btn btn-sm btn-danger" (click)="removeTemplateFromSection(i, j)">
                        <i class="material-icons">remove</i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="template-selector">
                    <label>{{ 'study-creation-modal.select_templates_for_this_phase' | translate }}</label>
                    <app-template-gallery [templates]="availableTemplates" [selectedTemplates]="getSelectedTemplateIds(i)" (templateSelected)="onTemplateGallerySelect(i, $event)">
                    </app-template-gallery>
                  </div>
                </div>
              </div>
              
              <div class="empty-state" *ngIf="!sectionsArray || sectionsArray.length === 0">
                <i class="material-icons">folder_open</i>
                <p>{{ 'study-creation-modal.no_phasessections_added_yet' | translate }}</p>
                <p class="text-muted">{{ 'study-creation-modal.click_add_phasesection_to_get_started' | translate }}</p>
              </div>
            </div>
          </div>
        </div> <!-- End Step 2 -->
        
        <!-- Step 3: Review & Create -->
        <div class="step-content" *ngIf="currentStep === 3">
          <div class="form-section">
            <h3>{{ 'study-creation-modal.review_study_configuration' | translate }}</h3>
            
            <div class="review-section">
              <h4>{{ 'study-creation-modal.basic_information' | translate }}</h4>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.protocol_number' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('protocolNumber')!.value }}</span>
              </div>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.version' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('version')!.value }}</span>
              </div>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.title' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('title')!.value }}</span>
              </div>
              <div class="review-item" *ngIf="studyCreationForm.get('shortTitle')!.value">
                <span class="label">{{ 'study-creation-modal.short_title' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('shortTitle')!.value }}</span>
              </div>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.description' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('description')!.value }}</span>
              </div>
            </div>
            
            <div class="review-section">
              <h4>{{ 'study-creation-modal.study_classification' | translate }}</h4>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.phase' | translate }}</span>
                <span class="value">{{ getPhaseLabel(studyCreationForm.get('phase')!.value) }}</span>
              </div>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.study_type' | translate }}</span>
                <span class="value">{{ getStudyTypeLabel(studyCreationForm.get('studyType')!.value) }}</span>
              </div>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.therapeutic_area' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('therapeuticArea')!.value }}</span>
              </div>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.indication' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('indication')!.value }}</span>
              </div>
            </div>
            
            <div class="review-section">
              <h4>{{ 'study-creation-modal.timeline_enrollment' | translate }}</h4>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.status' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('status')!.value }}</span>
              </div>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.planned_enrollment' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('plannedEnrollment')!.value }} patients</span>
              </div>
              <div class="review-item" *ngIf="studyCreationForm.get('plannedStartDate')!.value">
                <span class="label">{{ 'study-creation-modal.planned_start_date' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('plannedStartDate')!.value | date }}</span>
              </div>
              <div class="review-item" *ngIf="studyCreationForm.get('plannedEndDate')!.value">
                <span class="label">{{ 'study-creation-modal.planned_end_date' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('plannedEndDate')!.value | date }}</span>
              </div>
            </div>
            
            <div class="review-section">
              <h4>{{ 'study-creation-modal.study_team' | translate }}</h4>
              <div class="review-item" *ngIf="studyCreationForm.get('principalInvestigator')!.value">
                <span class="label">{{ 'study-creation-modal.principal_investigator' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('principalInvestigator')!.value }}</span>
              </div>
              <div class="review-item" *ngIf="studyCreationForm.get('studyCoordinator')!.value">
                <span class="label">{{ 'study-creation-modal.study_coordinator' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('studyCoordinator')!.value }}</span>
              </div>
              <div class="review-item" *ngIf="studyCreationForm.get('dataManager')!.value">
                <span class="label">{{ 'study-creation-modal.data_manager' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('dataManager')!.value }}</span>
              </div>
            </div>
            
            <div class="review-section">
              <h4>{{ 'study-creation-modal.regulatory_compliance' | translate }}</h4>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.irb_approval_required' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('irbApprovalRequired')!.value ? 'Yes' : 'No' }}</span>
              </div>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.informed_consent_required' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('consentRequired')!.value ? 'Yes' : 'No' }}</span>
              </div>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.electronic_signatures' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('requiresElectronicSignatures')!.value ? 'Required' : 'Not Required' }}</span>
              </div>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.audit_trail' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('auditTrailRequired')!.value ? 'Required' : 'Not Required' }}</span>
              </div>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.data_integrity_level' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('dataIntegrityLevel')!.value }}</span>
              </div>
              <div class="review-item">
                <span class="label">{{ 'study-creation-modal.data_retention_period' | translate }}</span>
                <span class="value">{{ studyCreationForm.get('dataRetentionPeriod')!.value }} months</span>
              </div>
            </div>
            
            <div class="review-section">
              <h4>Phases/Sections ({{ sectionsArray.length }})</h4>
              <div class="phase-review" *ngFor="let section of sectionsArray.controls; let i = index">
                <h5>{{ section.get('name')!.value }}</h5>
                <p class="text-muted">{{ section.get('description')!.value || 'No description' }}</p>
                <p><strong>{{ 'study-creation-modal.templates' | translate }}</strong> {{ getFormTemplatesArray(i).length }} assigned</p>
                <ul>
                  <li *ngFor="let template of getFormTemplatesArray(i).controls">
                    {{ template.get('templateName')!.value }}
                    <span class="badge" [class.badge-required]="template.get('isRequired')!.value">
                      {{ template.get('isRequired')!.value ? 'Required' : 'Optional' }}
                    </span>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div> <!-- End Step 3 -->
        
      </div>
      
      <div class="modal-footer">
        <div class="footer-left">
          <button type="button" class="btn btn-secondary" (click)="onClose()" [disabled]="isCreatingStudy">{{ 'common.cancel' | translate }}</button>
          <div class="validation-message" *ngIf="getStepValidationMessage()">
            <i class="material-icons">info</i>
            {{ getStepValidationMessage() }}
          </div>
        </div>
        <div class="footer-right">
          <button type="button" class="btn btn-secondary" (click)="previousStep()" [disabled]="currentStep === 1 || isCreatingStudy">
            <i class="material-icons">arrow_back</i>{{ 'common.previous' | translate }}</button>
          <button type="button" class="btn btn-primary" (click)="nextStep()" [disabled]="!isStepValid(currentStep) || currentStep === totalSteps || isCreatingStudy" [title]="!isStepValid(currentStep) ? getStepValidationMessage() : ''" *ngIf="currentStep < totalSteps">{{ 'common.next' | translate }}<i class="material-icons">arrow_forward</i>
          </button>
          <button type="submit" class="btn btn-success" [disabled]="isCreatingStudy" *ngIf="currentStep === totalSteps">
            <span *ngIf="!isCreatingStudy">{{ 'study-creation-modal.create_study' | translate }}</span>
            <span *ngIf="isCreatingStudy">
              <i class="material-icons spin">refresh</i>{{ 'study-creation-modal.creating' | translate }}</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>