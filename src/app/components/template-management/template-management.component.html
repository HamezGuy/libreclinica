<!-- Enhanced Template Management Modal --><div class="modal-overlay template-management-modal" *ngIf="isVisible" (click)="onClose()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2><i class="material-icons">description</i>{{ 'template.form_templates' | translate }}</h2>
      <div class="header-actions">
        <button class="btn btn-primary" (click)="onCreateTemplate()" *ngIf="permissions.canCreate">
          <i class="material-icons">add</i>{{ 'template.create_template' | translate }}</button>
        <button class="close-btn" (click)="onClose()">
          <i class="material-icons">close</i>
        </button>
      </div>
    </div>
    
    <div class="modal-body">
        <!-- Left Sidebar - Template List -->
        <div class="templates-sidebar">
          <div class="sidebar-header">
            <div class="search-container">
              <i class="material-icons">search</i>
              <input type="text" [(ngModel)]="templateSearchTerm" (ngModelChange)="filterTemplates()" class="search-input" [placeholder]="'template.search_templates' | translate">
            </div>
            
            <div class="filter-buttons">
              <button class="filter-btn" [class.active]="templateFilter === 'all'" (click)="setTemplateFilter('all')">
                {{ 'template.all' | translate }} ({{ templates.length }})
              </button>
              <button class="filter-btn" [class.active]="templateFilter === 'draft'" (click)="setTemplateFilter('draft')">
                {{ 'template.draft' | translate }} ({{ getTemplateCountByStatus('draft') }})
              </button>
              <button class="filter-btn" [class.active]="templateFilter === 'published'" (click)="setTemplateFilter('published')">
                {{ 'template.published' | translate }} ({{ getTemplateCountByStatus('published') }})
              </button>
            </div>
          </div>
          
          <div class="templates-list">
            <div *ngFor="let template of filteredTemplates; trackBy: trackTemplate" class="template-item" [class.selected]="selectedTemplate?.id === template.id" (click)="selectTemplate(template)">
              <div class="template-header">
                <h4>{{ template.name }}</h4>
                <span class="status-badge" [class]="'status-' + template.status">{{ template.status }}</span>
              </div>
              
              <p class="template-description">{{ template.description || ('template.no_description' | translate) }}</p>
              
              <div class="template-stats">
                <div class="stat">
                  <i class="material-icons">input</i>
                  <span>{{ template.fields.length || 0 }} {{ 'template.fields' | translate }}</span>
                </div>
                <div class="stat">
                  <i class="material-icons">folder</i>
                  <span>{{ template.category || ('template.general' | translate) }}</span>
                </div>
                <div class="stat">
                  <i class="material-icons">schedule</i>
                  <span>{{ convertTimestampToDate(template.updatedAt) | date:'short' }}</span>
                </div>
              </div>
              
              <div class="template-actions-quick" (click)="$event.stopPropagation()">
                <button class="btn-icon" (click)="onEditTemplate(template)" [disabled]="!permissions.canEdit || template.status === 'archived'" [title]="template.status === 'archived' ? ('template.archived_cannot_edit' | translate) : ('template.edit_template' | translate)">
                  <i class="material-icons">edit</i>
                </button>
                <button class="btn-icon danger" (click)="onDeleteTemplate(template)" [disabled]="!permissions.canDelete || template.status === 'archived'" [title]="template.status === 'archived' ? ('template.archived_cannot_delete' | translate) : ('template.delete_template' | translate)">
                  <i class="material-icons">delete</i>
                </button>
              </div>
            </div>
          </div>
          
          <div *ngIf="filteredTemplates.length === 0" class="empty-state">
            <i class="material-icons">description</i>
            <h3>{{ 'template.no_templates_found' | translate }}</h3>
            <p>{{ templateSearchTerm ? ('template.try_adjusting_search' | translate) : ('template.create_first_template' | translate) }}</p>
          </div>
          
          <!-- Template Details at Bottom of Sidebar -->
          <div *ngIf="selectedTemplate" class="template-details-bottom">
            <div class="details-section">
              <h4>{{ 'template.template_information' | translate }}</h4>
              <div class="info-list">
                <div class="info-item">
                  <span class="label">{{ 'template.version' | translate }}</span>
                  <span class="value">{{ selectedTemplate.version }}</span>
                </div>
                <div class="info-item">
                  <span class="label">{{ 'template.created' | translate }}</span>
                  <span class="value">{{ convertTimestampToDate(selectedTemplate.createdAt) | date:'medium' }}</span>
                </div>
                <div class="info-item">
                  <span class="label">{{ 'template.created_by' | translate }}</span>
                  <span class="value">{{ selectedTemplate.createdBy }}</span>
                </div>
                <div class="info-item" *ngIf="selectedTemplate.isPhiForm">
                  <span class="label">{{ 'template.phi_form' | translate }}</span>
                  <span class="value phi-badge">
                    <i class="material-icons">security</i>{{ 'template.contains_phi' | translate }}</span>
                </div>
              </div>
            </div>
            
            <div class="template-actions">
              <button class="btn btn-sm btn-primary" (click)="onEditTemplate(selectedTemplate)" [disabled]="!permissions.canEdit || selectedTemplate.status === 'archived'" [title]="selectedTemplate.status === 'archived' ? ('template.archived_cannot_edit' | translate) : ('template.edit_template' | translate)">
                <i class="material-icons">edit</i>{{ 'template.edit_template' | translate }}</button>
              <button class="btn btn-sm btn-success" (click)="onPublishTemplate(selectedTemplate)" [disabled]="!permissions.canPublish || selectedTemplate.status === 'published' || selectedTemplate.status === 'archived'" [title]="selectedTemplate.status === 'archived' ? ('template.archived_cannot_publish' | translate) : ('template.publish_template' | translate)">
                <i class="material-icons">publish</i>{{ 'template.publish' | translate }}</button>
              <button class="btn btn-sm btn-info" (click)="onFillTemplate(selectedTemplate)" [title]="'template.fill_template_testing' | translate">
                <i class="material-icons">assignment</i>{{ 'template.fill_template' | translate }}</button>
              <button class="btn btn-sm btn-secondary" (click)="onDuplicateTemplate(selectedTemplate)" [disabled]="!permissions.canCreate">
                <i class="material-icons">content_copy</i>{{ 'template.duplicate' | translate }}</button>
              <button class="btn btn-sm btn-secondary" (click)="onExportTemplate(selectedTemplate)">
                <i class="material-icons">download</i>{{ 'common.export' | translate }}</button>
              <button class="btn btn-sm btn-danger" (click)="onDeleteTemplate(selectedTemplate)" [disabled]="!permissions.canDelete || selectedTemplate.status === 'archived'" [title]="selectedTemplate.status === 'archived' ? ('template.archived_cannot_delete' | translate) : ('template.delete_template' | translate)">
                <i class="material-icons">delete</i>{{ 'common.delete' | translate }}</button>
            </div>
          </div>
        </div>
        
        <!-- Right Panel - Always Show Preview -->
        <div class="template-preview-panel">
          <div *ngIf="!selectedTemplate" class="no-selection">
            <i class="material-icons">visibility</i>
            <h3>{{ 'template.select_a_template_to_preview' | translate }}</h3>
            <p>{{ 'template.choose_a_template_from_the_list_to_see_its_details' | translate }}</p>
          </div>
          
          <div *ngIf="selectedTemplate" class="template-preview">
            <div class="preview-header">
              <h3>{{ selectedTemplate.name }}</h3>
              <p class="preview-description">{{ selectedTemplate.description }}</p>
            </div>
            
            <div class="preview-fields">
              <h4>{{ 'template.form_fields' | translate }} ({{ selectedTemplate.fields.length }})</h4>
              <div class="field-list">
                <div *ngFor="let field of selectedTemplate.fields; trackBy: trackField" class="field-item">
                  <div class="field-header">
                    <i class="material-icons">{{ getFieldIcon(field.type) }}</i>
                    <span class="field-name">{{ field.label }}</span>
                    <span class="field-type">{{ 'form-builder.' + getFieldTranslationKey(field.type) | translate }}</span>
                  </div>
                  <div class="field-details">
                    <span *ngIf="field.required" class="required-badge">{{ 'template.required' | translate }}</span>
                    <span *ngIf="field.isPhiField" class="phi-badge">{{ 'template.phi' | translate }}</span>
                    <span *ngIf="field.validationRules &amp;&amp; field.validationRules.length > 0" class="validation-badge">{{ 'template.has_validation' | translate }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>
  </div>
</div>