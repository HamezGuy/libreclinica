<!-- Substudy Modal -->
<div class="modal-overlay" *ngIf="show" (click)="onBackdropClick($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <i class="material-icons">science</i>
        {{ isEditMode ? 'Edit' : 'Create' }} Substudy
        <span class="parent-study" *ngIf="parentStudy">for {{ parentStudy.title }}</span>
      </h2>
      <button class="close-button" (click)="onClose()" [disabled]="isSubmitting">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <form [formGroup]="substudyForm" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="name">
            Substudy Name
            <span class="required">*</span>
          </label>
          <input 
            type="text"
            id="name"
            formControlName="name"
            class="form-control"
            placeholder="Enter substudy name"
            [class.error]="substudyForm.get('name')?.invalid && substudyForm.get('name')?.touched">
          <div class="error-message" *ngIf="substudyForm.get('name')?.invalid && substudyForm.get('name')?.touched">
            <span *ngIf="substudyForm.get('name')?.errors?.['required']">Substudy name is required</span>
            <span *ngIf="substudyForm.get('name')?.errors?.['minlength']">Substudy name must be at least 3 characters</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="description">
            Description
            <span class="required">*</span>
          </label>
          <textarea 
            id="description"
            formControlName="description"
            class="form-control"
            rows="3"
            placeholder="Describe the purpose and objectives of this substudy"
            [class.error]="substudyForm.get('description')?.invalid && substudyForm.get('description')?.touched">
          </textarea>
          <div class="error-message" *ngIf="substudyForm.get('description')?.invalid && substudyForm.get('description')?.touched">
            <span *ngIf="substudyForm.get('description')?.errors?.['required']">Description is required</span>
            <span *ngIf="substudyForm.get('description')?.errors?.['minlength']">Description must be at least 10 characters</span>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="protocolNumber">
              Protocol Number
              <span class="required">*</span>
            </label>
            <input 
              type="text"
              id="protocolNumber"
              formControlName="protocolNumber"
              class="form-control"
              placeholder="e.g., SUB-2024-001"
              [class.error]="substudyForm.get('protocolNumber')?.invalid && substudyForm.get('protocolNumber')?.touched">
            <div class="error-message" *ngIf="substudyForm.get('protocolNumber')?.invalid && substudyForm.get('protocolNumber')?.touched">
              <span *ngIf="substudyForm.get('protocolNumber')?.errors?.['required']">Protocol number is required</span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="phase">
              Phase
              <span class="required">*</span>
            </label>
            <select 
              id="phase"
              formControlName="phase"
              class="form-control"
              [class.error]="substudyForm.get('phase')?.invalid && substudyForm.get('phase')?.touched">
              <option value="">Select phase...</option>
              <option *ngFor="let phase of phases" [value]="phase.value">
                {{ phase.label }}
              </option>
            </select>
            <div class="error-message" *ngIf="substudyForm.get('phase')?.invalid && substudyForm.get('phase')?.touched">
              <span *ngIf="substudyForm.get('phase')?.errors?.['required']">Phase is required</span>
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="status">
              Status
              <span class="required">*</span>
            </label>
            <select 
              id="status"
              formControlName="status"
              class="form-control"
              [class.error]="substudyForm.get('status')?.invalid && substudyForm.get('status')?.touched">
              <option *ngFor="let status of statuses" [value]="status.value">
                {{ status.label }}
              </option>
            </select>
            <div class="error-message" *ngIf="substudyForm.get('status')?.invalid && substudyForm.get('status')?.touched">
              <span *ngIf="substudyForm.get('status')?.errors?.['required']">Status is required</span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="targetEnrollment">
              Target Enrollment
              <span class="required">*</span>
            </label>
            <input 
              type="number"
              id="targetEnrollment"
              formControlName="targetEnrollment"
              class="form-control"
              placeholder="Number of participants"
              min="1"
              max="10000"
              [class.error]="substudyForm.get('targetEnrollment')?.invalid && substudyForm.get('targetEnrollment')?.touched">
            <div class="error-message" *ngIf="substudyForm.get('targetEnrollment')?.invalid && substudyForm.get('targetEnrollment')?.touched">
              <span *ngIf="substudyForm.get('targetEnrollment')?.errors?.['required']">Target enrollment is required</span>
              <span *ngIf="substudyForm.get('targetEnrollment')?.errors?.['min']">Target enrollment must be at least 1</span>
              <span *ngIf="substudyForm.get('targetEnrollment')?.errors?.['max']">Target enrollment cannot exceed 10,000</span>
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="startDate">
              Start Date
              <span class="required">*</span>
            </label>
            <input 
              type="date"
              id="startDate"
              formControlName="startDate"
              class="form-control"
              [class.error]="substudyForm.get('startDate')?.invalid && substudyForm.get('startDate')?.touched">
            <div class="error-message" *ngIf="substudyForm.get('startDate')?.invalid && substudyForm.get('startDate')?.touched">
              <span *ngIf="substudyForm.get('startDate')?.errors?.['required']">Start date is required</span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="endDate">
              End Date
              <span class="optional">(Optional)</span>
            </label>
            <input 
              type="date"
              id="endDate"
              formControlName="endDate"
              class="form-control">
          </div>
        </div>
        
        <div class="info-box" *ngIf="substudy">
          <div class="info-item">
            <i class="material-icons">people</i>
            <span>Current Enrollment: {{ substudy.currentEnrollment || 0 }} / {{ substudyForm.get('targetEnrollment')?.value }}</span>
          </div>
          <div class="info-item">
            <i class="material-icons">event</i>
            <span>Created: {{ substudy.createdAt | date:'short' }}</span>
          </div>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="onClose()" [disabled]="isSubmitting">
        Cancel
      </button>
      <button 
        class="btn btn-primary" 
        (click)="onSubmit()"
        [disabled]="substudyForm.invalid || isSubmitting">
        <span *ngIf="!isSubmitting">{{ isEditMode ? 'Update' : 'Create' }} Substudy</span>
        <span *ngIf="isSubmitting">
          <i class="material-icons spin">refresh</i>
          {{ isEditMode ? 'Updating' : 'Creating' }}...
        </span>
      </button>
    </div>
  </div>
</div>
