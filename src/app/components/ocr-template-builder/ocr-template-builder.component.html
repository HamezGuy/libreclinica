<html><head></head><body><div class="ocr-template-builder">
  <!-- Header -->
  <div class="modal-header">
    <h2>{{ 'ocr-template-builder.create_template_from_scanned_form' | translate }}</h2>
    <button mat-icon-button="" (click)="cancel()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Progress Steps -->
  <div class="progress-steps">
    <div class="step" [class.active]="viewMode === 'upload'" [class.completed]="viewMode !== 'upload' &amp;&amp; selectedFile">
      <div class="step-number">1</div>
      <div class="step-label">{{ 'ocr-template-builder.upload_form' | translate }}</div>
    </div>
    <div class="step" [class.active]="viewMode === 'processing'">
      <div class="step-number">2</div>
      <div class="step-label">{{ 'ocr-template-builder.processing' | translate }}</div>
    </div>
    <div class="step" [class.active]="viewMode === 'review'" [class.completed]="viewMode === 'fields'">
      <div class="step-number">3</div>
      <div class="step-label">{{ 'ocr-template-builder.review_ocr' | translate }}</div>
    </div>
    <div class="step" [class.active]="viewMode === 'fields'">
      <div class="step-number">4</div>
      <div class="step-label">{{ 'ocr-template-builder.configure_fields' | translate }}</div>
    </div>
  </div>

  <!-- Content -->
  <div class="modal-content">
    <!-- Upload View -->
    <div class="upload-view" *ngIf="viewMode === 'upload'">
      <div class="upload-area" (click)="fileInput.click()">
        <mat-icon class="upload-icon">{{ 'ocr-template-builder.cloudupload' | translate }}</mat-icon>
        <h3>{{ 'ocr-template-builder.upload_scanned_form' | translate }}</h3>
        <p>{{ 'ocr-template-builder.click_to_browse_or_drag_and_drop_your_scanned_form' | translate }}</p>
        <p class="file-types">{{ 'ocr-template-builder.supported_pdf_png_jpg_jpeg_tiff_bmp_max_5mb' | translate }}</p>
        <input #fileInput="" type="file" hidden="" (change)="onFileSelected($event)" accept=".pdf,.png,.jpg,.jpeg,.tiff,.bmp">
      </div>

      <div class="selected-file" *ngIf="selectedFile">
        <mat-icon>description</mat-icon>
        <span>{{ selectedFile.name }}</span>
        <button mat-icon-button="" (click)="selectedFile = null; imagePreviewUrl = null">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="template-info">
        <h4>{{ 'ocr-template-builder.template_information' | translate }}</h4>
        <form [formGroup]="templateForm">
          <div class="form-field">
            <label>{{ 'ocr-template-builder.template_name_' | translate }}</label>
            <input type="text" formControlName="name" [placeholder]="'ocr-template-builder.eg_patient_registration_form' | translate">
          </div>
          <div class="form-field">
            <label>{{ 'common.description' | translate }}</label>
            <textarea formControlName="description" rows="3" [placeholder]="'ocr-template-builder.brief_description_of_the_form' | translate"></textarea>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>{{ 'ocr-template-builder.category' | translate }}</label>
              <select formControlName="category">
                <option value="ocr-generated">{{ 'ocr-template-builder.ocr_generated' | translate }}</option>
                <option value="patient">{{ 'ocr-template-builder.patient_forms' | translate }}</option>
                <option value="clinical">{{ 'ocr-template-builder.clinical_forms' | translate }}</option>
                <option value="administrative">{{ 'ocr-template-builder.administrative' | translate }}</option>
              </select>
            </div>
            <div class="form-field">
              <label>{{ 'ocr-template-builder.version' | translate }}</label>
              <input type="text" formControlName="version" placeholder="1.0">
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Processing View -->
    <div class="processing-view" *ngIf="viewMode === 'processing'">
      <div class="processing-content">
        <mat-spinner diameter="60"></mat-spinner>
        <h3>{{ 'ocr-template-builder.processing_document_with' | translate }} {{ ocrService ? ocrService.getProviderName() : 'OCR' }}</h3>
        <p>{{ 'ocr-template-builder.analyzing_form_structure_and_detecting_fields' | translate }}</p>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="processingProgress"></div>
        </div>
        <p class="progress-text">{{ processingProgress }}% {{ 'ocr-template-builder.complete' | translate }}</p>
      </div>
    </div>

    <!-- Review View -->
    <div class="review-view" *ngIf="viewMode === 'review'">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button mat-button="" [class.active]="activeTab === 'template'" (click)="switchTab('template')">
          <mat-icon>dashboard</mat-icon>
          Template Builder
        </button>
        <button mat-button="" [class.active]="activeTab === 'raw'" (click)="switchTab('raw')">
          <mat-icon>text_fields</mat-icon>
          Raw OCR Results
        </button>
      </div>

      <!-- Template Tab Content -->
      <div class="tab-content" *ngIf="activeTab === 'template'">
        <div class="review-toolbar">
          <div class="toolbar-left">
            <button mat-button="" (click)="toggleBoundingBoxes()">
              <mat-icon>{{ showBoundingBoxes ? 'visibility' : 'visibility_off' }}</mat-icon>{{ 'ocr-template-builder.bounding_boxes' | translate }}</button>
            <button mat-button="" (click)="toggleConfidenceScores()">
              <mat-icon>{{ 'ocr-template-builder.percent' | translate }}</mat-icon>{{ 'ocr-template-builder.confidence_scores' | translate }}</button>
          </div>
          <div class="toolbar-right">
            <button mat-raised-button="" color="primary" (click)="switchToFieldsView()">
              <mat-icon>edit</mat-icon>{{ 'ocr-template-builder.configure_fields' | translate }}</button>
          </div>
        </div>

        <div class="review-content">
          <div class="canvas-wrapper">
            <div class="canvas-container">
              <canvas #imageCanvas="" (click)="onCanvasClick($event)"></canvas>
            </div>
            
            <!-- Page navigation for multi-page PDFs -->
            <div class="page-navigation" *ngIf="totalPages > 1">
              <button mat-icon-button="" (click)="navigateToPage(currentPageIndex - 1)" [disabled]="currentPageIndex === 0">
                <mat-icon>{{ 'ocr-template-builder.chevronleft' | translate }}</mat-icon>
              </button>
              <span class="page-info">{{ 'ocr-template-builder.page' | translate }} {{ currentPageIndex + 1 }} {{ 'ocr-template-builder.of' | translate }} {{ totalPages }}</span>
              <button mat-icon-button="" (click)="navigateToPage(currentPageIndex + 1)" [disabled]="currentPageIndex === totalPages - 1">
                <mat-icon>{{ 'ocr-template-builder.chevronright' | translate }}</mat-icon>
              </button>
            </div>
          </div>

          <div class="element-details" *ngIf="selectedElement">
            <h4>{{ 'ocr-template-builder.selected_element' | translate }}</h4>
            <div class="detail-row">
              <label>{{ 'ocr-template-builder.type' | translate }}</label>
              <select [(ngModel)]="selectedElement.type" name="elementType">
                <option value="label">{{ 'ocr-template-builder.label' | translate }}</option>
                <option value="input">{{ 'ocr-template-builder.input_field' | translate }}</option>
                <option value="checkbox">{{ 'ocr-template-builder.checkbox' | translate }}</option>
                <option value="radio">{{ 'ocr-template-builder.radio_button' | translate }}</option>
                <option value="select">{{ 'ocr-template-builder.dropdown' | translate }}</option>
                <option value="text">{{ 'ocr-template-builder.text' | translate }}</option>
              </select>
            </div>
            <div class="detail-row">
              <label>{{ 'ocr-template-builder.text' | translate }}</label>
              <input type="text" [(ngModel)]="selectedElement.text" name="elementText">
            </div>
            <div class="detail-row">
              <label>{{ 'ocr-template-builder.confidence' | translate }}</label>
              <span>{{ selectedElement.confidence.toFixed(1) }}%</span>
            </div>
          </div>
        </div>

        <div class="ocr-stats">
          <div class="stat">
            <mat-icon>{{ 'ocr-template-builder.textfields' | translate }}</mat-icon>
            <span>{{ detectedElements.length }} {{ 'ocr-template-builder.elements_detected' | translate }}</span>
          </div>
          <div class="stat" *ngIf="ocrResult && ocrResult.tables && ocrResult.tables.length > 0">
            <i class="material-icons">{{ 'ocr-template-builder.tablechart' | translate }}</i>
            <span>{{ ocrResult.tables.length }} {{ 'ocr-template-builder.tables_found' | translate }}</span>
          </div>
          <div class="stat" *ngIf="ocrResult && ocrResult.metadata">
            <i class="material-icons">{{ 'ocr-template-builder.timer' | translate }}</i>
            <span>{{ (ocrResult.metadata.processingTime / 1000).toFixed(1) }}s {{ 'ocr-template-builder.processing_time' | translate }}</span>
          </div>
        </div>
      </div>

      <!-- Raw OCR Tab Content -->
      <div class="tab-content raw-ocr-content" *ngIf="activeTab === 'raw'">
        <div class="raw-ocr-header">
          <h3>Raw OCR Results - Page {{ currentPageIndex + 1 }} of {{ totalPages }}</h3>
          <p class="subtitle">Extracted text and bounding box information from the current page</p>
        </div>

        <!-- Page navigation for multi-page PDFs -->
        <div class="page-navigation" *ngIf="totalPages > 1">
          <button mat-icon-button (click)="previousPage()" [disabled]="currentPageIndex === 0">
            <mat-icon>navigate_before</mat-icon>
          </button>
          <span>Page {{ currentPageIndex + 1 }} of {{ totalPages }}</span>
          <button mat-icon-button (click)="nextPage()" [disabled]="currentPageIndex === totalPages - 1">
            <mat-icon>navigate_next</mat-icon>
          </button>
        </div>

        <!-- Back Button and Controls -->
        <div class="raw-view-controls">
          <button mat-raised-button color="primary" (click)="switchTab('template')" class="back-button">
            <mat-icon>arrow_back</mat-icon>
            Back to Template Builder
          </button>
          <div class="zoom-controls">
            <button mat-icon-button (click)="zoomOutRaw()" matTooltip="Zoom Out">
              <mat-icon>zoom_out</mat-icon>
            </button>
            <span class="zoom-level">{{ (rawViewZoom * 100).toFixed(0) }}%</span>
            <button mat-icon-button (click)="zoomInRaw()" matTooltip="Zoom In">
              <mat-icon>zoom_in</mat-icon>
            </button>
            <button mat-button (click)="resetRawView()" matTooltip="Reset View">
              <mat-icon>refresh</mat-icon>
              Reset
            </button>
            <button mat-button (click)="fitToScreenRaw()" matTooltip="Fit to Screen">
              <mat-icon>fit_screen</mat-icon>
              Fit
            </button>
          </div>
          <mat-slide-toggle [(ngModel)]="showBoundingBoxes" name="showBoundingBoxes" (change)="updateRawCanvas()">
            Show Bounding Boxes
          </mat-slide-toggle>
          <mat-slide-toggle [(ngModel)]="showConfidenceScores" name="showConfidenceScores" (change)="updateRawCanvas()">
            Show Confidence Scores
          </mat-slide-toggle>
        </div>

        <!-- Raw OCR Canvas -->
        <div class="raw-canvas-container">
          <canvas #rawCanvas 
                  class="raw-ocr-canvas"
                  (mousedown)="onRawCanvasMouseDown($event)"
                  (mousemove)="onRawCanvasMouseMove($event)"
                  (mouseup)="onRawCanvasMouseUp($event)"
                  (wheel)="onRawCanvasWheel($event)"
                  style="width: 100%; height: 600px; border: 1px solid #e5e7eb; background: #f9fafb;">
          </canvas>
        </div>

        <!-- Raw Text Output -->
        <div class="raw-text-section">
          <h4>Extracted Text</h4>
          <div class="raw-text-content">
            <pre>{{ getCurrentPageRawText() }}</pre>
          </div>
        </div>

        <!-- Detected Elements Table -->
        <div class="elements-table-section">
          <h4>Detected Elements ({{ getCurrentPageElements().length }})</h4>
          <div class="table-container">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-gray-50">
                  <th class="px-4 py-2 text-left border-b">Text</th>
                  <th class="px-4 py-2 text-left border-b">Type</th>
                  <th class="px-4 py-2 text-left border-b">Confidence</th>
                  <th class="px-4 py-2 text-left border-b">Bounding Box</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let element of getCurrentPageElements()" class="hover:bg-gray-50">
                  <td class="px-4 py-2 border-b">{{ element.text }}</td>
                  <td class="px-4 py-2 border-b">
                    <span class="px-2 py-1 text-xs rounded" [ngClass]="{
                      'bg-green-100 text-green-800': element.type === 'label',
                      'bg-blue-100 text-blue-800': element.type === 'input',
                      'bg-purple-100 text-purple-800': element.type === 'select',
                      'bg-orange-100 text-orange-800': element.type === 'checkbox' || element.type === 'radio',
                      'bg-gray-100 text-gray-800': element.type === 'text'
                    }">{{ element.type }}</span>
                  </td>
                  <td class="px-4 py-2 border-b">
                    <span [class.text-red-600]="element.confidence < 80">
                      {{ element.confidence }}%
                    </span>
                  </td>
                  <td class="px-4 py-2 border-b text-xs text-gray-600">
                    L:{{ element.boundingBox.left }}, T:{{ element.boundingBox.top }}, W:{{ element.boundingBox.width }}, H:{{ element.boundingBox.height }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Fields View -->
    <div class="fields-view" *ngIf="viewMode === 'fields'">
      <div class="fields-toolbar">
        <button mat-button="" (click)="switchToReviewView()">
          <mat-icon>{{ 'ocr-template-builder.arrowback' | translate }}</mat-icon>{{ 'ocr-template-builder.back_to_ocr_review' | translate }}</button>
        <div class="field-count">
          {{ filteredFieldsCount }} {{ 'ocr-template-builder.fields_on_page' | translate }} {{ currentPageIndex + 1 }} {{ 'ocr-template-builder.of' | translate }} {{ totalPages || 1 }}
        </div>
      </div>

      <div class="fields-list" cdkDropList="" [cdkDropListData]="getVisibleFields()" (cdkDropListDropped)="onFieldDrop($event)">
        <div class="field-item" *ngFor="let field of getVisibleFields(); let i = index" cdkDrag="" [cdkDragData]="field">
          <div class="field-drag-handle" cdkDragHandle="">
            <mat-icon>{{ 'ocr-template-builder.dragindicator' | translate }}</mat-icon>
          </div>
          
          <div class="field-icon">
            <mat-icon>{{ getFieldTypeIcon(field.type) }}</mat-icon>
          </div>

          <div class="field-details">
            <div class="field-name">{{ field.label }}</div>
            <div class="field-info">
              <span class="field-type">{{ 'ocr-template-builder.field_type_' + field.type | translate }}</span>
              <span class="field-required" *ngIf="field.required">{{ 'ocr-template-builder.required' | translate }}</span>
            </div>
          </div>

          <div class="field-actions">
            <button mat-icon-button="" (click)="editField(field)" matTooltip="Edit Field">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button="" (click)="removeFieldItem(field)" matTooltip="Remove Field">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <div class="add-field-button">
        <button mat-stroked-button="" color="primary">
          <mat-icon>add</mat-icon>{{ 'ocr-template-builder.add_field_manually' | translate }}</button>
      </div>
      
      <!-- Field Edit Panel -->
      <div class="field-edit-panel" *ngIf="editingFieldIndex !== null">
        <h3>{{ 'ocr-template-builder.edit_field' | translate }}</h3>
        <form [formGroup]="fieldEditForm">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'ocr-template-builder.field_label' | translate }}</mat-label>
            <input matInput="" formControlName="label" [placeholder]="'ocr-template-builder.enter_field_label' | translate">
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>{{ 'ocr-template-builder.field_name' | translate }}</mat-label>
            <input matInput="" formControlName="name" [placeholder]="'ocr-template-builder.enter_field_name' | translate">
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>{{ 'ocr-template-builder.field_type' | translate }}</mat-label>
            <mat-select formControlName="type">
              <mat-option value="text">{{ 'ocr-template-builder.text' | translate }}</mat-option>
              <mat-option value="textarea">{{ 'ocr-template-builder.text_area' | translate }}</mat-option>
              <mat-option value="number">{{ 'ocr-template-builder.number' | translate }}</mat-option>
              <mat-option value="email">{{ 'ocr-template-builder.email' | translate }}</mat-option>
              <mat-option value="phone">{{ 'ocr-template-builder.phone' | translate }}</mat-option>
              <mat-option value="date">{{ 'common.date' | translate }}</mat-option>
              <mat-option value="time">{{ 'common.time' | translate }}</mat-option>
              <mat-option value="datetime">{{ 'ocr-template-builder.date_time' | translate }}</mat-option>
              <mat-option value="select">{{ 'ocr-template-builder.dropdown' | translate }}</mat-option>
              <mat-option value="multiselect">{{ 'ocr-template-builder.multiselect' | translate }}</mat-option>
              <mat-option value="checkbox">{{ 'ocr-template-builder.checkbox' | translate }}</mat-option>
              <mat-option value="radio">{{ 'ocr-template-builder.radio_button' | translate }}</mat-option>
              <mat-option value="boolean">{{ 'ocr-template-builder.yesno' | translate }}</mat-option>
            </mat-select>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>{{ 'ocr-template-builder.placeholder' | translate }}</mat-label>
            <input matInput="" formControlName="placeholder" [placeholder]="'ocr-template-builder.enter_placeholder_text' | translate">
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>{{ 'ocr-template-builder.help_text' | translate }}</mat-label>
            <input matInput="" formControlName="helpText" [placeholder]="'ocr-template-builder.enter_help_text' | translate">
          </mat-form-field>
          
          <div class="field-options">
            <mat-checkbox formControlName="required">{{ 'ocr-template-builder.required_field' | translate }}</mat-checkbox>
            <mat-checkbox formControlName="isPhiField">{{ 'ocr-template-builder.phi_field' | translate }}</mat-checkbox>
            <mat-checkbox formControlName="auditRequired">{{ 'ocr-template-builder.audit_required' | translate }}</mat-checkbox>
          </div>
          
          <div class="edit-actions">
            <button mat-button="" (click)="cancelFieldEdit()">{{ 'common.cancel' | translate }}</button>
            <button mat-raised-button="" color="primary" (click)="saveFieldEdit()" [disabled]="!fieldEditForm.valid">{{ 'ocr-template-builder.save_changes' | translate }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="modal-footer">
    <button mat-button (click)="cancel()">{{ 'common.cancel' | translate }}</button>
    
    <div class="footer-actions">
      <button mat-raised-button color="primary" *ngIf="viewMode === 'upload'" [disabled]="!selectedFile || !templateForm.valid" (click)="processWithOcr()">
        <mat-icon>{{ 'ocr-template-builder.scanner' | translate }}</mat-icon>{{ 'ocr-template-builder.process_with_ocr' | translate }}</button>

      <button mat-raised-button color="accent" *ngIf="viewMode === 'fields'" [disabled]="generatedFields.length === 0" (click)="saveTemplate()">
        <mat-icon>save</mat-icon>{{ 'ocr-template-builder.create_template' | translate }}</button>
    </div>
  </div>
</div>
</body></html>