<div class="reports-dashboard">
  <!-- Header Section -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1 class="dashboard-title">
        <i class="material-icons">assessment</i>
        {{ 'reportsDashboard.title' | translate }}
      </h1>
      <p class="dashboard-subtitle">{{ 'reportsDashboard.subtitle' | translate }}</p>
    </div>

    <div class="header-controls">
      <!-- Time Range Selector -->
      <div class="control-group">
        <label>{{ 'reportsDashboard.timeRange' | translate }}:</label>
        <select [(ngModel)]="selectedTimeRange" (change)="onTimeRangeChange()" class="time-range-select">
          <option value="7days">{{ 'reportsDashboard.last7Days' | translate }}</option>
          <option value="30days">{{ 'reportsDashboard.last30Days' | translate }}</option>
          <option value="90days">{{ 'reportsDashboard.last90Days' | translate }}</option>
          <option value="1year">{{ 'reportsDashboard.lastYear' | translate }}</option>
          <option value="all">{{ 'reportsDashboard.allTime' | translate }}</option>
        </select>
      </div>

      <!-- Study Filter -->
      <div class="control-group">
        <label>{{ 'reportsDashboard.study' | translate }}:</label>
        <select [(ngModel)]="selectedStudy" (change)="onStudyFilterChange()" class="study-filter">
          <option value="all">{{ 'reportsDashboard.allStudies' | translate }}</option>
          <option *ngFor="let study of availableStudies" [value]="study.id">
            {{ study.title }} ({{ study.protocolNumber }})
          </option>
        </select>
      </div>

      <!-- Export Button -->
      <button class="export-btn" [disabled]="isExporting" (click)="exportReport('pdf')">
        <i class="material-icons">download</i>
        {{ 'reportsDashboard.exportReport' | translate }}
      </button>

      <!-- Refresh Button -->
      <button class="refresh-btn" (click)="refreshData()">
        <i class="material-icons">refresh</i>
      </button>
    </div>
  </div>

  <!-- View Tabs -->
  <div class="view-tabs">
    <button 
      class="tab-btn" 
      [class.active]="selectedView === 'overview'"
      (click)="selectView('overview')">
      <i class="material-icons">dashboard</i>
      {{ 'reportsDashboard.overview' | translate }}
    </button>
    <button 
      class="tab-btn" 
      [class.active]="selectedView === 'enrollment'"
      (click)="selectView('enrollment')">
      <i class="material-icons">group_add</i>
      {{ 'reportsDashboard.enrollment' | translate }}
    </button>
    <button 
      class="tab-btn" 
      [class.active]="selectedView === 'data-quality'"
      (click)="selectView('data-quality')">
      <i class="material-icons">verified</i>
      {{ 'reportsDashboard.dataQuality' | translate }}
    </button>
    <button 
      class="tab-btn" 
      [class.active]="selectedView === 'compliance'"
      (click)="selectView('compliance')">
      <i class="material-icons">gavel</i>
      {{ 'reportsDashboard.compliance' | translate }}
    </button>
    <button 
      class="tab-btn" 
      [class.active]="selectedView === 'performance'"
      (click)="selectView('performance')">
      <i class="material-icons">speed</i>
      {{ 'reportsDashboard.performance' | translate }}
    </button>
    <button 
      class="tab-btn" 
      [class.active]="selectedView === 'user-activity'"
      (click)="selectView('user-activity')">
      <i class="material-icons">people</i>
      {{ 'reportsDashboard.userActivity' | translate }}
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>{{ 'reportsDashboard.loading' | translate }}</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading" class="dashboard-content">
    
    <!-- Overview View -->
    <div *ngIf="selectedView === 'overview'" class="view-content overview-view">
      
      <!-- Key Metrics Cards -->
      <div class="metrics-grid">
        <div class="metric-card primary">
          <div class="metric-icon">
            <i class="material-icons">science</i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ totalStudies }}</div>
            <div class="metric-label">{{ 'reportsDashboard.totalStudies' | translate }}</div>
            <div class="metric-detail">{{ activeStudies }} {{ 'reportsDashboard.activeStudies' | translate }}</div>
          </div>
        </div>

        <div class="metric-card success">
          <div class="metric-icon">
            <i class="material-icons">people</i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ totalPatients }}</div>
            <div class="metric-label">{{ 'reportsDashboard.totalPatients' | translate }}</div>
            <div class="metric-detail">{{ totalEnrollment }} {{ 'reportsDashboard.enrolledPatients' | translate }}</div>
          </div>
        </div>

        <div class="metric-card info">
          <div class="metric-icon">
            <i class="material-icons">assignment</i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ completedForms }}/{{ totalForms }}</div>
            <div class="metric-label">{{ 'reportsDashboard.completedVisits' | translate }}</div>
            <div class="metric-detail">{{ ((completedForms/totalForms) * 100).toFixed(1) }}%</div>
          </div>
        </div>

        <div class="metric-card warning">
          <div class="metric-icon">
            <i class="material-icons">help_outline</i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ pendingQueries }}</div>
            <div class="metric-label">{{ 'reportsDashboard.openQueries' | translate }}</div>
            <div class="metric-detail">{{ resolvedQueries }} {{ 'reportsDashboard.resolvedQueries' | translate }}</div>
          </div>
        </div>
      </div>

      <!-- Study Performance Table -->
      <div class="section-card">
        <h2 class="section-title">
          <i class="material-icons">table_chart</i>
          {{ 'reportsDashboard.studyPerformanceSummary' | translate }}
        </h2>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>{{ 'reportsDashboard.study' | translate }}</th>
                <th>{{ 'reportsDashboard.protocol' | translate }}</th>
                <th>{{ 'reportsDashboard.phase' | translate }}</th>
                <th>{{ 'reportsDashboard.status' | translate }}</th>
                <th>{{ 'reportsDashboard.enrollment' | translate }}</th>
                <th>{{ 'reportsDashboard.completion' | translate }}</th>
                <th>{{ 'reportsDashboard.queries' | translate }}</th>
                <th>{{ 'reportsDashboard.deviations' | translate }}</th>
                <th>{{ 'reportsDashboard.lastActivity' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let metric of studyMetrics">
                <td class="study-name">{{ metric.studyName }}</td>
                <td>{{ metric.protocolNumber }}</td>
                <td>
                  <span class="phase-badge">{{ metric.phase }}</span>
                </td>
                <td>
                  <span class="status-badge" [style.background-color]="getStatusColor(metric.status)">
                    {{ metric.status }}
                  </span>
                </td>
                <td>
                  <div class="enrollment-cell">
                    <span>{{ metric.actualEnrollment }}/{{ metric.targetEnrollment }}</span>
                    <div class="progress-bar mini">
                      <div class="progress-fill" [style.width.%]="metric.enrollmentPercentage"></div>
                    </div>
                  </div>
                </td>
                <td>{{ metric.averageCompletionRate.toFixed(1) }}%</td>
                <td class="query-count">{{ metric.queriesOpen }}</td>
                <td class="deviation-count">{{ metric.protocolDeviations }}</td>
                <td>{{ metric.lastActivityDate ? formatDate(metric.lastActivityDate) : 'N/A' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="charts-row">
        <!-- Enrollment Trend Chart -->
        <div class="chart-card">
          <h3 class="chart-title">{{ 'reportsDashboard.enrollmentTrend' | translate }}</h3>
          <div class="chart-container">
            <canvas #enrollmentCanvas></canvas>
          </div>
        </div>

        <!-- Completion Rate Chart -->
        <div class="chart-card">
          <h3 class="chart-title">{{ 'reportsDashboard.studyCompletionRates' | translate }}</h3>
          <div class="chart-container">
            <canvas #completionCanvas></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Enrollment View -->
    <div *ngIf="selectedView === 'enrollment'" class="view-content enrollment-view">
      <!-- Enrollment Chart -->
      <div class="section-card">
        <h2 class="section-title">{{ 'reportsDashboard.enrollmentTrendAnalysis' | translate }}</h2>
        <div class="chart-container" style="height: 400px;">
          <canvas #enrollmentCanvas></canvas>
        </div>
      </div>

      <!-- Enrollment Statistics -->
      <div class="enrollment-stats">
        <div class="stat-card">
          <h3>{{ 'reportsDashboard.screening' | translate }}</h3>
          <div class="stat-value">{{ overallScreeningRate.toFixed(0) }}</div>
          <div class="stat-label">{{ 'reportsDashboard.patientsInScreening' | translate }}</div>
        </div>
        <div class="stat-card">
          <h3>{{ 'reportsDashboard.enrolled' | translate }}</h3>
          <div class="stat-value">{{ totalEnrollment }}</div>
          <div class="stat-label">{{ 'reportsDashboard.totalEnrolled' | translate }}</div>
        </div>
        <div class="stat-card">
          <h3>{{ 'reportsDashboard.screenFailures' | translate }}</h3>
          <div class="stat-value">
            {{ getTotalScreenFailures() }}
          </div>
          <div class="stat-label">{{ 'reportsDashboard.totalScreenFailures' | translate }}</div>
        </div>
        <div class="stat-card">
          <h3>Withdrawals</h3>
          <div class="stat-value">
            {{ getTotalWithdrawals() }}
          </div>
          <div class="stat-label">Total Withdrawals</div>
        </div>
      </div>

      <!-- Enrollment Funnel -->
      <div class="section-card">
        <h2 class="section-title">Enrollment Funnel</h2>
        <div class="funnel-chart">
          <div class="funnel-stage">
            <div class="funnel-bar screening">
              <span class="funnel-label">Screening</span>
              <span class="funnel-value">{{ totalPatients }}</span>
            </div>
          </div>
          <div class="funnel-stage">
            <div class="funnel-bar enrolled">
              <span class="funnel-label">Enrolled</span>
              <span class="funnel-value">{{ totalEnrollment }}</span>
            </div>
          </div>
          <div class="funnel-stage">
            <div class="funnel-bar active">
              <span class="funnel-label">Active</span>
              <span class="funnel-value">
                {{ getTotalActivePatients() }}
              </span>
            </div>
          </div>
          <div class="funnel-stage">
            <div class="funnel-bar completed">
              <span class="funnel-label">Completed</span>
              <span class="funnel-value">
                {{ getTotalCompletedPatients() }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Enrollment Projection -->
      <div class="section-card">
        <h2 class="section-title">Enrollment Projection</h2>
        <div class="projection-chart">
          <div class="projection-grid">
            <div *ngFor="let proj of enrollmentProjection" class="projection-point">
              <div class="projection-bar" [style.height.px]="(proj.projected / 10)">
                <span class="projection-value">{{ proj.projected }}</span>
              </div>
              <span class="projection-date">{{ formatDate(proj.date) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Quality View -->
    <div *ngIf="selectedView === 'data-quality'" class="view-content data-quality-view">
      <!-- Data Quality Radar Chart -->
      <div class="section-card">
        <h2 class="section-title">Data Quality Analysis</h2>
        <div class="chart-container" style="height: 400px;">
          <canvas #dataQualityCanvas></canvas>
        </div>
      </div>

      <!-- Quality Score Overview -->
      <div class="quality-overview">
        <div class="quality-score-card">
          <div class="score-circle">
            <svg viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" fill="none" stroke="#e0e0e0" stroke-width="10"/>
              <circle cx="50" cy="50" r="45" fill="none" stroke="#4CAF50" stroke-width="10"
                      [style.stroke-dasharray]="'283 283'"
                      [style.stroke-dashoffset]="283 - (283 * dataQualityMetrics.completenessRate / 100)"/>
            </svg>
            <div class="score-value">{{ dataQualityMetrics.completenessRate.toFixed(0) }}%</div>
          </div>
          <h3>Overall Data Quality</h3>
        </div>

        <div class="quality-breakdown">
          <h3>Quality Dimensions</h3>
          <div class="dimension-list">
            <div class="dimension-item">
              <span class="dimension-name">Completeness</span>
              <span class="dimension-value">{{ dataQualityMetrics.completenessRate.toFixed(1) }}%</span>
            </div>
            <div class="dimension-item">
              <span class="dimension-name">Accuracy</span>
              <span class="dimension-value">{{ dataQualityMetrics.accuracyRate.toFixed(1) }}%</span>
            </div>
            <div class="dimension-item">
              <span class="dimension-name">Consistency</span>
              <span class="dimension-value">{{ dataQualityMetrics.consistencyRate.toFixed(1) }}%</span>
            </div>
            <div class="dimension-item">
              <span class="dimension-name">Timeliness</span>
              <span class="dimension-value">{{ dataQualityMetrics.timelinesRate.toFixed(1) }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Query Chart -->
      <div class="section-card">
        <h2 class="section-title">Query Status Overview</h2>
        <div class="chart-container" style="height: 350px;">
          <canvas #queryCanvas></canvas>
        </div>
      </div>

      <!-- Query Statistics -->
      <div class="section-card">
        <h2 class="section-title">Query Management</h2>
        <div class="query-stats">
          <div class="query-stat">
            <i class="material-icons">error_outline</i>
            <div class="query-info">
              <span class="query-value">{{ pendingQueries }}</span>
              <span class="query-label">Open Queries</span>
            </div>
          </div>
          <div class="query-stat">
            <i class="material-icons">check_circle</i>
            <div class="query-info">
              <span class="query-value">{{ resolvedQueries }}</span>
              <span class="query-label">Resolved</span>
            </div>
          </div>
          <div class="query-stat">
            <i class="material-icons">smart_toy</i>
            <div class="query-info">
              <span class="query-value">{{ dataQualityMetrics.autoQueryRate.toFixed(0) }}%</span>
              <span class="query-label">Auto-Generated</span>
            </div>
          </div>
          <div class="query-stat">
            <i class="material-icons">person</i>
            <div class="query-info">
              <span class="query-value">{{ dataQualityMetrics.manualQueryRate.toFixed(0) }}%</span>
              <span class="query-label">Manual</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Completion Analysis -->
      <div class="section-card">
        <h2 class="section-title">Form Completion Analysis</h2>
        <div class="form-analysis">
          <table class="data-table">
            <thead>
              <tr>
                <th>Form Name</th>
                <th>Total</th>
                <th>Completed</th>
                <th>In Progress</th>
                <th>Avg. Time (min)</th>
                <th>Error Rate</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let form of formMetrics.slice(0, 10)">
                <td>{{ form.formName }}</td>
                <td>{{ form.totalInstances }}</td>
                <td>{{ form.completedInstances }}</td>
                <td>{{ form.inProgressInstances }}</td>
                <td>{{ form.averageCompletionTime.toFixed(1) }}</td>
                <td>{{ form.errorRate.toFixed(1) }}%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Compliance View -->
    <div *ngIf="selectedView === 'compliance'" class="view-content compliance-view">
      <div class="compliance-grid">
        <div class="compliance-card">
          <div class="compliance-header">
            <i class="material-icons">rule</i>
            <h3>Protocol Adherence</h3>
          </div>
          <div class="compliance-score">
            <div class="score-bar">
              <div class="score-fill" [style.width.%]="complianceMetrics.protocolAdherence"></div>
            </div>
            <span class="score-text">{{ complianceMetrics.protocolAdherence.toFixed(1) }}%</span>
          </div>
        </div>

        <div class="compliance-card">
          <div class="compliance-header">
            <i class="material-icons">verified_user</i>
            <h3>Consent Compliance</h3>
          </div>
          <div class="compliance-score">
            <div class="score-bar">
              <div class="score-fill" [style.width.%]="complianceMetrics.consentCompliance"></div>
            </div>
            <span class="score-text">{{ complianceMetrics.consentCompliance.toFixed(1) }}%</span>
          </div>
        </div>

        <div class="compliance-card">
          <div class="compliance-header">
            <i class="material-icons">lock</i>
            <h3>Data Privacy</h3>
          </div>
          <div class="compliance-score">
            <div class="score-bar">
              <div class="score-fill" [style.width.%]="complianceMetrics.dataPrivacyCompliance"></div>
            </div>
            <span class="score-text">{{ complianceMetrics.dataPrivacyCompliance.toFixed(1) }}%</span>
          </div>
        </div>

        <div class="compliance-card">
          <div class="compliance-header">
            <i class="material-icons">fact_check</i>
            <h3>Audit Readiness</h3>
          </div>
          <div class="compliance-score">
            <div class="score-bar">
              <div class="score-fill" [style.width.%]="complianceMetrics.auditReadiness"></div>
            </div>
            <span class="score-text">{{ complianceMetrics.auditReadiness.toFixed(1) }}%</span>
          </div>
        </div>

        <div class="compliance-card">
          <div class="compliance-header">
            <i class="material-icons">draw</i>
            <h3>E-Signatures</h3>
          </div>
          <div class="compliance-score">
            <div class="score-bar">
              <div class="score-fill" [style.width.%]="complianceMetrics.signatureCompliance"></div>
            </div>
            <span class="score-text">{{ complianceMetrics.signatureCompliance.toFixed(1) }}%</span>
          </div>
        </div>

        <div class="compliance-card">
          <div class="compliance-header">
            <i class="material-icons">source</i>
            <h3>Source Documents</h3>
          </div>
          <div class="compliance-score">
            <div class="score-bar">
              <div class="score-fill" [style.width.%]="complianceMetrics.sourceDocumentVerification"></div>
            </div>
            <span class="score-text">{{ complianceMetrics.sourceDocumentVerification.toFixed(1) }}%</span>
          </div>
        </div>
      </div>

      <!-- Compliance Alerts -->
      <div class="section-card">
        <h2 class="section-title">Compliance Alerts</h2>
        <div class="alerts-list">
          <div class="alert-item warning">
            <i class="material-icons">warning</i>
            <div class="alert-content">
              <span class="alert-title">Consent Expiring</span>
              <span class="alert-desc">3 patients have consents expiring within 30 days</span>
            </div>
          </div>
          <div class="alert-item info">
            <i class="material-icons">info</i>
            <div class="alert-content">
              <span class="alert-title">Audit Trail Review</span>
              <span class="alert-desc">Monthly audit trail review due in 5 days</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Performance View -->
    <div *ngIf="selectedView === 'performance'" class="view-content performance-view">
      <div class="performance-metrics">
        <div class="perf-card">
          <h3>Avg. Time to Enroll</h3>
          <div class="perf-value">{{ averageTimeToEnroll }} days</div>
        </div>
        <div class="perf-card">
          <h3>Avg. Time to Complete</h3>
          <div class="perf-value">{{ averageTimeToComplete }} days</div>
        </div>
        <div class="perf-card">
          <h3>Query Resolution Time</h3>
          <div class="perf-value">{{ averageQueryResolutionTime }} hours</div>
        </div>
        <div class="perf-card">
          <h3>Data Entry Lag</h3>
          <div class="perf-value">{{ dataEntryLag }} hours</div>
        </div>
      </div>

      <!-- Site Performance Chart -->
      <div class="section-card">
        <h2 class="section-title">Site Performance</h2>
        <div class="chart-container" style="height: 400px;">
          <canvas #sitePerformanceCanvas></canvas>
        </div>
      </div>
    </div>

    <!-- User Activity View -->
    <div *ngIf="selectedView === 'user-activity'" class="view-content user-activity-view">
      <div class="activity-summary">
        <div class="activity-card">
          <i class="material-icons">people</i>
          <div class="activity-info">
            <span class="activity-value">{{ activeUsers }}</span>
            <span class="activity-label">Active Users</span>
          </div>
        </div>
        <div class="activity-card">
          <i class="material-icons">login</i>
          <div class="activity-info">
            <span class="activity-value">{{ totalLogins }}</span>
            <span class="activity-label">Total Logins</span>
          </div>
        </div>
      </div>

      <!-- User Activity Chart -->
      <div class="section-card">
        <h2 class="section-title">User Activity Trend</h2>
        <div class="chart-container" style="height: 300px;">
          <canvas #userActivityCanvas></canvas>
        </div>
      </div>

      <!-- User Activity Table -->
      <div class="section-card">
        <h2 class="section-title">User Activity Details</h2>
        <table class="data-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Role</th>
              <th>Last Login</th>
              <th>Forms Completed</th>
              <th>Weekly Activity</th>
              <th>Avg. Time/Form</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of userActivityMetrics.slice(0, 20)">
              <td>{{ user.userName }}</td>
              <td>{{ user.role }}</td>
              <td>{{ formatDate(user.lastLogin) }}</td>
              <td>{{ user.formsCompleted }}</td>
              <td>{{ user.dataEntriesThisWeek }}</td>
              <td>{{ user.averageTimePerForm }} min</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

