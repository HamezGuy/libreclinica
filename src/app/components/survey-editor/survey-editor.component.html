<div class="survey-editor-overlay">
  <div class="survey-editor">
    <!-- Header -->
    <div class="editor-header">
      <h2>
        <i class="fas fa-poll"></i>
        {{ survey ? 'Edit Survey' : 'Create Survey' }}
      </h2>
      <button class="close-btn" (click)="onCancel()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="step" 
           *ngFor="let step of [1, 2, 3, 4]; let i = index"
           [class.active]="currentStep === step"
           [class.completed]="currentStep > step"
           (click)="goToStep(step)">
        <div class="step-number">{{ step }}</div>
        <div class="step-label">
          {{ step === 1 ? 'Basic Info' : 
             step === 2 ? 'Questions' : 
             step === 3 ? 'Settings' : 
             'Review' }}
        </div>
      </div>
    </div>
    
    <!-- Form Content -->
    <form [formGroup]="surveyForm" class="editor-content">
      <!-- Step 1: Basic Information -->
      <div class="step-content" *ngIf="currentStep === 1">
        <h3>Basic Information</h3>
        
        <div class="form-group">
          <label>Survey Title <span class="required">*</span></label>
          <input type="text" 
                 formControlName="title" 
                 class="form-control"
                 placeholder="Enter survey title">
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea formControlName="description" 
                    class="form-control"
                    rows="3"
                    placeholder="Describe the purpose of this survey"></textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Survey Type <span class="required">*</span></label>
            <select formControlName="type" class="form-control">
              <option value="feedback">Feedback</option>
              <option value="satisfaction">Satisfaction</option>
              <option value="nps">NPS</option>
              <option value="research">Research</option>
              <option value="screening">Screening</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Status</label>
            <select formControlName="status" class="form-control">
              <option value="draft">Draft</option>
              <option value="active">Active</option>
              <option value="paused">Paused</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Step 2: Questions -->
      <div class="step-content" *ngIf="currentStep === 2">
        <div class="step-header">
          <h3>Survey Questions</h3>
          <button type="button" class="btn btn-primary" (click)="addQuestion()">
            <i class="fas fa-plus"></i>
            Add Question
          </button>
        </div>
        
        <div class="questions-list" formArrayName="questions">
          <div class="question-card" 
               *ngFor="let question of questions.controls; let i = index"
               [formGroupName]="i">
            
            <div class="question-header">
              <div class="question-number">Q{{ i + 1 }}</div>
              <div class="question-actions">
                <button type="button" 
                        class="btn-icon"
                        (click)="moveQuestion(i, 'up')"
                        [disabled]="i === 0">
                  <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" 
                        class="btn-icon"
                        (click)="moveQuestion(i, 'down')"
                        [disabled]="i === questions.length - 1">
                  <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" 
                        class="btn-icon btn-danger"
                        (click)="removeQuestion(i)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            
            <div class="form-group">
              <label>Question Type</label>
              <select formControlName="type" class="form-control">
                <option *ngFor="let type of questionTypes" [value]="type.value">
                  {{ type.label }}
                </option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Question Text <span class="required">*</span></label>
              <input type="text" 
                     formControlName="text" 
                     class="form-control"
                     placeholder="Enter your question">
            </div>
            
            <div class="form-group">
              <label>Description (optional)</label>
              <input type="text" 
                     formControlName="description" 
                     class="form-control"
                     placeholder="Add helpful context">
            </div>
            
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="required">
                Required question
              </label>
            </div>
            
            <!-- Options for choice questions -->
            <div class="options-section" *ngIf="needsOptions(question.get('type')!.value)">
              <label>Answer Options</label>
              <div class="options-list">
                <div class="option-item" 
                     *ngFor="let option of question.get('options')!.value; let j = index">
                  <input type="text" 
                         class="form-control"
                         [value]="option.label"
                         (input)="updateOption(i, j, 'label', $any($event.target).value)"
                         placeholder="Option text">
                  <button type="button" 
                          class="btn-icon btn-danger"
                          (click)="removeOption(i, j)">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <button type="button" 
                      class="btn btn-sm btn-secondary"
                      (click)="addOption(i)">
                <i class="fas fa-plus"></i>
                Add Option
              </button>
            </div>
            
            <!-- Rating settings -->
            <div class="form-group" 
                 *ngIf="needsRatingSettings(question.get('type')!.value)"
                 formGroupName="settings">
              <label>Maximum Rating</label>
              <input type="number" 
                     formControlName="ratingMax" 
                     class="form-control"
                     min="3" 
                     max="10">
            </div>
            
            <!-- Scale settings -->
            <div class="scale-settings" 
                 *ngIf="needsScaleSettings(question.get('type')!.value)"
                 formGroupName="settings">
              <div class="form-row">
                <div class="form-group">
                  <label>Scale Min</label>
                  <input type="number" 
                         formControlName="scaleMin" 
                         class="form-control">
                </div>
                <div class="form-group">
                  <label>Scale Max</label>
                  <input type="number" 
                         formControlName="scaleMax" 
                         class="form-control">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Min Label</label>
                  <input type="text" 
                         formControlName="scaleMinLabel" 
                         class="form-control"
                         placeholder="e.g., Strongly Disagree">
                </div>
                <div class="form-group">
                  <label>Max Label</label>
                  <input type="text" 
                         formControlName="scaleMaxLabel" 
                         class="form-control"
                         placeholder="e.g., Strongly Agree">
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="empty-state" *ngIf="questions.length === 0">
          <i class="fas fa-question-circle"></i>
          <p>No questions added yet</p>
          <button type="button" class="btn btn-primary" (click)="addQuestion()">
            Add First Question
          </button>
        </div>
      </div>
      
      <!-- Step 3: Settings -->
      <div class="step-content" *ngIf="currentStep === 3">
        <h3>Survey Settings</h3>
        
        <!-- Response Settings -->
        <div class="settings-section">
          <h4>Response Settings</h4>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="isAnonymous">
              Allow anonymous responses
            </label>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="requiresAuth">
              Require authentication
            </label>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="allowMultipleResponses">
              Allow multiple responses per user
            </label>
          </div>
          <div class="form-group" *ngIf="surveyForm.get('allowMultipleResponses')!.value">
            <label>Max responses per user</label>
            <input type="number" 
                   formControlName="maxResponsesPerUser" 
                   class="form-control"
                   min="1">
          </div>
        </div>
        
        <!-- Display Settings -->
        <div class="settings-section">
          <h4>Display Settings</h4>
          <div class="form-group">
            <label>Display Mode</label>
            <select formControlName="displayMode" class="form-control">
              <option value="popup">Popup</option>
              <option value="embedded">Embedded</option>
              <option value="fullscreen">Fullscreen</option>
              <option value="slide_in">Slide In</option>
            </select>
          </div>
          
          <div formGroupName="welcomeScreen">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="enabled">
              Show welcome screen
            </label>
            <div class="nested-fields" *ngIf="surveyForm.get('welcomeScreen.enabled')!.value">
              <div class="form-group">
                <label>Welcome Title</label>
                <input type="text" formControlName="title" class="form-control">
              </div>
              <div class="form-group">
                <label>Welcome Message</label>
                <textarea formControlName="message" 
                          class="form-control"
                          rows="3"></textarea>
              </div>
            </div>
          </div>
          
          <div formGroupName="thankYouScreen">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="enabled">
              Show thank you screen
            </label>
            <div class="nested-fields" *ngIf="surveyForm.get('thankYouScreen.enabled')!.value">
              <div class="form-group">
                <label>Thank You Title</label>
                <input type="text" formControlName="title" class="form-control">
              </div>
              <div class="form-group">
                <label>Thank You Message</label>
                <textarea formControlName="message" 
                          class="form-control"
                          rows="3"></textarea>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Scheduling -->
        <div class="settings-section">
          <h4>Scheduling</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Start Date</label>
              <input type="datetime-local" 
                     formControlName="scheduledStartDate" 
                     class="form-control">
            </div>
            <div class="form-group">
              <label>End Date</label>
              <input type="datetime-local" 
                     formControlName="scheduledEndDate" 
                     class="form-control">
            </div>
          </div>
        </div>
        
        <!-- Triggers -->
        <div class="settings-section">
          <h4>Triggers</h4>
          <div formArrayName="triggers">
            <div class="trigger-item" 
                 *ngFor="let trigger of triggers.controls; let i = index"
                 [formGroupName]="i">
              <select formControlName="type" class="form-control">
                <option value="page_view">Page View</option>
                <option value="time_on_page">Time on Page</option>
                <option value="scroll_percentage">Scroll Percentage</option>
                <option value="exit_intent">Exit Intent</option>
                <option value="custom_event">Custom Event</option>
              </select>
              <input type="text" 
                     formControlName="value" 
                     class="form-control"
                     placeholder="Trigger value">
              <input type="number" 
                     formControlName="delay" 
                     class="form-control"
                     placeholder="Delay (seconds)"
                     min="0">
              <button type="button" 
                      class="btn-icon btn-danger"
                      (click)="removeTrigger(i)">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <button type="button" 
                  class="btn btn-sm btn-secondary"
                  (click)="addTrigger()">
            <i class="fas fa-plus"></i>
            Add Trigger
          </button>
        </div>
      </div>
      
      <!-- Step 4: Review -->
      <div class="step-content" *ngIf="currentStep === 4">
        <h3>Review Survey</h3>
        
        <div class="review-section">
          <h4>Basic Information</h4>
          <div class="review-item">
            <span class="label">Title:</span>
            <span class="value">{{ surveyForm.get('title')!.value }}</span>
          </div>
          <div class="review-item" *ngIf="surveyForm.get('description')!.value">
            <span class="label">Description:</span>
            <span class="value">{{ surveyForm.get('description')!.value }}</span>
          </div>
          <div class="review-item">
            <span class="label">Type:</span>
            <span class="value">{{ getSurveyTypeLabel(surveyForm.get('type')!.value) }}</span>
          </div>
          <div class="review-item">
            <span class="label">Status:</span>
            <span class="value badge" 
                  [class.badge-success]="surveyForm.get('status')!.value === 'active'"
                  [class.badge-warning]="surveyForm.get('status')!.value === 'paused'"
                  [class.badge-secondary]="surveyForm.get('status')!.value === 'draft'">
              {{ surveyForm.get('status')!.value }}
            </span>
          </div>
        </div>
        
        <div class="review-section">
          <h4>Questions ({{ questions.length }})</h4>
          <div class="review-questions">
            <div class="review-question" *ngFor="let question of questions.controls; let i = index">
              <div class="question-preview">
                <span class="q-number">Q{{ i + 1 }}.</span>
                <span class="q-text">{{ question.get('text')!.value }}</span>
                <span class="q-type">({{ question.get('type')!.value }})</span>
                <span class="required-badge" *ngIf="question.get('required')!.value">Required</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="review-section">
          <h4>Settings Summary</h4>
          <div class="settings-summary">
            <div class="summary-item">
              <i class="fas fa-user-secret"></i>
              {{ surveyForm.get('isAnonymous')!.value ? 'Anonymous' : 'Identified' }} responses
            </div>
            <div class="summary-item">
              <i class="fas fa-lock"></i>
              {{ surveyForm.get('requiresAuth')!.value ? 'Authentication required' : 'No authentication' }}
            </div>
            <div class="summary-item">
              <i class="fas fa-redo"></i>
              {{ surveyForm.get('allowMultipleResponses')!.value ? 'Multiple responses allowed' : 'Single response only' }}
            </div>
            <div class="summary-item">
              <i class="fas fa-desktop"></i>
              {{ getDisplayModeLabel(surveyForm.get('displayMode')!.value) }} display
            </div>
          </div>
        </div>
      </div>
    </form>
    
    <!-- Footer -->
    <div class="editor-footer">
      <button type="button" 
              class="btn btn-secondary"
              (click)="previousStep()"
              *ngIf="currentStep > 1">
        <i class="fas fa-arrow-left"></i>
        Previous
      </button>
      
      <div class="spacer"></div>
      
      <button type="button" 
              class="btn btn-secondary"
              (click)="onCancel()">
        Cancel
      </button>
      
      <button type="button" 
              class="btn btn-primary"
              (click)="nextStep()"
              *ngIf="currentStep < totalSteps">
        Next
        <i class="fas fa-arrow-right"></i>
      </button>
      
      <button type="button" 
              class="btn btn-primary"
              (click)="saveSurvey()"
              [disabled]="!surveyForm.valid || isSaving"
              *ngIf="currentStep === totalSteps">
        <i class="fas fa-save"></i>
        {{ isSaving ? 'Saving...' : (survey ? 'Update Survey' : 'Create Survey') }}
      </button>
    </div>
  </div>
</div>
