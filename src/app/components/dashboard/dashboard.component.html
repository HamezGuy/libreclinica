<!-- EDC Dashboard with Three-Panel Layout --><html><head></head><body><div class="edc-dashboard" *ngIf="userProfile$ | async as userProfile">
  
  <!-- Top Navigation Bar -->
  <header class="top-bar">
    <div class="top-bar-left">
      <h1 class="app-title">
        <i class="material-icons">medical_services</i>
        {{ 'dashboard.title' | translate }} - EDC System
      </h1>
    </div>
    
    <div class="top-bar-center">
      <div class="search-container">
        <i class="material-icons">search</i>
        <input type="text" [placeholder]="'common.search' | translate" [(ngModel)]="searchQuery" class="search-input">
      </div>
    </div>
    
    <div class="top-bar-right">
      <!-- Language Selector -->
      <app-language-selector></app-language-selector>
      
      <!-- Form Template Actions -->
      <div class="template-actions">
        <button class="btn btn-primary" (click)="openTemplateModal()" [disabled]="!permissions.canEdit &amp;&amp; !permissions.canView" [title]="(permissions.canEdit || permissions.canView) ? 'Manage Templates' : 'Insufficient permissions to manage templates'">
          <i class="material-icons">{{ 'common.description' | translate }}</i>
          {{ 'dashboard.templates' | translate }}
        </button>
        
        <button class="btn btn-success" (click)="createNewTemplate()" [disabled]="!permissions.canCreate" [title]="permissions.canCreate ? 'Create New Template' : 'Insufficient permissions to create templates'">
          <i class="material-icons">{{ 'common.add' | translate }}</i>
          {{ 'dashboard.createTemplate' | translate }}
        </button>

        <button class="btn btn-info" (click)="openOcrTemplateBuilder()" [disabled]="!permissions.canCreate" [title]="permissions.canCreate ? 'Create Template from Scanned Document' : 'Insufficient permissions to create templates'">
          <i class="material-icons">{{ 'dashboard.documentscanner' | translate }}</i>
          {{ 'dashboard.ocrTemplate' | translate }}
        </button>

        <button class="btn btn-warning" (click)="openExcelConversionDialog()" [disabled]="!permissions.canCreate" [title]="permissions.canCreate ? 'Import/Export Excel Templates' : 'Insufficient permissions to manage templates'">
          <i class="material-icons">table_chart</i>
          Excel Import/Export
        </button>
      </div>
      
      <!-- User Profile -->
      <div class="user-profile">
        <div class="profile-info" (click)="openProfileEditModal()" :title="'dashboard.edit_profile' | translate">
          <img [src]="userProfile.photoURL || '/assets/default-avatar.svg'" [alt]="userProfile.displayName" class="user-avatar">
          <div class="user-info">
            <span class="user-name">{{ userProfile.displayName }}</span>
            <span class="user-role">{{ userProfile.accessLevel }}</span>
          </div>
        </div>
        <button class="btn btn-link" (click)="signOut()" :title="'dashboard.sign_out' | translate">
          <i class="material-icons">logout</i>
        </button>
      </div>
    </div>
  </header>
  
  <!-- Horizontal Navigation Bar -->
  <nav class="horizontal-nav">
    <div class="nav-container">
      <ul class="nav-tabs">
        <li *ngFor="let item of sidebarItems" class="nav-tab" [class.active]="item.active" (click)="selectSidebarItem(item.id)">
          <i class="material-icons">{{ item.icon }}</i>
          <span>{{ item.label | translate }}</span>
        </li>
      </ul>
      
      <!-- Compliance Badges -->
      <div class="compliance-badges">
        <span class="badge hipaa">{{ 'dashboard.hipaa' | translate }}</span>
        <span class="badge cfr21">{{ 'dashboard.21_cfr_part_11' | translate }}</span>
        <span class="badge gdpr">{{ 'dashboard.gdpr' | translate }}</span>
        <span class="badge dpdp">{{ 'dashboard.dpdp_act' | translate }}</span>
      </div>
    </div>
  </nav>
  
  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Dashboard Sidebar Widget -->
    <app-dashboard-sidebar [activeSidebarItem]="activeSidebarItem" [studies]="(studies$ | async) || []" [patients]="patients" [permissions]="permissions" (activeSidebarItemChange)="selectSidebarItem($event)" (createTemplate)="createNewTemplate()" (createStudy)="createNewStudy()" (selectPatient)="selectPatientFromSidebar($event)" (deletePatient)="deletePatientFromStudy($event.patient, $event.studyId)" (viewPatientForms)="viewPatientForms($event)" (viewPatientHistory)="viewPatientHistory($event)">
    </app-dashboard-sidebar>
    
    <!-- Main Panel -->
    <main class="main-panel">
      
      <!-- Patients View -->
      <div class="content-section" *ngIf="activeSidebarItem === 'patients'">
        <!-- Show patient list if no patient selected -->
        <div *ngIf="!selectedPatient">
          <div class="section-header">
            <h2>{{ 'dashboard.patients' | translate }}</h2>
            <div class="section-actions">
              <button class="btn btn-primary" [disabled]="!permissions.canAddPatients" [title]="permissions.canAddPatients ? ('dashboard.add_new_patient' | translate) : ('dashboard.insufficient_permissions_to_add_patients' | translate)" (click)="openPatientTemplateSelector()">
                <i class="material-icons">person_add</i>
                {{ 'dashboard.add_patient' | translate }}
              </button>
            </div>
          </div>
          
          <!-- Patient List -->
          <div class="patient-list">
            <div class="list-header">
              <span>{{ 'dashboard.patient_id' | translate }}</span>
              <span>{{ 'common.name' | translate }}</span>
              <span>{{ 'dashboard.study' | translate }}</span>
              <span>{{ 'dashboard.forms' | translate }}</span>
              <span>{{ 'dashboard.last_visit' | translate }}</span>
              <span>{{ 'dashboard.status' | translate }}</span>
              <span>{{ 'dashboard.actions' | translate }}</span>
            </div>
            
            <div *ngFor="let patient of filteredPatients" class="patient-item" [class.selected]="selectedPatient?.id === patient.id" (click)="selectPatient(patient)">
              <span class="patient-id">{{ patient.identifier }}</span>
              <span class="patient-name">
                {{ patient.displayName }}
                <i class="material-icons phi-icon" *ngIf="!patient.canViewPhi" title="PHI Restricted">lock</i>
              </span>
              <span class="patient-study">{{ patient.studyId || 'N/A' }}</span>
              <span class="patient-forms">{{ patient.formsCount }}</span>
              <span class="patient-visit">{{ patient.lastVisit ? (patient.lastVisit | date:'short') : 'N/A' }}</span>
              <span class="patient-status">
                <span class="status-badge" [class]="patient.status">{{ patient.status }}</span>
              </span>
              <span class="patient-actions">
                <button class="btn btn-sm btn-link" [title]="'dashboard.view_details' | translate" (click)="selectPatient(patient)">
                  <i class="material-icons">visibility</i>
                </button>
                <button class="btn btn-sm btn-link" [title]="'common.edit' | translate">
                  <i class="material-icons">edit</i>
                </button>
              </span>
            </div>
            
            <div *ngIf="filteredPatients.length === 0" class="empty-state">
              <i class="material-icons">people_outline</i>
              <p>{{ 'dashboard.no_patients_found' | translate }}</p>
            </div>
          </div>
        </div>
        
        <!-- Patient Detail View (when patient is selected) -->
        <div *ngIf="selectedPatient" class="patient-detail-view">
          <!-- Patient Header -->
          <div class="patient-header">
            <button class="btn btn-link back-btn" (click)="clearSelectedPatient()">
              <i class="material-icons">arrow_back</i>
              Back to Patient List
            </button>
            <div class="patient-info">
              <h2>{{ selectedPatient.displayName }}</h2>
              <div class="patient-meta">
                <span class="meta-item">
                  <i class="material-icons">badge</i>
                  Patient ID: {{ selectedPatient.identifier }}
                </span>
                <span class="meta-item">
                  <i class="material-icons">science</i>
                  Study: {{ getStudyName(selectedPatient.studyId) || 'Not Enrolled' }}
                </span>
                <span class="meta-item">
                  <i class="material-icons">calendar_today</i>
                  Enrolled: {{ selectedPatient.enrollmentDate ? (selectedPatient.enrollmentDate | date:'mediumDate') : 'Not enrolled' }}
                </span>
                <span class="meta-item status-badge" [class]="selectedPatient.status">
                  {{ selectedPatient.status }}
                </span>
              </div>
            </div>
            <div class="patient-actions">
              <button class="btn btn-secondary">
                <i class="material-icons">edit</i>
                Edit Patient
              </button>
              <button class="btn btn-secondary">
                <i class="material-icons">print</i>
                Print Summary
              </button>
            </div>
          </div>
          
          <!-- Visit Timeline / Phases -->
          <div class="visit-timeline">
            <h3>Study Visits & Phases</h3>
            <div class="timeline-container">
              <div *ngFor="let phase of patientPhases; let i = index" class="phase-card" [class.completed]="phase.status === 'completed'" [class.current]="phase.status === 'in_progress'" [class.upcoming]="phase.status === 'scheduled'">
                <div class="phase-header">
                  <div class="phase-number">Phase {{ i + 1 }}</div>
                  <div class="phase-name">{{ phase.name }}</div>
                  <div class="phase-status">
                    <i class="material-icons">{{ getPhaseIcon(phase.status) }}</i>
                    {{ phase.status }}
                  </div>
                </div>
                
                <div class="phase-dates">
                  <div class="date-item" *ngIf="phase.scheduledDate">
                    <span class="date-label">Scheduled:</span>
                    <span class="date-value">{{ phase.scheduledDate | date:'shortDate' }}</span>
                  </div>
                  <div class="date-item" *ngIf="phase.completedDate">
                    <span class="date-label">Completed:</span>
                    <span class="date-value">{{ phase.completedDate | date:'shortDate' }}</span>
                  </div>
                </div>
                
                <div class="phase-forms">
                  <h4>Forms ({{ getCompletedFormsCount(phase) }}/{{ phase.formTemplates?.length || 0 }})</h4>
                  <div class="form-list">
                    <div *ngFor="let form of phase.formTemplates" class="form-item" [class.completed]="isFormCompleted(phase, form)" [class.required]="form.isRequired">
                      <i class="material-icons form-status">{{ isFormCompleted(phase, form) ? 'check_circle' : (form.isRequired ? 'radio_button_unchecked' : 'circle') }}</i>
                      <span class="form-name">{{ form.templateName }}</span>
                      <span class="form-badge" *ngIf="form.isRequired">Required</span>
                      <button class="btn btn-sm btn-link" (click)="openForm(phase, form)">
                        {{ isFormCompleted(phase, form) ? 'View' : 'Complete' }}
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="phase-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="phase.completionPercentage || 0"></div>
                  </div>
                  <span class="progress-text">{{ phase.completionPercentage || 0 }}% Complete</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Patient Data Summary -->
          <div class="patient-data-summary">
            <h3>Data Summary</h3>
            <div class="summary-grid">
              <div class="summary-card">
                <i class="material-icons">assignment</i>
                <div class="summary-content">
                  <div class="summary-value">{{ getTotalFormsCount() }}</div>
                  <div class="summary-label">Total Forms</div>
                </div>
              </div>
              <div class="summary-card">
                <i class="material-icons">check_circle</i>
                <div class="summary-content">
                  <div class="summary-value">{{ getCompletedFormsTotal() }}</div>
                  <div class="summary-label">Completed</div>
                </div>
              </div>
              <div class="summary-card">
                <i class="material-icons">pending</i>
                <div class="summary-content">
                  <div class="summary-value">{{ getPendingFormsTotal() }}</div>
                  <div class="summary-label">Pending</div>
                </div>
              </div>
              <div class="summary-card">
                <i class="material-icons">warning</i>
                <div class="summary-content">
                  <div class="summary-value">{{ getOverdueFormsTotal() }}</div>
                  <div class="summary-label">Overdue</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Forms View -->
      <div class="content-section" *ngIf="activeSidebarItem === 'forms'">
        <div class="section-header">
          <h2>{{ 'dashboard.form_templates' | translate }}</h2>
          <div class="section-actions">
            <!-- Temporary Fix Button -->
            <button class="btn btn-warning" (click)="fixTemplateIds()" [title]="'dashboard.fix_template_ids_onetime_migration' | translate">
              <i class="material-icons">build</i>
              {{ 'dashboard.fix_template_ids' | translate }}
            </button>
            
            <!-- Excel Import Button -->
            <button class="btn btn-secondary" (click)="openExcelImport()" [disabled]="!permissions.canCreate" [title]="'Import template from Excel'">
              <i class="material-icons">upload_file</i>
              Import Excel
            </button>
            
            <button class="btn btn-primary" (click)="createNewTemplate()" [disabled]="!permissions.canCreate" [title]="permissions.canCreate ? ('dashboard.create_new_template' | translate) : ('dashboard.insufficient_permissions_to_create_templates' | translate)">
              <i class="material-icons">add</i>
              {{ 'dashboard.create_template' | translate }}
            </button>
          </div>
        </div>
        
        <!-- Template List -->
        <div class="template-list">
          <div class="template-grid">
            <div *ngFor="let template of filteredTemplates" class="template-card" [class]="template.status">
              <div class="template-header">
                <h3>{{ template.name }}</h3>
                <span class="template-version">v{{ template.version }}</span>
              </div>
              
              <div class="template-body">
                <p class="template-description">{{ template.description }}</p>
                <div class="template-meta">
                  <span class="field-count">{{ template.fields.length }} fields</span>
                  <span class="template-status" [class]="template.status">{{ template.status }}</span>
                </div>
              </div>
              
              <div class="template-actions">
                <button class="btn btn-sm btn-info" (click)="testFormTemplate(template)" :title="'dashboard.test_form' | translate">
                  <i class="material-icons">science</i>
                </button>
                
                <button class="btn btn-sm btn-secondary" (click)="editTemplate(template)" *ngIf="permissions.canEdit" :title="'dashboard.edit_template' | translate">
                  <i class="material-icons">edit</i>
                </button>
                
                <button class="btn btn-sm btn-primary" (click)="exportTemplateToExcel(template)" :title="'Export to Excel'">
                  <i class="material-icons">download</i>
                </button>
                
                <button class="btn btn-sm btn-success" (click)="publishTemplate(template)" *ngIf="permissions.canPublish && template.status === 'draft'" :title="'dashboard.publish_template' | translate">
                  <i class="material-icons">publish</i>
                </button>
                
                <button class="btn btn-sm btn-danger" (click)="deleteTemplate(template)" *ngIf="permissions.canDelete" :title="'dashboard.delete_template' | translate">
                  <i class="material-icons">delete</i>
                </button>
              </div>
            </div>
          </div>
          
          <div *ngIf="(templates$ | async)?.length === 0" class="empty-state">
            <i class="material-icons">description</i>
            <p>{{ 'dashboard.no_form_templates_found' | translate }}</p>
            <button class="btn btn-primary" (click)="createNewTemplate()" *ngIf="permissions.canCreate">{{ 'dashboard.create_your_first_template' | translate }}</button>
          </div>
        </div>
      </div>
      
      <!-- Studies View -->
      <div class="content-section" *ngIf="activeSidebarItem === 'studies'">
        <div class="section-header">
          <h2>{{ 'dashboard.studies_management' | translate }}</h2>
          <div class="section-actions">
            <button class="btn btn-primary" (click)="createNewStudy()" [disabled]="!permissions.canCreate" [title]="permissions.canCreate ? ('dashboard.create_new_study' | translate) : ('dashboard.insufficient_permissions_to_create_studies' | translate)">
              <i class="material-icons">add</i>
              {{ 'dashboard.create_study' | translate }}
            </button>
          </div>
        </div>
        
        <!-- Studies Overview Cards -->
        <div class="overview-cards" *ngIf="studies.length > 0">
          <div class="overview-card">
            <div class="card-icon">
              <i class="material-icons">folder</i>
            </div>
            <div class="card-content">
              <h3>{{ studies.length }}</h3>
              <p>{{ 'dashboard.total_studies' | translate }}</p>
            </div>
          </div>
          
          <div class="overview-card">
            <div class="card-icon">
              <i class="material-icons">people</i>
            </div>
            <div class="card-content">
              <h3>{{ getTotalEnrollments() }}</h3>
              <p>{{ 'dashboard.total_enrollments' | translate }}</p>
            </div>
          </div>
          
          <div class="overview-card">
            <div class="card-icon">
              <i class="material-icons">warning</i>
            </div>
            <div class="card-content">
              <h3>{{ getTotalCareAlerts() }}</h3>
              <p>{{ 'dashboard.care_alerts' | translate }}</p>
            </div>
          </div>
          
          <div class="overview-card">
            <div class="card-icon">
              <i class="material-icons">play_circle</i>
            </div>
            <div class="card-content">
              <h3>{{ getActiveStudiesCount() }}</h3>
              <p>{{ 'dashboard.active_studies' | translate }}</p>
            </div>
          </div>
        </div>
        
        <!-- Studies Grid -->
        <div class="studies-list">
          <div class="studies-grid" *ngIf="filteredStudies.length > 0">
            <div *ngFor="let study of filteredStudies; trackBy: trackStudy" class="study-card" [class.selected]="selectedStudy?.id === study.id" (click)="selectStudy(study)">
              
              <div class="study-header">
                <h3>{{ study.title }}</h3>
                <div class="study-badges">
                  <span class="badge status" [class]="'status-' + study.status">{{ study.status }}</span>
                  <span class="badge phase" [class]="'phase-' + study.phase">{{ study.phase }}</span>
                </div>
              </div>
              
              <div class="study-body">
                <p class="study-description">{{ study.description }}</p>
                <div class="study-meta">
                  <div class="meta-item">
                    <i class="material-icons">confirmation_number</i>
                    <span>{{ study.protocolNumber }}</span>
                  </div>
                  <div class="meta-item">
                    <i class="material-icons">people</i>
                    <span>{{ study.actualEnrollment || 0 }}/{{ study.plannedEnrollment }} enrolled</span>
                  </div>
                  <div class="meta-item">
                    <i class="material-icons">timeline</i>
                    <span>{{ getStudyPhases(study).length }} phases</span>
                  </div>
                  <div class="meta-item" *ngIf="getCareIndicatorsForStudy(study.id || '').length > 0">
                    <i class="material-icons">warning</i>
                    <span>{{ getCareIndicatorsForStudy(study.id || '').length }} alerts</span>
                  </div>
                </div>
                
                <!-- Study Phase Progress Overview -->
                <div class="study-phases-overview" *ngIf="selectedStudy?.id === study.id">
                  <div class="phases-progress-bar">
                    <div *ngFor="let phase of getStudyPhases(study); let i = index" 
                         class="phase-segment" 
                         [class]="'phase-' + getPhaseStatus(study.id || '', phase)"
                         [style.width.%]="100 / getStudyPhases(study).length"
                         [title]="phase.phaseName + ': ' + getPhaseStatus(study.id || '', phase)">
                      <span class="phase-code">{{ phase.phaseCode }}</span>
                    </div>
                  </div>
                  <div class="overall-progress">
                    <span class="progress-text">{{ getStudyOverallProgress(study) }}% Complete</span>
                  </div>
                </div>
              </div>
              
              <div class="study-actions">
                <button class="btn btn-sm btn-secondary" (click)="editStudy(study); $event.stopPropagation()" *ngIf="permissions.canEdit" :title="'dashboard.edit_study' | translate">
                  <i class="material-icons">edit</i>
                </button>
                
                <button class="btn btn-sm btn-primary" (click)="enrollPatientInStudy(study); $event.stopPropagation()" *ngIf="permissions.canCreate" :title="'dashboard.enroll_patient' | translate">
                  <i class="material-icons">person_add</i>
                </button>
                
                <button class="btn btn-sm btn-danger" (click)="deleteStudy(study); $event.stopPropagation()" *ngIf="permissions.canDelete" :title="'dashboard.delete_study' | translate">
                  <i class="material-icons">delete</i>
                </button>
              </div>
              
              <!-- Care Indicators -->
              <div class="care-indicators" *ngIf="getCareIndicatorsForStudy(study.id || '').length > 0">
                <div *ngFor="let indicator of getCareIndicatorsForStudy(study.id || '')" class="care-indicator" [class]="'severity-' + indicator.severity">
                  <i class="material-icons">{{ getCareIndicatorIcon(indicator.type) }}</i>
                  <span>{{ indicator.description }}</span>
                  <button class="btn btn-xs btn-link" (click)="resolveCareIndicator(indicator); $event.stopPropagation()" :title="'dashboard.resolve' | translate">
                    <i class="material-icons">check</i>
                  </button>
                </div>
              </div>
              
              <!-- Enhanced Study Phase Management Panel -->
              <div class="enhanced-study-panel" *ngIf="selectedStudy?.id === study.id">
                <div class="study-tabs">
                  <button class="tab-button" [class.active]="studyViewTab === 'phases'" (click)="studyViewTab = 'phases'; $event.stopPropagation()">
                    <i class="material-icons">timeline</i>Study Phases</button>
                  <button class="tab-button" [class.active]="studyViewTab === 'patients'" (click)="studyViewTab = 'patients'; loadStudyPatients(study.id || ''); $event.stopPropagation()">
                    <i class="material-icons">people</i>Enrolled Patients ({{ study.actualEnrollment || 0 }})</button>
                  <button class="tab-button" [class.active]="studyViewTab === 'sites'" (click)="studyViewTab = 'sites'; $event.stopPropagation()">
                    <i class="material-icons">location_on</i>Sites</button>
                  <button class="tab-button" *ngIf="getActiveDataQueriesCount() > 0" [class.active]="studyViewTab === 'queries'" (click)="studyViewTab = 'queries'; $event.stopPropagation()">
                    <i class="material-icons">help</i>
                    Data Queries ({{ getActiveDataQueriesCount() }})
                  </button>
                </div>
                
                <!-- Study Phases View -->
                <div class="study-phases-detail" *ngIf="studyViewTab === 'phases'">
                  <div *ngFor="let phase of getStudyPhases(study); trackBy: trackPhase" class="phase-card">
                    
                    <div class="phase-header" (click)="togglePhaseExpansion(phase.id)">
                      <div class="phase-info">
                        <div class="phase-title">
                          <span class="phase-code-badge">{{ phase.phaseCode }}</span>
                          <h4>{{ phase.phaseName }}</h4>
                        </div>
                        <p class="phase-description" *ngIf="phase.description">{{ phase.description }}</p>
                      </div>
                      
                      <div class="phase-status-indicator">
                        <div class="phase-status" [class]="'status-' + getPhaseStatus(study.id || '', phase)">
                          <i class="material-icons">{{ getPhaseStatusIcon(study.id || '', phase) }}</i>
                          <span>{{ getPhaseStatusText(study.id || '', phase) }}</span>
                        </div>
                        <div class="phase-progress">
                          <div class="progress-ring">
                            <svg width="60" height="60">
                              <circle cx="30" cy="30" r="25" fill="none" stroke="#e0e0e0" stroke-width="4"></circle>
                              <circle cx="30" cy="30" r="25" fill="none" 
                                      [attr.stroke]="getPhaseProgressColor(study.id || '', phase)" 
                                      stroke-width="4"
                                      [attr.stroke-dasharray]="getPhaseProgressDasharray(study.id || '', phase)"
                                      [attr.stroke-dashoffset]="getPhaseProgressDashoffset(study.id || '', phase)"
                                      transform="rotate(-90 30 30)"></circle>
                            </svg>
                            <div class="progress-text">{{ getPhaseProgress(study.id || '', phase) }}%</div>
                          </div>
                        </div>
                        <button class="expand-button" [class.expanded]="isPhaseExpanded(phase.id)">
                          <i class="material-icons">{{ isPhaseExpanded(phase.id) ? 'expand_less' : 'expand_more' }}</i>
                        </button>
                      </div>
                    </div>
                    
                    <!-- Phase Details (Expandable) -->
                    <div class="phase-details" *ngIf="isPhaseExpanded(phase.id)">
                      <div class="phase-metadata">
                        <div class="meta-row">
                          <span class="meta-label">Duration:</span>
                          <span class="meta-value">{{ phase.plannedDurationDays || 'N/A' }} days</span>
                        </div>
                        <div class="meta-row">
                          <span class="meta-label">Window:</span>
                          <span class="meta-value">{{ phase.windowStartDays || 0 }} to {{ phase.windowEndDays || 0 }} days</span>
                        </div>
                        <div class="meta-row">
                          <span class="meta-label">Patients in Phase:</span>
                          <span class="meta-value">{{ getPatientsInPhase(study.id || '', phase.id).length }}</span>
                        </div>
                      </div>
                      
                      <!-- Phase Templates -->
                      <div class="phase-templates">
                        <h5>Associated Templates ({{ phase.templateAssignments?.length || 0 }})</h5>
                        <div class="template-list">
                          <div *ngFor="let assignment of phase.templateAssignments; trackBy: trackTemplateAssignment" 
                               class="template-item" 
                               [class.required]="assignment.isRequired">
                            <div class="template-info">
                              <i class="material-icons">{{ assignment.category === 'vitals' ? 'favorite' : assignment.category === 'labs' ? 'science' : 'assignment' }}</i>
                              <div class="template-details">
                                <span class="template-name">{{ assignment.templateName }}</span>
                                <span class="template-meta">
                                  <span class="badge" *ngIf="assignment.isRequired">Required</span>
                                  <span class="badge" *ngIf="!assignment.isRequired">Optional</span>
                                  <span class="due-text" *ngIf="assignment.dueAfterDays">
                                    Due {{ assignment.dueAfterDays }} days after phase start
                                  </span>
                                </span>
                              </div>
                            </div>
                            <div class="template-completion">
                              <span class="completion-stat">{{ getTemplateCompletionForPhase(study.id || '', phase.id, assignment.templateId) }}</span>
                            </div>
                          </div>
                        </div>
                        
                        <div class="no-templates" *ngIf="!phase.templateAssignments || phase.templateAssignments.length === 0">
                          <i class="material-icons">assignment_late</i>
                          <p>No templates assigned to this phase</p>
                          <button class="btn btn-sm btn-primary" (click)="assignTemplateToPhase(study.id || '', phase.id); $event.stopPropagation()" *ngIf="permissions.canEdit">
                            <i class="material-icons">add</i>Assign Templates
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Add Phase Button -->
                  <div class="add-phase-card" *ngIf="permissions.canEdit">
                    <button class="btn btn-primary" (click)="addPhaseToStudy(study.id || ''); $event.stopPropagation()">
                      <i class="material-icons">add_circle</i>Add New Phase
                    </button>
                  </div>
                </div>
                
                <!-- Enrolled Patients View -->
                <div class="study-patients-view" *ngIf="studyViewTab === 'patients'">
                  <div class="patients-grid" *ngIf="studyPatients && studyPatients.length > 0">
                    <div *ngFor="let patient of studyPatients; trackBy: trackPatient" class="patient-card">
                      <div class="patient-header">
                        <div class="patient-id">
                          <i class="material-icons">person</i>
                          <span class="patient-number">{{ patient.patientNumber }}</span>
                        </div>
                        <span class="enrollment-status" [class]="'status-' + patient.enrollmentStatus">
                          {{ patient.enrollmentStatus | titlecase }}
                        </span>
                      </div>
                      
                      <div class="patient-info">
                        <div class="info-row">
                          <span class="info-label">Enrolled:</span>
                          <span class="info-value">{{ formatDate(patient.enrollmentDate) }}</span>
                        </div>
                        <div class="info-row" *ngIf="patient.treatmentArm">
                          <span class="info-label">Treatment Arm:</span>
                          <span class="info-value">{{ patient.treatmentArm }}</span>
                        </div>
                        <div class="info-row" *ngIf="patient.siteId">
                          <span class="info-label">Site:</span>
                          <span class="info-value">{{ getSiteName(patient.siteId) }}</span>
                        </div>
                      </div>
                      
                      <div class="patient-phase-progress">
                        <span class="progress-label">Current Phase:</span>
                        <span class="current-phase">{{ getCurrentPatientPhase(patient) }}</span>
                        <div class="mini-progress-bar">
                          <div class="progress-fill" [style.width.%]="getPatientProgress(patient)"></div>
                        </div>
                      </div>
                      
                      <div class="patient-actions">
                        <button class="btn btn-xs btn-primary" (click)="viewPatientDetails(patient); $event.stopPropagation()">
                          <i class="material-icons">visibility</i>View
                        </button>
                        <button class="btn btn-xs btn-secondary" (click)="editPatientPhase(patient); $event.stopPropagation()" *ngIf="permissions.canEdit">
                          <i class="material-icons">edit</i>Edit Phase
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <div class="no-patients" *ngIf="!studyPatients || studyPatients.length === 0">
                    <i class="material-icons">person_outline</i>
                    <h4>No Patients Enrolled</h4>
                    <p>Start enrolling patients to begin the study</p>
                    <button class="btn btn-primary" (click)="enrollPatientInStudy(study); $event.stopPropagation()" *ngIf="permissions.canCreate">
                      <i class="material-icons">person_add</i>Enroll First Patient
                    </button>
                  </div>
                </div>
                
                <!-- Sites View -->
                <div class="study-sites-view" *ngIf="studyViewTab === 'sites'">
                  <div class="sites-grid" *ngIf="study.sites && study.sites.length > 0">
                    <div *ngFor="let site of study.sites; trackBy: trackSite" class="site-card">
                      <div class="site-header">
                        <h4>{{ site.siteName }}</h4>
                        <span class="site-number">Site #{{ site.siteNumber }}</span>
                      </div>
                      <div class="site-info">
                        <p><strong>PI:</strong> {{ site.principalInvestigator }}</p>
                        <p><strong>Location:</strong> {{ site.address.city }}, {{ site.address.country }}</p>
                        <p><strong>Enrollment:</strong> {{ site.actualEnrollment }}/{{ site.targetEnrollment }}</p>
                      </div>
                    </div>
                  </div>
                  <div class="no-sites" *ngIf="!study.sites || study.sites.length === 0">
                    <i class="material-icons">location_off</i>
                    <p>No sites configured for this study</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Empty State -->
          <div *ngIf="studies.length === 0" class="empty-state">
            <i class="material-icons">folder_open</i>
            <h3>{{ 'dashboard.no_studies_found' | translate }}</h3>
            <p>{{ 'dashboard.create_your_first_study_to_begin_managing_clinical' | translate }}</p>
            <button class="btn btn-primary" (click)="createNewStudy()" *ngIf="permissions.canCreate">
              <i class="material-icons">add</i>{{ 'dashboard.create_your_first_study' | translate }}</button>
          </div>
        </div>
      </div>
      
      <!-- Surveys View -->
      <div class="content-section" *ngIf="activeSidebarItem === 'surveys'">
        <app-survey-management></app-survey-management>
      </div>
      
      <!-- Audit Logs Section -->
      <div class="content-section audit-logs-section" *ngIf="activeSidebarItem === 'audit'">
        <div class="section-header">
          <h2>
            <i class="material-icons">history</i>
            {{ 'dashboard.audit' | translate }}
          </h2>
          <div class="header-actions">
            <input type="text" 
                   class="form-control search-input" 
                   [(ngModel)]="auditLogFilter" 
                   (ngModelChange)="filterAuditLogs()"
                   placeholder="Search audit logs...">
            <button class="btn btn-secondary" (click)="loadAuditLogs()">
              <i class="material-icons">refresh</i>
              Refresh
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div class="loading-container" *ngIf="loadingAuditLogs">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading audit logs...</p>
        </div>

        <!-- Audit Logs List -->
        <div class="audit-logs-container" *ngIf="!loadingAuditLogs">
          <!-- Summary Cards -->
          <div class="audit-summary-cards">
            <div class="summary-card">
              <div class="card-icon">
                <i class="material-icons">event_note</i>
              </div>
              <div class="card-content">
                <h3>{{ filteredAuditLogs.length }}</h3>
                <p>Total Events</p>
              </div>
            </div>
            <div class="summary-card">
              <div class="card-icon info">
                <i class="material-icons">info</i>
              </div>
              <div class="card-content">
                <h3>{{ getAuditLogCountBySeverity('INFO') }}</h3>
                <p>Info Events</p>
              </div>
            </div>
            <div class="summary-card">
              <div class="card-icon warning">
                <i class="material-icons">warning</i>
              </div>
              <div class="card-content">
                <h3>{{ getAuditLogCountBySeverity('WARNING') }}</h3>
                <p>Warnings</p>
              </div>
            </div>
            <div class="summary-card">
              <div class="card-icon error">
                <i class="material-icons">error</i>
              </div>
              <div class="card-content">
                <h3>{{ getAuditLogCountBySeverity('ERROR_CRITICAL') }}</h3>
                <p>Errors</p>
              </div>
            </div>
          </div>

          <!-- Audit Logs List -->
          <div class="audit-logs-list" *ngIf="filteredAuditLogs.length > 0">
            <div class="audit-log-item" 
                 *ngFor="let log of filteredAuditLogs; trackBy: trackAuditLog"
                 [class.expanded]="log.expanded"
                 [ngClass]="getAuditSeverityClass(log.severity)">
              
              <!-- Log Header (Always Visible) -->
              <div class="log-header" (click)="toggleAuditLogDetails(log)">
                <div class="log-icon">
                  <i class="material-icons">{{ getAuditActionIcon(log.action) }}</i>
                </div>
                
                <div class="log-main-info">
                  <div class="log-action">
                    <strong>{{ log.action }}</strong>
                    <span class="resource-type">{{ log.resourceType }}</span>
                  </div>
                  <div class="log-meta">
                    <span class="log-user">
                      <i class="material-icons">person</i>
                      {{ log.userId || 'Unknown User' }}
                    </span>
                    <span class="log-timestamp">
                      <i class="material-icons">schedule</i>
                      {{ formatTimestamp(log.timestamp) }}
                    </span>
                  </div>
                </div>
                
                <div class="log-severity" [ngClass]="getAuditSeverityClass(log.severity)">
                  <span class="severity-badge">{{ log.severity }}</span>
                </div>
                
                <div class="log-expand-icon">
                  <i class="material-icons">{{ log.expanded ? 'expand_less' : 'expand_more' }}</i>
                </div>
              </div>
              
              <!-- Expandable Details -->
              <div class="log-details" *ngIf="log.expanded">
                <div class="detail-row" *ngIf="log.userEmail">
                  <span class="detail-label">User Email:</span>
                  <span class="detail-value">{{ log.userEmail }}</span>
                </div>
                
                <div class="detail-row" *ngIf="log.details">
                  <span class="detail-label">Details:</span>
                  <span class="detail-value">{{ log.details }}</span>
                </div>
                
                <div class="detail-row" *ngIf="log.resourceId">
                  <span class="detail-label">Resource ID:</span>
                  <span class="detail-value">{{ log.resourceId }}</span>
                </div>
                
                <div class="detail-row" *ngIf="log.ipAddress">
                  <span class="detail-label">IP Address:</span>
                  <span class="detail-value">{{ log.ipAddress }}</span>
                </div>
                
                <div class="detail-row" *ngIf="log.userAgent">
                  <span class="detail-label">User Agent:</span>
                  <span class="detail-value">{{ log.userAgent }}</span>
                </div>
                
                <div class="detail-row" *ngIf="log.metadata && Object.keys(log.metadata).length > 0">
                  <span class="detail-label">Additional Info:</span>
                  <div class="metadata-container">
                    <div *ngFor="let key of Object.keys(log.metadata)" class="metadata-item">
                      <strong>{{ key }}:</strong> {{ log.metadata[key] }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- No Logs Message -->
          <div class="no-audit-logs" *ngIf="filteredAuditLogs.length === 0 && !loadingAuditLogs">
            <i class="material-icons">history</i>
            <h3>No Audit Logs Found</h3>
            <p>{{ auditLogFilter ? 'No logs match your search criteria' : 'No audit logs available for your account' }}</p>
          </div>
        </div>
      </div>

      <!-- Other sections (Reports) -->
      <div class="content-section" *ngIf="activeSidebarItem === 'reports'">
        <div class="section-header">
          <h2>{{ ('dashboard.' + activeSidebarItem) | translate }}</h2>
        </div>
        <div class="coming-soon">
          <i class="material-icons">construction</i>
          <p>{{ 'dashboard.coming_soon' | translate }}</p>
        </div>
      </div>
      
    </main>
    
    <!-- Right Panel (Patient Details) -->
    <aside class="right-panel" *ngIf="selectedPatient">
      <div class="panel-header">
        <h3>{{ 'dashboard.patient_details' | translate }}</h3>
        <button class="btn btn-link" (click)="selectedPatient = null" :title="'common.close' | translate">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="panel-content">
        <!-- Non-PHI Information -->
        <div class="patient-summary">
          <h4>{{ selectedPatient.displayName }}</h4>
          <p><strong>{{ 'dashboard.id' | translate }}</strong> {{ selectedPatient.identifier }}</p>
          <p><strong>{{ 'dashboard.study' | translate }}</strong> {{ selectedPatient.studyId || 'N/A' }}</p>
          <p><strong>{{ 'dashboard.status' | translate }}</strong> 
            <span class="status-badge" [class]="selectedPatient.status">{{ selectedPatient.status }}</span>
          </p>
        </div>
        
        <!-- PHI Information (if accessible) -->
        <div class="phi-section" *ngIf="selectedPatientPhiData">
          <h4>{{ 'dashboard.clinical_information' | translate }}</h4>
          <div class="phi-warning">
            <i class="material-icons">{{ 'dashboard.security' | translate }}</i>
            <span>{{ 'dashboard.protected_health_information' | translate }}</span>
          </div>
          
          <div class="phi-data">
            <p *ngIf="selectedPatientPhiData.gender"><strong>{{ 'dashboard.gender' | translate }}</strong> {{ selectedPatientPhiData.gender }}</p>
            <p *ngIf="selectedPatientPhiData.dateOfBirth"><strong>{{ 'dashboard.birth_date' | translate }}</strong> {{ selectedPatientPhiData.dateOfBirth | date:'mediumDate' }}</p>
            <!-- Add more PHI fields as needed -->
          </div>
        </div>
        
        <!-- Phase Progress -->
        <div class="phase-progress-section" *ngIf="selectedPatient.studyId">
          <app-patient-phase-progress [patientId]="selectedPatient.id!" [studyId]="selectedPatient.studyId" (phaseSelected)="onPhaseSelected($event)">
          </app-patient-phase-progress>
        </div>
        
        <!-- Patient Forms -->
        <div class="patient-forms">
          <h4>Forms ({{ selectedPatientForms.length }})</h4>
          <div class="form-list">
            <div *ngFor="let form of selectedPatientForms" class="form-item">
              <div class="form-info">
                <span class="form-name">{{ form.templateId }}</span>
                <span class="form-status" [class]="form.status">{{ form.status }}</span>
              </div>
              <div class="form-actions">
                <button class="btn btn-sm btn-link" :title="'dashboard.view_form' | translate">
                  <i class="material-icons">{{ 'dashboard.visibility' | translate }}</i>
                </button>
                <button class="btn btn-sm btn-link" *ngIf="form.status !== 'locked'" :title="'dashboard.edit_form' | translate">
                  <i class="material-icons">edit</i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Create New Form for Patient -->
          <div class="create-form-section" *ngIf="(templates$ | async) as templates">
            <h5>{{ 'dashboard.create_new_form' | translate }}</h5>
            <div class="template-selector">
              <div class="template-dropdown">
                <select class="form-select" [(ngModel)]="selectedTemplateForPatient" (change)="onTemplateSelected()">
                  <option value="" disabled="" selected="">{{ 'dashboard.select_a_template' | translate }}</option>
                  <option *ngFor="let template of templates" [value]="template.id" [disabled]="template.status !== 'published'">
                    {{ template.name }} 
                    ({{ template.status }})
                  </option>
                </select>
                <button class="btn btn-primary btn-sm" (click)="createFormForSelectedTemplate()" [disabled]="!selectedTemplateForPatient || !permissions.canCreate">
                  <i class="material-icons">{{ 'common.add' | translate }}</i>{{ 'dashboard.create_form' | translate }}</button>
              </div>
              <div class="template-info" *ngIf="getSelectedTemplateInfo() as templateInfo">
                <p class="template-description">{{ templateInfo.description || 'No description available' }}</p>
                <div class="template-meta">
                  <span><i class="material-icons">{{ 'dashboard.category' | translate }}</i> {{ templateInfo.category || 'General' }}</span>
                  <span><i class="material-icons">{{ 'dashboard.input' | translate }}</i> {{ templateInfo.fields.length || 0 }} fields</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>
    
  </div>
  
</div>

<!-- Template Management Modal -->
<app-template-management [templates]="allTemplates" [permissions]="permissions"  [isVisible]="showTemplateModal" (close)="closeTemplateModal()" (createTemplate)="createNewTemplate()" (editTemplate)="editTemplate($event)" (deleteTemplate)="deleteTemplate($event)" (publishTemplate)="publishTemplate($event)" (duplicateTemplate)="duplicateTemplate($event)" (exportTemplate)="exportTemplate($event)" (fillTemplate)="fillTemplate($event)">
</app-template-management>

    <!-- Form Builder Modal -->
    <div *ngIf="showFormBuilderModal" class="modal-overlay">
      <div class="modal-content form-builder-modal">
        <app-form-builder 
          [templateId]="editingTemplateId" 
          [isModal]="true" 
          (templateSaved)="onTemplateSaved($event)" 
          (builderClosed)="closeFormBuilder()"
          (close)="closeFormBuilder()">
        </app-form-builder>
      </div>
    </div>

    <!-- Template Fill Modal -->
    <div *ngIf="showTemplateFillModal" class="modal-overlay">
      <div class="modal-content template-fill-modal">
        <div class="modal-header">
          <h2>
            <i class="material-icons">{{ 'dashboard.editnote' | translate }}</i>
            Fill Template: {{ templateToFill?.name }}
          </h2>
          <button class="btn btn-link" (click)="closeTemplateFillModal()" :title="'common.close' | translate">
            <i class="material-icons">{{ 'common.close' | translate }}</i>
          </button>
        </div>
        
        <div class="modal-body">
          <div class="fill-template-info">
            <p class="info-message">
              <i class="material-icons">{{ 'common.info' | translate }}</i>{{ 'dashboard.you_are_filling_out_a_test_instance_of_this_templa' | translate }}</p>
          </div>
          
          <!-- Form Preview Component to render the fillable form -->
          <app-form-preview *ngIf="templateToFill" [template]="templateToFill" [readonly]="false" (formSubmitted)="onTemplateFillSubmitted($event)" (formSaved)="onTemplateFillSaved($event)">
          </app-form-preview>
        </div>
      </div>
    </div>

    <!-- Patient Template Selection Modal -->
    <div class="modal-overlay patient-template-modal" *ngIf="showPatientTemplateModal">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>
            <i class="material-icons">{{ 'dashboard.personadd' | translate }}</i>{{ 'dashboard.create_new_patient' | translate }}</h2>
          <button class="btn btn-link" (click)="closePatientTemplateModal()" :title="'common.close' | translate">
            <i class="material-icons">{{ 'common.close' | translate }}</i>
          </button>
        </div>
        
        <div class="modal-body patient-template-selector">
          <div class="selection-header">
            <h3>{{ 'dashboard.select_patient_template' | translate }}</h3>
            <p>{{ 'dashboard.choose_a_template_to_create_a_new_patient_record_p' | translate }}</p>
          </div>
          
          <!-- Template Selection Grid -->
          <div class="template-grid" *ngIf="patientTemplates.length > 0">
            <div *ngFor="let template of patientTemplates" class="template-card" [class.selected]="selectedPatientTemplate?.id === template.id" (click)="selectPatientTemplate(template)">
              
              <div class="template-icon">
                <i class="material-icons">{{ 'dashboard.person' | translate }}</i>
                <div class="phi-badge">{{ 'dashboard.phi' | translate }}</div>
              </div>
              
              <div class="template-info">
                <h4>{{ template.name }}</h4>
                <p>{{ template.description }}</p>
                <div class="template-meta">
                  <span class="field-count">
                    <i class="material-icons">{{ 'dashboard.list' | translate }}</i>
                    {{ template.fields.length }} fields
                  </span>
                  <span class="template-status" [class]="template.status">{{ template.status }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- No Templates Available -->
          <div class="no-templates" *ngIf="patientTemplates.length === 0">
            <i class="material-icons">{{ 'common.info' | translate }}</i>
            <h3>{{ 'dashboard.no_patient_templates_available' | translate }}</h3>
            <p>{{ 'dashboard.you_need_to_create_a_patient_template_before_you_c' | translate }}</p>
            <button class="btn btn-primary" (click)="createPatientTemplate()">
              <i class="material-icons">{{ 'common.add' | translate }}</i>{{ 'dashboard.create_patient_template' | translate }}</button>
          </div>
          
          <!-- Selected Template Preview -->
          <div class="selected-template-preview" *ngIf="selectedPatientTemplate">
            <h4>Template Preview: {{ selectedPatientTemplate.name }}</h4>
            <div class="field-preview-list">
              <div *ngFor="let field of selectedPatientTemplate.fields.slice(0, 5)" class="field-preview-item">
                <i class="material-icons">{{ getFieldIcon(field.type) }}</i>
                <span class="field-name">{{ field.label }}</span>
                <span class="phi-indicator" *ngIf="field.isPhiField">
                  <i class="material-icons" :title="'dashboard.phi_field' | translate">{{ 'dashboard.security' | translate }}</i>
                </span>
              </div>
              <div class="more-fields" *ngIf="selectedPatientTemplate.fields.length > 5">
                +{{ selectedPatientTemplate.fields.length - 5 }} more fields
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closePatientTemplateModal()">{{ 'common.cancel' | translate }}</button>
          <button class="btn btn-success" [disabled]="!selectedPatientTemplate" (click)="createPatientFromTemplate()">
            <i class="material-icons">{{ 'dashboard.personadd' | translate }}</i>{{ 'dashboard.create_patient' | translate }}</button>
        </div>
      </div>
    </div>

    <!-- Patient Creation Form Modal -->
    <app-patient-form-modal [show]="showPatientFormModal" [template]="selectedPatientTemplate" [availableStudies]="studies" [defaultStudyId]="selectedStudy?.id || null" (close)="closePatientFormModal()" (submit)="onPatientFormSubmit($event)">
    </app-patient-form-modal>

    <!-- Profile Edit Popup -->
    <app-profile-edit-popup [userProfile]="userProfile$ | async" [isVisible]="showProfileEditModal" (closePopup)="closeProfileEditModal()" (profileUpdated)="onProfileUpdated($event)">
    </app-profile-edit-popup>

    <!-- Study Creation Modal -->
    <app-study-creation-modal [show]="showStudyCreationModal" (close)="onStudyWidgetClosed()" (create)="onStudyCreated($event)">
    </app-study-creation-modal>
</body></html>