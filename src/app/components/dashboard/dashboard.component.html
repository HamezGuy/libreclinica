<!-- EDC Dashboard with Three-Panel Layout -->
<div class="edc-dashboard" *ngIf="userProfile$ | async as userProfile">
  
  <!-- Top Navigation Bar -->
  <header class="top-bar">
    <div class="top-bar-left">
      <h1 class="app-title">
        <i class="material-icons">medical_services</i>
        EDC System
      </h1>
    </div>
    
    <div class="top-bar-center">
      <div class="search-container">
        <i class="material-icons">search</i>
        <input 
          type="text" 
          placeholder="Search patients, forms, or studies..."
          [(ngModel)]="searchQuery"
          class="search-input">
      </div>
    </div>
    
    <div class="top-bar-right">
      <!-- Form Template Actions -->
      <div class="template-actions">
        <button 
          class="btn btn-primary"
          (click)="openTemplateModal()"
          [disabled]="!permissions.canEdit && !permissions.canView"
          [title]="(permissions.canEdit || permissions.canView) ? 'Manage Templates' : 'Insufficient permissions to manage templates'">
          <i class="material-icons">description</i>
          Templates
        </button>
        
        <button 
          class="btn btn-success"
          (click)="createNewTemplate()"
          [disabled]="!permissions.canCreate"
          [title]="permissions.canCreate ? 'Create New Template' : 'Insufficient permissions to create templates'">
          <i class="material-icons">add</i>
          Create Template
        </button>
      </div>
      
      <!-- User Profile -->
      <div class="user-profile">
        <div class="profile-info" (click)="openProfileEditModal()" title="Edit Profile">
          <img 
            [src]="userProfile.photoURL || '/assets/default-avatar.svg'" 
            [alt]="userProfile.displayName"
            class="user-avatar">
          <div class="user-info">
            <span class="user-name">{{ userProfile.displayName }}</span>
            <span class="user-role">{{ userProfile.accessLevel }}</span>
          </div>
        </div>
        <button class="btn btn-link" (click)="signOut()" title="Sign Out">
          <i class="material-icons">logout</i>
        </button>
      </div>
    </div>
  </header>
  
  <!-- Main Content Area -->
  <div class="main-content">
    
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <nav class="sidebar-nav">
        <ul class="nav-list">
          <li 
            *ngFor="let item of sidebarItems" 
            class="nav-item"
            [class.active]="item.active"
            (click)="selectSidebarItem(item.id)">
            <i class="material-icons">{{ item.icon }}</i>
            <span>{{ item.label }}</span>
          </li>
        </ul>
      </nav>
      
      <!-- Sidebar Footer -->
      <div class="sidebar-footer">
        <div class="compliance-badges">
          <span class="badge hipaa">HIPAA</span>
          <span class="badge cfr21">21 CFR Part 11</span>
          <span class="badge gdpr">GDPR</span>
          <span class="badge dpdp">DPDP Act</span>
        </div>
      </div>
    </aside>
    
    <!-- Main Panel -->
    <main class="main-panel">
      
      <!-- Patients View -->
      <div class="content-section" *ngIf="activeSidebarItem === 'patients'">
        <div class="section-header">
          <h2>Patients</h2>
          <div class="section-actions">
            <button class="btn btn-primary" title="Add New Patient" (click)="openPatientTemplateSelector()">
              <i class="material-icons">person_add</i>
              Add Patient
            </button>
          </div>
        </div>
        
        <!-- Patient List -->
        <div class="patient-list">
          <div class="list-header">
            <span>Patient ID</span>
            <span>Name</span>
            <span>Study</span>
            <span>Forms</span>
            <span>Last Visit</span>
            <span>Status</span>
            <span>Actions</span>
          </div>
          
          <div 
            *ngFor="let patient of filteredPatients" 
            class="patient-item"
            [class.selected]="selectedPatient?.id === patient.id"
            (click)="selectPatient(patient)">
            <span class="patient-id">{{ patient.identifier }}</span>
            <span class="patient-name">
              {{ patient.displayName }}
              <i class="material-icons phi-icon" *ngIf="!patient.canViewPhi" title="PHI Restricted">lock</i>
            </span>
            <span class="patient-study">{{ patient.studyId || 'N/A' }}</span>
            <span class="patient-forms">{{ patient.formsCount }}</span>
            <span class="patient-visit">{{ patient.lastVisit ? (patient.lastVisit | date:'short') : 'N/A' }}</span>
            <span class="patient-status">
              <span class="status-badge" [class]="patient.status">{{ patient.status }}</span>
            </span>
            <span class="patient-actions">
              <button class="btn btn-sm btn-link" title="View Details">
                <i class="material-icons">visibility</i>
              </button>
              <button class="btn btn-sm btn-link" title="Edit">
                <i class="material-icons">edit</i>
              </button>
            </span>
          </div>
          
          <div *ngIf="filteredPatients.length === 0" class="empty-state">
            <i class="material-icons">people_outline</i>
            <p>No patients found</p>
          </div>
        </div>
      </div>
      
      <!-- Forms View -->
      <div class="content-section" *ngIf="activeSidebarItem === 'forms'">
        <div class="section-header">
          <h2>Form Templates</h2>
          <div class="section-actions">
            <!-- Temporary Fix Button -->
            <button 
              class="btn btn-warning" 
              (click)="fixTemplateIds()"
              title="Fix Template IDs (One-time migration)">
              <i class="material-icons">build</i>
              Fix Template IDs
            </button>
            
            <button 
              class="btn btn-primary" 
              (click)="createNewTemplate()"
              [disabled]="!permissions.canCreate"
              [title]="permissions.canCreate ? 'Create New Template' : 'Insufficient permissions to create templates'">
              <i class="material-icons">add</i>
              Create Template
            </button>
          </div>
        </div>
        
        <!-- Template List -->
        <div class="template-list">
          <div class="template-grid" *ngIf="filteredTemplates.length > 0">
            <div 
              *ngFor="let template of filteredTemplates" 
              class="template-card"
              [class]="template.status">
              <div class="template-header">
                <h3>{{ template.name }}</h3>
                <span class="template-version">v{{ template.version }}</span>
              </div>
              
              <div class="template-body">
                <p class="template-description">{{ template.description }}</p>
                <div class="template-meta">
                  <span class="field-count">{{ template.fields.length }} fields</span>
                  <span class="template-status" [class]="template.status">{{ template.status }}</span>
                </div>
              </div>
              
              <div class="template-actions">
                <button 
                  class="btn btn-sm btn-secondary"
                  (click)="editTemplate(template)"
                  *ngIf="permissions.canEdit"
                  title="Edit Template">
                  <i class="material-icons">edit</i>
                </button>
                
                <button 
                  class="btn btn-sm btn-success"
                  (click)="publishTemplate(template)"
                  *ngIf="permissions.canPublish && template.status === 'draft'"
                  title="Publish Template">
                  <i class="material-icons">publish</i>
                </button>
                
                <button 
                  class="btn btn-sm btn-danger"
                  (click)="deleteTemplate(template)"
                  *ngIf="permissions.canDelete"
                  title="Delete Template">
                  <i class="material-icons">delete</i>
                </button>
              </div>
            </div>
          </div>
          
          <div *ngIf="(templates$ | async)?.length === 0" class="empty-state">
            <i class="material-icons">description</i>
            <p>No form templates found</p>
            <button 
              class="btn btn-primary"
              (click)="createNewTemplate()"
              *ngIf="permissions.canCreate">
              Create Your First Template
            </button>
          </div>
        </div>
      </div>
      
      <!-- Studies View -->
      <div class="content-section" *ngIf="activeSidebarItem === 'studies'">
        <div class="section-header">
          <h2>Studies Management</h2>
          <div class="section-actions">
            <button 
              class="btn btn-primary" 
              (click)="createNewStudy()"
              [disabled]="!permissions.canCreate"
              [title]="permissions.canCreate ? 'Create New Study' : 'Insufficient permissions to create studies'">
              <i class="material-icons">add</i>
              Create Study
            </button>
          </div>
        </div>
        
        <!-- Studies Overview Cards -->
        <div class="overview-cards" *ngIf="studies.length > 0">
          <div class="overview-card">
            <div class="card-icon">
              <i class="material-icons">folder</i>
            </div>
            <div class="card-content">
              <h3>{{ studies.length }}</h3>
              <p>Total Studies</p>
            </div>
          </div>
          
          <div class="overview-card">
            <div class="card-icon">
              <i class="material-icons">people</i>
            </div>
            <div class="card-content">
              <h3>{{ getTotalEnrollments() }}</h3>
              <p>Total Enrollments</p>
            </div>
          </div>
          
          <div class="overview-card">
            <div class="card-icon">
              <i class="material-icons">warning</i>
            </div>
            <div class="card-content">
              <h3>{{ getTotalCareAlerts() }}</h3>
              <p>Care Alerts</p>
            </div>
          </div>
          
          <div class="overview-card">
            <div class="card-icon">
              <i class="material-icons">play_circle</i>
            </div>
            <div class="card-content">
              <h3>{{ getActiveStudiesCount() }}</h3>
              <p>Active Studies</p>
            </div>
          </div>
        </div>
        
        <!-- Studies Grid -->
        <div class="studies-list">
          <div class="studies-grid" *ngIf="filteredStudies.length > 0">
            <div 
              *ngFor="let study of filteredStudies; trackBy: trackStudy" 
              class="study-card"
              [class.selected]="selectedStudy?.id === study.id"
              (click)="selectStudy(study)">
              
              <div class="study-header">
                <h3>{{ study.title }}</h3>
                <div class="study-badges">
                  <span class="badge status" [class]="'status-' + study.status">{{ study.status }}</span>
                  <span class="badge phase" [class]="'phase-' + study.phase">{{ study.phase }}</span>
                </div>
              </div>
              
              <div class="study-body">
                <p class="study-description">{{ study.description }}</p>
                <div class="study-meta">
                  <div class="meta-item">
                    <i class="material-icons">confirmation_number</i>
                    <span>{{ study.protocolNumber }}</span>
                  </div>
                  <div class="meta-item">
                    <i class="material-icons">people</i>
                    <span>{{ study.actualEnrollment || 0 }}/{{ study.plannedEnrollment }} enrolled</span>
                  </div>
                  <div class="meta-item">
                    <i class="material-icons">description</i>
                    <span>{{ getSectionsForStudy(study.id || '').length }} sections</span>
                  </div>
                  <div class="meta-item" *ngIf="getCareIndicatorsForStudy(study.id || '').length > 0">
                    <i class="material-icons">warning</i>
                    <span>{{ getCareIndicatorsForStudy(study.id || '').length }} alerts</span>
                  </div>
                </div>
                
                <!-- Progress Bar for Selected Study -->
                <div class="study-progress" *ngIf="selectedStudy?.id === study.id">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="getStudyProgress(study)"></div>
                  </div>
                  <span class="progress-text">{{ getStudyProgress(study) }}% Complete</span>
                </div>
              </div>
              
              <div class="study-actions">
                <button 
                  class="btn btn-sm btn-secondary"
                  (click)="editStudy(study); $event.stopPropagation()"
                  *ngIf="permissions.canEdit"
                  title="Edit Study">
                  <i class="material-icons">edit</i>
                </button>
                
                <button 
                  class="btn btn-sm btn-primary"
                  (click)="enrollPatientInStudy(study); $event.stopPropagation()"
                  *ngIf="permissions.canCreate"
                  title="Enroll Patient">
                  <i class="material-icons">person_add</i>
                </button>
                
                <button 
                  class="btn btn-sm btn-danger"
                  (click)="deleteStudy(study); $event.stopPropagation()"
                  *ngIf="permissions.canDelete"
                  title="Delete Study">
                  <i class="material-icons">delete</i>
                </button>
              </div>
              
              <!-- Care Indicators -->
              <div class="care-indicators" *ngIf="getCareIndicatorsForStudy(study.id || '').length > 0">
                <div 
                  *ngFor="let indicator of getCareIndicatorsForStudy(study.id || '')"
                  class="care-indicator"
                  [class]="'severity-' + indicator.severity">
                  <i class="material-icons">{{ getCareIndicatorIcon(indicator.type) }}</i>
                  <span>{{ indicator.description }}</span>
                  <button 
                    class="btn btn-xs btn-link"
                    (click)="resolveCareIndicator(indicator); $event.stopPropagation()"
                    title="Resolve">
                    <i class="material-icons">check</i>
                  </button>
                </div>
              </div>
              
              <!-- Enhanced Study Management Panel -->
              <div class="enhanced-study-panel" *ngIf="selectedStudy?.id === study.id">
                <div class="study-tabs">
                  <button 
                    class="tab-button active"
                    (click)="$event.stopPropagation()">
                    <i class="material-icons">description</i>
                    Forms & Sections
                  </button>
                  <button 
                    class="tab-button"
                    (click)="openSubstudyModal(); $event.stopPropagation()">
                    <i class="material-icons">location_on</i>
                    Substudies
                  </button>
                  <button 
                    class="tab-button"
                    (click)="openStudyGroupModal(); $event.stopPropagation()">
                    <i class="material-icons">group</i>
                    Study Groups
                  </button>
                  <button 
                    class="tab-button"
                    *ngIf="getActiveDataQueriesCount() > 0"
                    (click)="$event.stopPropagation()">
                    <i class="material-icons">help</i>
                    Data Queries ({{ getActiveDataQueriesCount() }})
                  </button>
                </div>
                
                <!-- Study Sections with Form Management -->
                <div class="study-sections">
                  <div 
                    *ngFor="let section of getSectionsForStudy(study.id || ''); trackBy: trackSection" 
                    class="section-item"
                    [class.completed]="isSectionComplete(section.id)">
                    
                    <div class="section-header">
                      <div class="section-info">
                        <h4>{{ section.name }}</h4>
                        <span class="section-type">{{ section.type | titlecase }}</span>
                        <div class="section-progress">
                          <div class="progress-bar">
                            <div class="progress-fill" [style.width.%]="getSectionCompletionPercentage(section.id)"></div>
                          </div>
                          <span class="progress-text">{{ getSectionCompletionPercentage(section.id) }}% Complete</span>
                        </div>
                      </div>
                      
                      <div class="section-actions">
                        <button 
                          class="btn btn-xs btn-secondary"
                          (click)="openFormAssignmentModal(section); $event.stopPropagation()"
                          title="Assign Form">
                          <i class="material-icons">add</i>
                          Add Form
                        </button>
                        
                        <button 
                          class="btn btn-xs btn-success"
                          *ngIf="!isSectionComplete(section.id)"
                          (click)="markSectionComplete(section.id); $event.stopPropagation()"
                          title="Mark Complete">
                          <i class="material-icons">check_circle</i>
                        </button>
                        
                        <button 
                          class="btn btn-xs btn-warning"
                          *ngIf="isSectionComplete(section.id)"
                          (click)="markSectionIncomplete(section.id); $event.stopPropagation()"
                          title="Mark Incomplete">
                          <i class="material-icons">radio_button_unchecked</i>
                        </button>
                      </div>
                    </div>
                    
                    <!-- Section Forms -->
                    <div class="section-forms" *ngIf="getFormInstancesForSection(section.id).length > 0">
                      <div 
                        *ngFor="let formInstance of getFormInstancesForSection(section.id); trackBy: trackFormInstance"
                        class="form-instance"
                        [class]="'status-' + formInstance.status">
                        
                        <div class="form-info">
                          <span class="form-name">{{ formInstance.templateName }}</span>
                          <span class="form-status">{{ formInstance.status | titlecase }}</span>
                          <div class="form-progress">
                            <div class="progress-bar small">
                              <div class="progress-fill" [style.width.%]="formInstance.completionPercentage"></div>
                            </div>
                            <span class="progress-text">{{ formInstance.completionPercentage }}%</span>
                          </div>
                        </div>
                        
                        <div class="form-actions">
                          <button 
                            class="btn btn-xs btn-primary"
                            (click)="$event.stopPropagation()"
                            title="Fill Form">
                            <i class="material-icons">edit</i>
                          </button>
                          
                          <button 
                            class="btn btn-xs btn-info"
                            *ngIf="formInstance.queries && formInstance.queries.length > 0"
                            (click)="loadDataQueriesForForm(formInstance.id); $event.stopPropagation()"
                            title="View Queries ({{ formInstance.queries.length }})">
                            <i class="material-icons">help</i>
                            {{ formInstance.queries.length }}
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Empty state for section -->
                    <div class="section-empty" *ngIf="getFormInstancesForSection(section.id).length === 0">
                      <p>No forms assigned to this section</p>
                      <button 
                        class="btn btn-sm btn-primary"
                        (click)="openFormAssignmentModal(section); $event.stopPropagation()">
                        <i class="material-icons">add</i>
                        Assign First Form
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Empty State -->
          <div *ngIf="studies.length === 0" class="empty-state">
            <i class="material-icons">folder_open</i>
            <h3>No Studies Found</h3>
            <p>Create your first study to begin managing clinical research data.</p>
            <button 
              class="btn btn-primary"
              (click)="createNewStudy()"
              *ngIf="permissions.canCreate">
              <i class="material-icons">add</i>
              Create Your First Study
            </button>
          </div>
        </div>
      </div>
      
      <!-- Enhanced Study Management Modals -->
      
      <!-- Substudy Management Modal -->
      <div class="modal-overlay" *ngIf="showSubstudyModal">
        <div class="modal-content enhanced-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>Manage Substudies</h3>
            <button class="close-btn" (click)="closeSubstudyModal()">
              <i class="material-icons">close</i>
            </button>
          </div>
          
          <div class="modal-body">
            <div class="substudy-list">
              <div class="list-header">
                <h4>Substudies for {{ selectedStudy?.title }}</h4>
                <button class="btn btn-primary" (click)="createSubstudy(selectedStudy?.id || '', { studyId: selectedStudy?.id || '', name: 'New Substudy', geographicalLocation: { country: 'US', sites: [] }, targetEnrollment: 50, actualEnrollment: 0, status: 'planning', regulatoryApprovals: [], irbApprovals: [], createdBy: '', lastModifiedBy: '' })">
                  <i class="material-icons">add</i>
                  Add Substudy
                </button>
              </div>
              
              <div class="substudy-items" *ngIf="substudies.length > 0">
                <div 
                  *ngFor="let substudy of substudies; trackBy: trackSubstudy"
                  class="substudy-item"
                  [class.selected]="selectedSubstudy?.id === substudy.id"
                  (click)="selectSubstudy(substudy)">
                  
                  <div class="substudy-info">
                    <h5>{{ substudy.name }}</h5>
                    <p>{{ substudy.geographicalLocation.country }} - {{ substudy.geographicalLocation.region || 'All Regions' }}</p>
                    <div class="substudy-stats">
                      <span class="stat">{{ substudy.actualEnrollment }}/{{ substudy.targetEnrollment }} enrolled</span>
                      <span class="status" [class]="'status-' + substudy.status">{{ substudy.status | titlecase }}</span>
                    </div>
                  </div>
                  
                  <div class="substudy-actions">
                    <button class="btn btn-sm btn-secondary" title="Edit">
                      <i class="material-icons">edit</i>
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="empty-state" *ngIf="substudies.length === 0">
                <i class="material-icons">location_on</i>
                <h4>No Substudies</h4>
                <p>Create geographical substudies to organize your study by location.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Study Group Management Modal -->
      <div class="modal-overlay" *ngIf="showStudyGroupModal">
        <div class="modal-content enhanced-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>Manage Study Groups</h3>
            <button class="close-btn" (click)="closeStudyGroupModal()">
              <i class="material-icons">close</i>
            </button>
          </div>
          
          <div class="modal-body">
            <div class="study-group-list">
              <div class="list-header">
                <h4>Study Groups for {{ selectedStudy?.title }}</h4>
                <button class="btn btn-primary" (click)="createStudyGroup(selectedStudy?.id || '', { studyId: selectedStudy?.id || '', name: 'Control Group', groupType: 'control', targetEnrollment: 25, actualEnrollment: 0, blindingLevel: 'double', isActive: true, createdBy: '', lastModifiedBy: '' })">
                  <i class="material-icons">add</i>
                  Add Group
                </button>
              </div>
              
              <div class="study-group-items" *ngIf="studyGroups.length > 0">
                <div 
                  *ngFor="let group of studyGroups; trackBy: trackStudyGroup"
                  class="study-group-item"
                  [class.selected]="selectedStudyGroup?.id === group.id"
                  (click)="selectStudyGroup(group)">
                  
                  <div class="group-info">
                    <h5>{{ group.name }}</h5>
                    <p>{{ group.groupType | titlecase }} Group</p>
                    <div class="group-stats">
                      <span class="stat">{{ group.actualEnrollment }}/{{ group.targetEnrollment }} enrolled</span>
                      <span class="blinding">{{ group.blindingLevel | titlecase }} Blind</span>
                      <span class="status" [class.active]="group.isActive">{{ group.isActive ? 'Active' : 'Inactive' }}</span>
                    </div>
                  </div>
                  
                  <div class="group-actions">
                    <button class="btn btn-sm btn-secondary" title="Edit">
                      <i class="material-icons">edit</i>
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="empty-state" *ngIf="studyGroups.length === 0">
                <i class="material-icons">group</i>
                <h4>No Study Groups</h4>
                <p>Create treatment arms and control groups to organize patient enrollment.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Form Assignment Modal -->
      <div class="modal-overlay" *ngIf="showFormAssignmentModal">
        <div class="modal-content enhanced-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>Assign Form to Section</h3>
            <button class="close-btn" (click)="closeFormAssignmentModal()">
              <i class="material-icons">close</i>
            </button>
          </div>
          
          <div class="modal-body">
            <div class="form-assignment">
              <div class="section-info">
                <h4>Section: {{ selectedSection?.name }}</h4>
                <p>{{ selectedSection?.description }}</p>
              </div>
              
              <div class="template-selection">
                <h5>Select Form Template</h5>
                <div class="template-grid" *ngIf="availableTemplates.length > 0">
                  <div 
                    *ngFor="let template of availableTemplates"
                    class="template-card"
                    [class.selected]="selectedTemplateForAssignment?.id === template.id"
                    (click)="selectedTemplateForAssignment = template">
                    
                    <div class="template-header">
                      <h6>{{ template.name }}</h6>
                      <span class="template-type" [class]="'type-' + template.templateType">{{ template.templateType | titlecase }}</span>
                    </div>
                    
                    <div class="template-info">
                      <p>{{ template.description }}</p>
                      <div class="template-stats">
                        <span class="field-count">{{ template.fields.length || 0 }} fields</span>
                        <span class="version">v{{ template.version }}</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="empty-state" *ngIf="availableTemplates.length === 0">
                  <i class="material-icons">description</i>
                  <h4>No Templates Available</h4>
                  <p>Create form templates first before assigning them to study sections.</p>
                </div>
              </div>
              
              <div class="assignment-actions" *ngIf="selectedTemplateForAssignment">
                <button 
                  class="btn btn-primary"
                  (click)="assignFormToSection(selectedSection?.id || '', selectedTemplateForAssignment.id!)">
                  <i class="material-icons">assignment</i>
                  Assign Form
                </button>
                <button class="btn btn-secondary" (click)="closeFormAssignmentModal()">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Other sections (Reports, Audit) -->
      <div class="content-section" *ngIf="activeSidebarItem !== 'patients' && activeSidebarItem !== 'forms' && activeSidebarItem !== 'studies'">
        <div class="section-header">
          <h2>{{ activeSidebarItem | titlecase }}</h2>
        </div>
        <div class="coming-soon">
          <i class="material-icons">construction</i>
          <p>{{ activeSidebarItem | titlecase }} section coming soon...</p>
        </div>
      </div>
      
    </main>
    
    <!-- Right Panel (Patient Details) -->
    <aside class="right-panel" *ngIf="selectedPatient">
      <div class="panel-header">
        <h3>Patient Details</h3>
        <button class="btn btn-link" (click)="selectedPatient = null" title="Close">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="panel-content">
        <!-- Non-PHI Information -->
        <div class="patient-summary">
          <h4>{{ selectedPatient.displayName }}</h4>
          <p><strong>ID:</strong> {{ selectedPatient.identifier }}</p>
          <p><strong>Study:</strong> {{ selectedPatient.studyId || 'N/A' }}</p>
          <p><strong>Status:</strong> 
            <span class="status-badge" [class]="selectedPatient.status">{{ selectedPatient.status }}</span>
          </p>
        </div>
        
        <!-- PHI Information (if accessible) -->
        <div class="phi-section" *ngIf="selectedPatientPhiData">
          <h4>Clinical Information</h4>
          <div class="phi-warning">
            <i class="material-icons">security</i>
            <span>Protected Health Information</span>
          </div>
          
          <div class="phi-data">
            <p *ngIf="selectedPatientPhiData.gender"><strong>Gender:</strong> {{ selectedPatientPhiData.gender }}</p>
            <p *ngIf="selectedPatientPhiData.dateOfBirth"><strong>Birth Date:</strong> {{ selectedPatientPhiData.dateOfBirth | date }}</p>
            <!-- Add more PHI fields as needed -->
          </div>
        </div>
        
        <!-- Patient Forms -->
        <div class="patient-forms">
          <h4>Forms ({{ selectedPatientForms.length }})</h4>
          <div class="form-list">
            <div 
              *ngFor="let form of selectedPatientForms" 
              class="form-item">
              <div class="form-info">
                <span class="form-name">{{ form.templateId }}</span>
                <span class="form-status" [class]="form.status">{{ form.status }}</span>
              </div>
              <div class="form-actions">
                <button class="btn btn-sm btn-link" title="View Form">
                  <i class="material-icons">visibility</i>
                </button>
                <button class="btn btn-sm btn-link" title="Edit Form" *ngIf="form.status !== 'locked'">
                  <i class="material-icons">edit</i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Create New Form for Patient -->
          <div class="create-form-section" *ngIf="(templates$ | async) as templates">
            <h5>Create New Form</h5>
            <div class="template-selector">
              <button 
                *ngFor="let template of templates" 
                class="btn btn-sm btn-outline"
                (click)="createLegacyFormInstance(template, selectedPatient!)"
                [disabled]="template.status !== 'published'">
                {{ template.name }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </aside>
    
  </div>
  
</div>

<!-- Template Management Modal -->
<app-template-management
  [templates]="allTemplates"
  [permissions]="permissions"
  [isVisible]="showTemplateModal"
  (close)="closeTemplateModal()"
  (createTemplate)="createNewTemplate()"
  (editTemplate)="editTemplate($event)"
  (deleteTemplate)="deleteTemplate($event)"
  (publishTemplate)="publishTemplate($event)"
  (duplicateTemplate)="duplicateTemplate($event)"
  (exportTemplate)="exportTemplate($event)">
</app-template-management>

    <!-- Form Builder Modal -->
    <div *ngIf="showFormBuilderModal" class="modal-overlay">
      <div class="modal-content form-builder-modal">
        <app-form-builder
          [templateId]="editingTemplateId"
          [isModal]="true"
          (templateSaved)="onTemplateSaved($event)"
          (builderClosed)="closeFormBuilder()">
        </app-form-builder>
      </div>
    </div>

    <!-- Patient Template Selection Modal -->
    <div class="modal-overlay patient-template-modal" *ngIf="showPatientTemplateModal">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>
            <i class="material-icons">person_add</i>
            Create New Patient
          </h2>
          <button class="btn btn-link" (click)="closePatientTemplateModal()" title="Close">
            <i class="material-icons">close</i>
          </button>
        </div>
        
        <div class="modal-body patient-template-selector">
          <div class="selection-header">
            <h3>Select Patient Template</h3>
            <p>Choose a template to create a new patient record. Patient templates contain PHI data and are encrypted for security.</p>
          </div>
          
          <!-- Template Selection Grid -->
          <div class="template-grid" *ngIf="patientTemplates.length > 0">
            <div 
              *ngFor="let template of patientTemplates" 
              class="template-card" 
              [class.selected]="selectedPatientTemplate?.id === template.id"
              (click)="selectPatientTemplate(template)">
              
              <div class="template-icon">
                <i class="material-icons">person</i>
                <div class="phi-badge">PHI</div>
              </div>
              
              <div class="template-info">
                <h4>{{ template.name }}</h4>
                <p>{{ template.description }}</p>
                <div class="template-meta">
                  <span class="field-count">
                    <i class="material-icons">list</i>
                    {{ template.fields.length }} fields
                  </span>
                  <span class="template-status" [class]="template.status">{{ template.status }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- No Templates Available -->
          <div class="no-templates" *ngIf="patientTemplates.length === 0">
            <i class="material-icons">info</i>
            <h3>No Patient Templates Available</h3>
            <p>You need to create a patient template before you can add patients.</p>
            <button class="btn btn-primary" (click)="createPatientTemplate()">
              <i class="material-icons">add</i>
              Create Patient Template
            </button>
          </div>
          
          <!-- Selected Template Preview -->
          <div class="selected-template-preview" *ngIf="selectedPatientTemplate">
            <h4>Template Preview: {{ selectedPatientTemplate.name }}</h4>
            <div class="field-preview-list">
              <div 
                *ngFor="let field of selectedPatientTemplate.fields.slice(0, 5)" 
                class="field-preview-item">
                <i class="material-icons">{{ getFieldIcon(field.type) }}</i>
                <span class="field-name">{{ field.label }}</span>
                <span class="phi-indicator" *ngIf="field.isPhiField">
                  <i class="material-icons" title="PHI Field">security</i>
                </span>
              </div>
              <div class="more-fields" *ngIf="selectedPatientTemplate.fields.length > 5">
                +{{ selectedPatientTemplate.fields.length - 5 }} more fields
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closePatientTemplateModal()">
            Cancel
          </button>
          <button 
            class="btn btn-success" 
            [disabled]="!selectedPatientTemplate"
            (click)="createPatientFromTemplate()">
            <i class="material-icons">person_add</i>
            Create Patient
          </button>
        </div>
      </div>
    </div>

    <!-- Patient Creation Form Modal -->
    <div class="modal-overlay patient-form-modal" *ngIf="showPatientFormModal">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>
            <i class="material-icons">person</i>
            New Patient: {{ selectedPatientTemplate?.name }}
          </h2>
          <button class="btn btn-link" (click)="closePatientFormModal()" title="Close">
            <i class="material-icons">close</i>
          </button>
        </div>
        
        <div class="modal-body patient-form-container">
          <div class="phi-warning">
            <i class="material-icons">security</i>
            <span>This form contains Protected Health Information (PHI). Data will be encrypted and access will be logged.</span>
          </div>
          
          <!-- Dynamic Patient Form -->
          <div class="patient-form" *ngIf="selectedPatientTemplate">
            <form [formGroup]="patientForm" (ngSubmit)="submitPatientForm()">
              <div 
                *ngFor="let field of selectedPatientTemplate.fields" 
                class="form-group" 
                [class.phi-field]="field.isPhiField">
                
                <label [class.required]="field.required">
                  {{ field.label }}
                  <i class="material-icons phi-icon" *ngIf="field.isPhiField" title="PHI Field">security</i>
                </label>
                
                <!-- Dynamic Field Rendering -->
                <div [ngSwitch]="field.type" class="field-input">
                  <!-- Patient Name Field -->
                  <input 
                    *ngSwitchCase="'patient_name'"
                    type="text"
                    class="form-control"
                    [formControlName]="field.name"
                    [placeholder]="field.placeholder"
                    [readonly]="field.readonly">
                  
                  <!-- Patient ID Field -->
                  <input 
                    *ngSwitchCase="'patient_id'"
                    type="text"
                    class="form-control"
                    [formControlName]="field.name"
                    [placeholder]="field.placeholder"
                    [readonly]="field.readonly">
                  
                  <!-- Date of Birth -->
                  <input 
                    *ngSwitchCase="'date_of_birth'"
                    type="date"
                    class="form-control"
                    [formControlName]="field.name"
                    [readonly]="field.readonly">
                  
                  <!-- SSN -->
                  <input 
                    *ngSwitchCase="'ssn'"
                    type="text"
                    class="form-control"
                    [formControlName]="field.name"
                    [placeholder]="field.placeholder"
                    [readonly]="field.readonly"
                    pattern="[0-9]{3}-[0-9]{2}-[0-9]{4}">
                  
                  <!-- Address -->
                  <div *ngSwitchCase="'address'" class="address-fields">
                    <input type="text" class="form-control" [formControlName]="field.name + '_street'" placeholder="Street Address">
                    <div class="address-row">
                      <input type="text" class="form-control" [formControlName]="field.name + '_city'" placeholder="City">
                      <input type="text" class="form-control" [formControlName]="field.name + '_state'" placeholder="State">
                      <input type="text" class="form-control" [formControlName]="field.name + '_zip'" placeholder="ZIP">
                    </div>
                  </div>
                  
                  <!-- Phone Number -->
                  <input 
                    *ngSwitchCase="'phone_number'"
                    type="tel"
                    class="form-control"
                    [formControlName]="field.name"
                    [placeholder]="field.placeholder"
                    [readonly]="field.readonly">
                  
                  <!-- Email -->
                  <input 
                    *ngSwitchCase="'email_address'"
                    type="email"
                    class="form-control"
                    [formControlName]="field.name"
                    [placeholder]="field.placeholder"
                    [readonly]="field.readonly">
                  
                  <!-- Medical Record Number -->
                  <input 
                    *ngSwitchCase="'medical_record_number'"
                    type="text"
                    class="form-control"
                    [formControlName]="field.name"
                    [placeholder]="field.placeholder"
                    [readonly]="field.readonly">
                  
                  <!-- Default Text Input -->
                  <input 
                    *ngSwitchDefault
                    type="text"
                    class="form-control"
                    [formControlName]="field.name"
                    [placeholder]="field.placeholder"
                    [readonly]="field.readonly">
                </div>
                
                <small class="field-help" *ngIf="field.helpText">{{ field.helpText }}</small>
              </div>
              
              <!-- Study Enrollment (if applicable) -->
              <div class="form-group" *ngIf="availableStudies.length > 0">
                <label>Enroll in Study (Optional)</label>
                <select class="form-control" formControlName="studyId">
                  <option value="">No study enrollment</option>
                  <option *ngFor="let study of availableStudies" [value]="study.id">{{ study.title }}</option>
                </select>
              </div>
            </form>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closePatientFormModal()">
            Cancel
          </button>
          <button 
            class="btn btn-success" 
            [disabled]="!patientForm.valid || isCreatingPatient"
            (click)="submitPatientForm()">
            <i class="material-icons" *ngIf="!isCreatingPatient">save</i>
            <i class="material-icons rotating" *ngIf="isCreatingPatient">sync</i>
            {{ isCreatingPatient ? 'Creating...' : 'Create Patient' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Profile Edit Popup -->
    <app-profile-edit-popup
      [userProfile]="currentUserProfile"
      [isVisible]="showProfileEditModal"
      (closePopup)="closeProfileEditModal()"
      (profileUpdated)="onProfileUpdated($event)">
    </app-profile-edit-popup>

    <!-- Create Study Widget -->
    <app-create-study-widget
      [isVisible]="showStudyCreationModal"
      [userProfile]="currentUserProfile"
      [permissions]="permissions"
      (closeModal)="onStudyWidgetClosed()"
      (studyCreated)="onStudyCreated($event)"
      (refreshStudies)="onRefreshStudies()">
    </app-create-study-widget>
