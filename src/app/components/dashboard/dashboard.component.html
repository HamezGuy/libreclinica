<!-- EDC Dashboard with Three-Panel Layout -->
<div class="edc-dashboard" *ngIf="userProfile$ | async as userProfile">
  
  <!-- Top Navigation Bar -->
  <header class="top-bar">
    <div class="top-bar-left">
      <h1 class="app-title">
        <i class="material-icons">medical_services</i>
        EDC System
      </h1>
    </div>
    
    <div class="top-bar-center">
      <div class="search-container">
        <i class="material-icons">search</i>
        <input 
          type="text" 
          placeholder="Search patients, forms, or studies..."
          [(ngModel)]="searchQuery"
          class="search-input">
      </div>
    </div>
    
    <div class="top-bar-right">
      <!-- Form Template Actions -->
      <div class="template-actions">
        <button 
          class="btn btn-primary"
          (click)="openTemplateModal()"
          [disabled]="!permissions.canEdit && !permissions.canView"
          [title]="(permissions.canEdit || permissions.canView) ? 'Manage Templates' : 'Insufficient permissions to manage templates'">
          <i class="material-icons">description</i>
          Templates
        </button>
        
        <button 
          class="btn btn-success"
          (click)="createNewTemplate()"
          [disabled]="!permissions.canCreate"
          [title]="permissions.canCreate ? 'Create New Template' : 'Insufficient permissions to create templates'">
          <i class="material-icons">add</i>
          Create Template
        </button>
      </div>
      
      <!-- User Profile -->
      <div class="user-profile">
        <div class="profile-info" (click)="openProfileEditModal()" title="Edit Profile">
          <img 
            [src]="userProfile.photoURL || '/assets/default-avatar.svg'" 
            [alt]="userProfile.displayName"
            class="user-avatar">
          <div class="user-info">
            <span class="user-name">{{ userProfile.displayName }}</span>
            <span class="user-role">{{ userProfile.accessLevel }}</span>
          </div>
        </div>
        <button class="btn btn-link" (click)="signOut()" title="Sign Out">
          <i class="material-icons">logout</i>
        </button>
      </div>
    </div>
  </header>
  
  <!-- Main Content Area -->
  <div class="main-content">
    
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <nav class="sidebar-nav">
        <ul class="nav-list">
          <li 
            *ngFor="let item of sidebarItems" 
            class="nav-item"
            [class.active]="item.active"
            (click)="selectSidebarItem(item.id)">
            <i class="material-icons">{{ item.icon }}</i>
            <span>{{ item.label }}</span>
          </li>
        </ul>
      </nav>
      
      <!-- Sidebar Footer -->
      <div class="sidebar-footer">
        <div class="compliance-badges">
          <span class="badge hipaa">HIPAA</span>
          <span class="badge cfr21">21 CFR Part 11</span>
          <span class="badge gdpr">GDPR</span>
          <span class="badge dpdp">DPDP Act</span>
        </div>
      </div>
    </aside>
    
    <!-- Main Panel -->
    <main class="main-panel">
      
      <!-- Patients View -->
      <div class="content-section" *ngIf="activeSidebarItem === 'patients'">
        <div class="section-header">
          <h2>Patients</h2>
          <div class="section-actions">
            <button class="btn btn-primary" title="Add New Patient">
              <i class="material-icons">person_add</i>
              Add Patient
            </button>
          </div>
        </div>
        
        <!-- Patient List -->
        <div class="patient-list">
          <div class="list-header">
            <span>Patient ID</span>
            <span>Name</span>
            <span>Study</span>
            <span>Forms</span>
            <span>Last Visit</span>
            <span>Status</span>
            <span>Actions</span>
          </div>
          
          <div 
            *ngFor="let patient of filteredPatients" 
            class="patient-item"
            [class.selected]="selectedPatient?.id === patient.id"
            (click)="selectPatient(patient)">
            <span class="patient-id">{{ patient.identifier }}</span>
            <span class="patient-name">
              {{ patient.displayName }}
              <i class="material-icons phi-icon" *ngIf="!patient.canViewPhi" title="PHI Restricted">lock</i>
            </span>
            <span class="patient-study">{{ patient.studyId || 'N/A' }}</span>
            <span class="patient-forms">{{ patient.formsCount }}</span>
            <span class="patient-visit">{{ patient.lastVisit ? (patient.lastVisit | date:'short') : 'N/A' }}</span>
            <span class="patient-status">
              <span class="status-badge" [class]="patient.status">{{ patient.status }}</span>
            </span>
            <span class="patient-actions">
              <button class="btn btn-sm btn-link" title="View Details">
                <i class="material-icons">visibility</i>
              </button>
              <button class="btn btn-sm btn-link" title="Edit">
                <i class="material-icons">edit</i>
              </button>
            </span>
          </div>
          
          <div *ngIf="filteredPatients.length === 0" class="empty-state">
            <i class="material-icons">people_outline</i>
            <p>No patients found</p>
          </div>
        </div>
      </div>
      
      <!-- Forms View -->
      <div class="content-section" *ngIf="activeSidebarItem === 'forms'">
        <div class="section-header">
          <h2>Form Templates</h2>
          <div class="section-actions">
            <button 
              class="btn btn-primary" 
              (click)="createNewTemplate()"
              [disabled]="!permissions.canCreate"
              [title]="permissions.canCreate ? 'Create New Template' : 'Insufficient permissions to create templates'">
              <i class="material-icons">add</i>
              Create Template
            </button>
          </div>
        </div>
        
        <!-- Template List -->
        <div class="template-list">
          <div class="template-grid" *ngIf="filteredTemplates.length > 0">
            <div 
              *ngFor="let template of filteredTemplates" 
              class="template-card"
              [class]="template.status">
              <div class="template-header">
                <h3>{{ template.name }}</h3>
                <span class="template-version">v{{ template.version }}</span>
              </div>
              
              <div class="template-body">
                <p class="template-description">{{ template.description }}</p>
                <div class="template-meta">
                  <span class="field-count">{{ template.fields.length }} fields</span>
                  <span class="template-status" [class]="template.status">{{ template.status }}</span>
                </div>
              </div>
              
              <div class="template-actions">
                <button 
                  class="btn btn-sm btn-secondary"
                  (click)="editTemplate(template)"
                  *ngIf="permissions.canEdit"
                  title="Edit Template">
                  <i class="material-icons">edit</i>
                </button>
                
                <button 
                  class="btn btn-sm btn-success"
                  (click)="publishTemplate(template)"
                  *ngIf="permissions.canPublish && template.status === 'draft'"
                  title="Publish Template">
                  <i class="material-icons">publish</i>
                </button>
                
                <button 
                  class="btn btn-sm btn-danger"
                  (click)="deleteTemplate(template)"
                  *ngIf="permissions.canDelete"
                  title="Delete Template">
                  <i class="material-icons">delete</i>
                </button>
              </div>
            </div>
          </div>
          
          <div *ngIf="(templates$ | async)?.length === 0" class="empty-state">
            <i class="material-icons">description</i>
            <p>No form templates found</p>
            <button 
              class="btn btn-primary"
              (click)="createNewTemplate()"
              *ngIf="permissions.canCreate">
              Create Your First Template
            </button>
          </div>
        </div>
      </div>
      
      <!-- Other sections (Studies, Reports, Audit) -->
      <div class="content-section" *ngIf="activeSidebarItem !== 'patients' && activeSidebarItem !== 'forms'">
        <div class="section-header">
          <h2>{{ activeSidebarItem | titlecase }}</h2>
        </div>
        <div class="coming-soon">
          <i class="material-icons">construction</i>
          <p>{{ activeSidebarItem | titlecase }} section coming soon...</p>
        </div>
      </div>
      
    </main>
    
    <!-- Right Panel (Patient Details) -->
    <aside class="right-panel" *ngIf="selectedPatient">
      <div class="panel-header">
        <h3>Patient Details</h3>
        <button class="btn btn-link" (click)="selectedPatient = null" title="Close">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="panel-content">
        <!-- Non-PHI Information -->
        <div class="patient-summary">
          <h4>{{ selectedPatient.displayName }}</h4>
          <p><strong>ID:</strong> {{ selectedPatient.identifier }}</p>
          <p><strong>Study:</strong> {{ selectedPatient.studyId || 'N/A' }}</p>
          <p><strong>Status:</strong> 
            <span class="status-badge" [class]="selectedPatient.status">{{ selectedPatient.status }}</span>
          </p>
        </div>
        
        <!-- PHI Information (if accessible) -->
        <div class="phi-section" *ngIf="selectedPatientPhiData">
          <h4>Clinical Information</h4>
          <div class="phi-warning">
            <i class="material-icons">security</i>
            <span>Protected Health Information</span>
          </div>
          
          <div class="phi-data">
            <p *ngIf="selectedPatientPhiData.gender"><strong>Gender:</strong> {{ selectedPatientPhiData.gender }}</p>
            <p *ngIf="selectedPatientPhiData.dateOfBirth"><strong>Birth Date:</strong> {{ selectedPatientPhiData.dateOfBirth | date }}</p>
            <!-- Add more PHI fields as needed -->
          </div>
        </div>
        
        <!-- Patient Forms -->
        <div class="patient-forms">
          <h4>Forms ({{ selectedPatientForms.length }})</h4>
          <div class="form-list">
            <div 
              *ngFor="let form of selectedPatientForms" 
              class="form-item">
              <div class="form-info">
                <span class="form-name">{{ form.templateId }}</span>
                <span class="form-status" [class]="form.status">{{ form.status }}</span>
              </div>
              <div class="form-actions">
                <button class="btn btn-sm btn-link" title="View Form">
                  <i class="material-icons">visibility</i>
                </button>
                <button class="btn btn-sm btn-link" title="Edit Form" *ngIf="form.status !== 'locked'">
                  <i class="material-icons">edit</i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Create New Form for Patient -->
          <div class="create-form-section" *ngIf="(templates$ | async) as templates">
            <h5>Create New Form</h5>
            <div class="template-selector">
              <button 
                *ngFor="let template of templates" 
                class="btn btn-sm btn-outline"
                (click)="createFormInstance(template, selectedPatient!)"
                [disabled]="template.status !== 'published'">
                {{ template.name }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </aside>
    
  </div>
  
</div>

<!-- Enhanced Template Management Modal -->
<div class="modal-overlay template-management-modal" *ngIf="showTemplateModal" (click)="closeTemplateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2><i class="material-icons">description</i> Form Templates</h2>
      <div class="header-actions">
        <button class="btn btn-primary" (click)="createNewTemplate()" *ngIf="permissions.canCreate">
          <i class="material-icons">add</i> New Template
        </button>
        <button class="btn btn-link close-btn" (click)="closeTemplateModal()">
          <i class="material-icons">close</i>
        </button>
      </div>
    </div>
    
    <div class="modal-body">
        <!-- Left Sidebar - Template List -->
        <div class="templates-sidebar">
          <div class="sidebar-header">
            <div class="search-container">
              <i class="material-icons">search</i>
              <input 
                type="text" 
                placeholder="Search templates..." 
                [(ngModel)]="templateSearchTerm"
                (input)="filterTemplates()">
            </div>
            <div class="filter-buttons">
              <button 
                class="filter-btn" 
                [class.active]="templateFilter === 'all'"
                (click)="setTemplateFilter('all')">
                All ({{ filteredTemplates.length }})
              </button>
              <button 
                class="filter-btn" 
                [class.active]="templateFilter === 'draft'"
                (click)="setTemplateFilter('draft')">
                Draft
              </button>
              <button 
                class="filter-btn" 
                [class.active]="templateFilter === 'published'"
                (click)="setTemplateFilter('published')">
                Published
              </button>
            </div>
          </div>
          
          <div class="template-list-enhanced">
            <div 
              *ngFor="let template of filteredTemplates; trackBy: trackTemplate" 
              class="template-item"
              [class.selected]="selectedTemplate?.id === template.id"
              (click)="selectTemplate(template)">
              
              <div class="template-card">
                <div class="template-header">
                  <h4>{{ template.name }}</h4>
                  <span class="status-badge" [class]="'status-' + template.status">{{ template.status }}</span>
                </div>
                
                <p class="template-description">{{ template.description || 'No description' }}</p>
                
                <div class="template-stats">
                  <div class="stat">
                    <i class="material-icons">input</i>
                    <span>{{ template.fields.length || 0 }} fields</span>
                  </div>
                  <div class="stat">
                    <i class="material-icons">folder</i>
                    <span>{{ template.category || 'General' }}</span>
                  </div>
                  <div class="stat">
                    <i class="material-icons">schedule</i>
                    <span>{{ convertTimestampToDate(template.updatedAt) | date:'short' }}</span>
                  </div>
                </div>
                
                <div class="template-actions-quick" (click)="$event.stopPropagation()">
                  <button 
                    class="btn-icon" 
                    (click)="editTemplate(template)"
                    [disabled]="!permissions.canEdit"
                    title="Edit Template">
                    <i class="material-icons">edit</i>
                  </button>
                  <button 
                    class="btn-icon danger" 
                    (click)="deleteTemplate(template)"
                    [disabled]="!permissions.canDelete"
                    title="Delete Template">
                    <i class="material-icons">delete</i>
                  </button>
                </div>
              </div>
            </div>
            
            <div *ngIf="filteredTemplates.length === 0" class="empty-state">
              <i class="material-icons">description</i>
              <h3>No templates found</h3>
              <p>{{ templateSearchTerm ? 'Try adjusting your search terms' : 'Create your first template to get started' }}</p>
            </div>
          </div>
          
          <!-- Template Details at Bottom of Sidebar -->
          <div *ngIf="selectedTemplate" class="template-details-bottom">
            <div class="details-section">
              <h4>Template Information</h4>
              <div class="info-list">
                <div class="info-item">
                  <label>Description</label>
                  <p>{{ selectedTemplate.description || 'No description provided' }}</p>
                </div>
                <div class="info-item">
                  <label>Category</label>
                  <p>{{ selectedTemplate.category || 'clinical' }}</p>
                </div>
                <div class="info-item">
                  <label>Version</label>
                  <p>{{ selectedTemplate.version || '1' }}</p>
                </div>
                <div class="info-item">
                  <label>Status</label>
                  <p>{{ selectedTemplate.status }}</p>
                </div>
                <div class="info-item">
                  <label>Created</label>
                  <p>{{ convertTimestampToDate(selectedTemplate.createdAt) | date:'medium' }}</p>
                </div>
                <div class="info-item">
                  <label>Last Modified</label>
                  <p>{{ convertTimestampToDate(selectedTemplate.updatedAt) | date:'medium' }}</p>
                </div>
                <div class="info-item">
                  <label>Total Fields</label>
                  <p>{{ selectedTemplate.fields.length || 0 }}</p>
                </div>
                <div class="info-item">
                  <label>PHI Enabled</label>
                  <p>{{ selectedTemplate.isPhiForm ? 'Yes' : 'No' }}</p>
                </div>
              </div>
              
              <!-- Actions -->
              <div class="template-actions-main">
                <button 
                  class="btn btn-primary"
                  (click)="editTemplate(selectedTemplate!)"
                  [disabled]="!permissions.canEdit">
                  <i class="material-icons">edit</i> Edit Template
                </button>
                
                <button 
                  class="btn btn-success"
                  (click)="publishTemplate(selectedTemplate!)"
                  [disabled]="!permissions.canPublish || selectedTemplate!.status !== 'draft'">
                  <i class="material-icons">publish</i> 
                  {{ selectedTemplate!.status === 'published' ? 'Published' : 'Publish' }}
                </button>
                
                <button 
                  class="btn btn-info"
                  (click)="duplicateTemplate(selectedTemplate!)"
                  [disabled]="!permissions.canCreate">
                  <i class="material-icons">content_copy</i> Duplicate
                </button>
                
                <button 
                  class="btn btn-outline"
                  (click)="exportTemplate(selectedTemplate!)">
                  <i class="material-icons">download</i> Export
                </button>
                
                <button 
                  class="btn btn-danger"
                  (click)="deleteTemplate(selectedTemplate!)"
                  [disabled]="!permissions.canDelete">
                  <i class="material-icons">delete</i> Delete
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Right Panel - Always Show Preview -->
        <div class="template-preview-panel">
          <div *ngIf="!selectedTemplate" class="no-selection">
            <i class="material-icons">description</i>
            <h3>Select a template to view preview</h3>
            <p>Click on any template from the list to see its live preview</p>
          </div>
          
          <div *ngIf="selectedTemplate" class="template-preview">
            <div class="preview-header">
              <div class="template-title">
                <h2>{{ selectedTemplate.name }}</h2>
                <span class="preview-label">Live Preview</span>
              </div>
            </div>
            
            <!-- Always reserve space for preview content -->
            <div class="preview-content" [class.loading]="!selectedTemplate">
              <div *ngIf="!selectedTemplate" class="preview-loading">
                <div class="spinner"></div>
                <p>Loading preview...</p>
              </div>
              <app-form-preview 
                *ngIf="selectedTemplate"
                [template]="selectedTemplate"
                [readonly]="true"
                (formDataChanged)="onPreviewFormDataChanged($event)"
                (formSaved)="onPreviewFormSaved($event)"
                (formSubmitted)="onPreviewFormSubmitted($event)">
              </app-form-preview>
            </div>
          </div>
        </div>
    </div>
  </div>
</div>

<!-- Form Builder Modal -->
<div *ngIf="showFormBuilderModal" class="modal-overlay">
  <div class="modal-content form-builder-modal">
    <app-form-builder
      [templateId]="formBuilderTemplateId"
      [isModal]="true"
      (templateSaved)="onTemplateSaved($event)"
      (builderClosed)="closeFormBuilder()">
    </app-form-builder>
  </div>
</div>

<!-- Profile Edit Popup -->
<app-profile-edit-popup
  [userProfile]="currentUserProfile"
  [isVisible]="showProfileEditModal"
  (closePopup)="closeProfileEditModal()"
  (profileUpdated)="onProfileUpdated($event)">
</app-profile-edit-popup>
