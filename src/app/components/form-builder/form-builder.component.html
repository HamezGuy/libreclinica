<!-- Form Builder Component -->
<div class="form-builder" [class.modal-mode]="isModal">
  
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-spinner">
      <span class="material-icons rotating">sync</span>
      <p>Loading template...</p>
    </div>
  </div>

  <!-- Builder Header -->
  <div class="builder-header">
    <div class="header-left">
      <h2>
        <span class="material-icons">build</span>
        {{ currentTemplate?.name || 'New Form Template' }}
      </h2>
      <div class="template-status">
        <span class="status-badge" [ngClass]="currentTemplate?.status">
          {{ currentTemplate?.status || 'draft' }}
        </span>
        <span class="version-badge">v{{ builderForm.get('version')?.value }}</span>
      </div>
    </div>

    <div class="header-center">
      <div class="tab-navigation">
        <button 
          type="button" 
          class="tab-btn" 
          [class.active]="activeTab === 'information'"
          (click)="switchTab('information')">
          <span class="material-icons">info</span>
          Form Information
        </button>
        <button 
          type="button" 
          class="tab-btn" 
          [class.active]="activeTab === 'design'"
          (click)="switchTab('design')">
          <span class="material-icons">design_services</span>
          Build Form
        </button>
        <button 
          type="button" 
          class="tab-btn" 
          [class.active]="activeTab === 'preview'"
          (click)="switchTab('preview')">
          <span class="material-icons">preview</span>
          Preview
        </button>
      </div>
    </div>

    <div class="header-right">
      <div class="action-buttons">
        <button 
          type="button" 
          class="btn btn-outline btn-sm"
          (click)="previewTemplate()"
          [disabled]="isLoading">
          <span class="material-icons">visibility</span>
          Preview
        </button>
        
        <button 
          type="button" 
          class="btn btn-primary btn-sm"
          (click)="saveTemplate()"
          [disabled]="!canSave || isSaving">
          <span class="material-icons">{{ isSaving ? 'sync' : 'save' }}</span>
          {{ isSaving ? 'Saving...' : 'Save' }}
        </button>
        
        <button 
          type="button" 
          class="btn btn-success btn-sm"
          (click)="publishTemplate()"
          [disabled]="!canPublish"
          *ngIf="currentTemplate?.status === 'draft'">
          <span class="material-icons">publish</span>
          Publish
        </button>
        
        <button 
          type="button" 
          class="btn btn-link btn-sm"
          (click)="closeBuilder()">
          <span class="material-icons">close</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Save Feedback Message -->
  <div *ngIf="saveMessageVisible" class="save-message" [ngClass]="saveMessageType">
    <div class="message-content">
      <span class="material-icons">{{ saveMessageType === 'success' ? 'check_circle' : 'error' }}</span>
      <span class="message-text">{{ saveMessage }}</span>
      <button type="button" class="close-btn" (click)="hideSaveMessage()">
        <span class="material-icons">close</span>
      </button>
    </div>
  </div>

  <!-- Builder Content -->
  <div class="builder-content">
    
    <!-- Form Information Tab (formerly Settings) -->
    <div *ngIf="activeTab === 'information'" class="settings-panel">
      <div class="settings-header">
        <h3>
          <span class="material-icons">info</span>
          Form Information
        </h3>
      </div>
      
      <div class="settings-content">
        <form [formGroup]="builderForm">
          
          <!-- Basic Settings -->
          <div class="settings-section">
            <h4>Basic Information</h4>
            
            <div class="form-group" [class.error]="builderForm.get('name')?.invalid && builderForm.get('name')?.touched">
              <label for="template-name">Template Name <span class="required">*</span></label>
              <input 
                type="text" 
                id="template-name" 
                formControlName="name" 
                placeholder="Enter template name"
                class="form-control">
              <span class="error-message" *ngIf="builderForm.get('name')?.invalid && builderForm.get('name')?.touched">
                Template name is required (minimum 3 characters)
              </span>
            </div>

            <div class="form-group">
              <label for="template-description">Description</label>
              <textarea 
                id="template-description" 
                formControlName="description" 
                rows="3" 
                placeholder="Describe the purpose of this form template"
                class="form-control"></textarea>
            </div>

            <div class="form-row">
              <div class="form-group" [class.error]="builderForm.get('category')?.invalid && builderForm.get('category')?.touched">
                <label for="template-category">Category <span class="required">*</span></label>
                <select id="template-category" formControlName="category" class="form-control">
                  <option value="">Select category</option>
                  <option value="clinical">Clinical</option>
                  <option value="administrative">Administrative</option>
                  <option value="research">Research</option>
                  <option value="survey">Survey</option>
                  <option value="consent">Consent</option>
                  <option value="other">Other</option>
                </select>
                <span class="error-message" *ngIf="builderForm.get('category')?.invalid && builderForm.get('category')?.touched">
                  Please select a category
                </span>
              </div>

              <div class="form-group" [class.error]="builderForm.get('version')?.invalid && builderForm.get('version')?.touched">
                <label for="template-version">Version <span class="required">*</span></label>
                <input 
                  type="number" 
                  id="template-version" 
                  formControlName="version" 
                  min="1" 
                  step="1"
                  class="form-control">
                <span class="error-message" *ngIf="builderForm.get('version')?.invalid && builderForm.get('version')?.touched">
                  Version is required
                </span>
              </div>
            </div>

            <div class="form-group" [class.error]="builderForm.get('templateType')?.invalid && builderForm.get('templateType')?.touched">
              <label for="template-type">Template Type <span class="required">*</span></label>
              <select id="template-type" formControlName="templateType" class="form-control">
                <option value="">Select template type</option>
                <option value="form">Standard Form</option>
                <option value="patient_template">Patient Template (PHI)</option>
                <option value="study_subject">Study Subject Form</option>
              </select>
              <span class="error-message" *ngIf="builderForm.get('templateType')?.invalid && builderForm.get('templateType')?.touched">
                Please select a template type
              </span>
            </div>
          </div>

          <!-- Form Behavior -->
          <div class="settings-section">
            <h4>Form Behavior</h4>
            
            <div class="checkbox-group">
              <label class="checkbox-option">
                <input type="checkbox" formControlName="isPhiForm">
                <span class="checkbox-label">Contains PHI (Protected Health Information)</span>
                <span class="checkbox-description">Enable additional security and audit features</span>
              </label>

              <label class="checkbox-option">
                <input type="checkbox" formControlName="requiresSignature">
                <span class="checkbox-label">Requires Electronic Signature</span>
                <span class="checkbox-description">Users must sign the form upon submission</span>
              </label>

              <label class="checkbox-option">
                <input type="checkbox" formControlName="allowPartialSave">
                <span class="checkbox-label">Allow Partial Save</span>
                <span class="checkbox-description">Users can save incomplete forms as drafts</span>
              </label>
            </div>

            <div class="form-group">
              <label for="max-submissions">Maximum Submissions per User</label>
              <input 
                type="number" 
                id="max-submissions" 
                formControlName="maxSubmissions" 
                min="0" 
                placeholder="0 for unlimited"
                class="form-control">
              <span class="help-text">Leave as 0 for unlimited submissions</span>
            </div>

            <div class="form-group">
              <label for="expiration-date">Expiration Date</label>
              <input 
                type="date" 
                id="expiration-date" 
                formControlName="expirationDate"
                class="form-control">
              <span class="help-text">Form will not accept submissions after this date</span>
            </div>
          </div>

          <!-- Additional Settings -->
          <div class="settings-section">
            <h4>Additional Settings</h4>
            
            <div class="form-group">
              <label for="instructions">Form Instructions</label>
              <textarea 
                id="instructions" 
                formControlName="instructions" 
                rows="4" 
                placeholder="Instructions shown to users before filling the form"
                class="form-control"></textarea>
            </div>

            <div class="form-group">
              <label for="custom-css">Custom CSS</label>
              <textarea 
                id="custom-css" 
                formControlName="customCss" 
                rows="4" 
                placeholder="/* Custom styles for this form */"
                class="form-control"
                style="font-family: monospace;"></textarea>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Build Form Tab (formerly Design) -->
    <div *ngIf="activeTab === 'design'" class="design-panel" [class.properties-shown]="showFieldProperties && selectedField">
      
      <!-- Field Toolbox -->
      <div class="field-toolbox">
        <div class="toolbox-header">
          <h3>
            <span class="material-icons">widgets</span>
            Field Types
          </h3>
        </div>
        
        <div class="toolbox-content">
          <!-- Basic Fields -->
          <div class="field-category">
            <h4>
              <span class="material-icons">text_fields</span>
              Basic Fields
            </h4>
            <div class="field-type-list" cdkDropList id="basic-fields" cdkDropListSortingDisabled="true" [cdkDropListData]="basicFields" [cdkDropListConnectedTo]="['form-canvas']">
              <div 
                *ngFor="let fieldType of basicFields"
                class="field-type-item"
                cdkDrag
                [cdkDragData]="fieldType.type"
                [title]="fieldType.description"
                (click)="addFieldToCanvas(fieldType.type)">
                <span class="material-icons">{{ fieldType.icon }}</span>
                <span class="field-label">{{ fieldType.label }}</span>
              </div>
            </div>
          </div>

          <!-- Advanced Fields -->
          <div class="field-category">
            <h4>
              <span class="material-icons">tune</span>
              Advanced Fields
            </h4>
            <div class="field-type-list" cdkDropList id="advanced-fields" cdkDropListSortingDisabled="true" [cdkDropListData]="advancedFields" [cdkDropListConnectedTo]="['form-canvas']">
              <div 
                *ngFor="let fieldType of advancedFields"
                class="field-type-item"
                cdkDrag
                [cdkDragData]="fieldType.type"
                [title]="fieldType.description"
                (click)="addFieldToCanvas(fieldType.type)">
                <span class="material-icons">{{ fieldType.icon }}</span>
                <span class="field-label">{{ fieldType.label }}</span>
              </div>
            </div>
          </div>

          <!-- Clinical Fields -->
          <div class="field-category">
            <h4>
              <span class="material-icons">local_hospital</span>
              Clinical Fields
            </h4>
            <div class="field-type-list" cdkDropList id="clinical-fields" cdkDropListSortingDisabled="true" [cdkDropListData]="clinicalFields" [cdkDropListConnectedTo]="['form-canvas']">
              <div 
                *ngFor="let fieldType of clinicalFields"
                class="field-type-item"
                cdkDrag
                [cdkDragData]="fieldType.type"
                [title]="fieldType.description"
                (click)="addFieldToCanvas(fieldType.type)">
                <span class="material-icons">{{ fieldType.icon }}</span>
                <span class="field-label">{{ fieldType.label }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Canvas -->
      <div class="form-canvas">
        <div class="canvas-header">
          <h3>
            <span class="material-icons">article</span>
            Form Layout
          </h3>
          <div class="canvas-actions">
            <button type="button" class="btn btn-link btn-sm" title="Clear All Fields">
              <span class="material-icons">clear_all</span>
            </button>
          </div>
        </div>
        
        <div class="canvas-content">
          <!-- Form Fields Drop Zone -->
          <div 
            class="form-fields-container"
            cdkDropList
            id="form-canvas"
            [cdkDropListConnectedTo]="['basic-fields', 'advanced-fields', 'clinical-fields']"
            [cdkDropListData]="fieldsArray.controls"
            (cdkDropListDropped)="onFieldDrop($event)">
            
            <!-- Empty State -->
            <div *ngIf="fieldsArray.length === 0" class="empty-canvas">
              <span class="material-icons">drag_indicator</span>
              <p>Drag field types from the toolbox to start building your form</p>
            </div>

            <!-- Form Fields -->
            <div 
              *ngFor="let fieldControl of fieldsArray.controls; let i = index"
              class="form-field-item"
              cdkDrag
              [class.selected]="selectedField?.id === fieldControl.get('id')?.value"
              (click)="selectField(fieldControl.value)">
                
                <div class="field-drag-handle" cdkDragHandle>
                  <span class="material-icons">drag_indicator</span>
                </div>
                
                <div class="field-content">
                  <div class="field-header">
                    <div class="field-info">
                      <span class="field-type-icon material-icons">
                        {{ getFieldIcon(fieldControl.get('type')?.value) }}
                    </span>
                    <span class="field-label">{{ fieldControl.get('label')?.value }}</span>
                    <span *ngIf="fieldControl.get('isRequired')?.value" class="required-indicator">*</span>
                    <span *ngIf="fieldControl.get('isPhiField')?.value" class="phi-indicator" title="Contains PHI">
                      <span class="material-icons">security</span>
                    </span>
                  </div>
                  
                  <div class="field-actions">
                    <button 
                      type="button" 
                      class="btn btn-link btn-sm"
                      (click)="duplicateField(i); $event.stopPropagation()"
                      title="Duplicate Field">
                      <span class="material-icons">content_copy</span>
                    </button>
                    <button 
                      type="button" 
                      class="btn btn-link btn-sm text-danger"
                      (click)="deleteField(i); $event.stopPropagation()"
                      title="Delete Field">
                      <span class="material-icons">delete</span>
                    </button>
                  </div>
                </div>
                
                <div class="field-preview">
                  <!-- Field preview based on type -->
                  <div [ngSwitch]="fieldControl.get('type')?.value" class="field-input-preview">
                    
                    <!-- Text Input -->
                    <input 
                      *ngSwitchCase="'text'"
                      type="text" 
                      class="form-control"
                      [placeholder]="fieldControl.get('placeholder')?.value"
                      disabled>
                    
                    <!-- Textarea -->
                    <textarea 
                      *ngSwitchCase="'textarea'"
                      class="form-control"
                      [placeholder]="fieldControl.get('placeholder')?.value"
                      rows="3"
                      disabled></textarea>
                    
                    <!-- Number Input -->
                    <input 
                      *ngSwitchCase="'number'"
                      type="number" 
                      class="form-control"
                      [placeholder]="fieldControl.get('placeholder')?.value"
                      disabled>
                    
                    <!-- Select Dropdown -->
                    <select 
                      *ngSwitchCase="'select'"
                      class="form-control"
                      disabled>
                      <option value="">{{ fieldControl.get('placeholder')?.value || 'Select an option' }}</option>
                      <option 
                        *ngFor="let option of fieldControl.get('options')?.value"
                        [value]="option.value">
                        {{ option.label }}
                      </option>
                    </select>
                    
                    <!-- Radio Buttons -->
                    <div *ngSwitchCase="'radio'" class="radio-group">
                      <label 
                        *ngFor="let option of fieldControl.get('options')?.value"
                        class="radio-option">
                        <input type="radio" [name]="fieldControl.get('name')?.value" [value]="option.value" disabled>
                        <span>{{ option.label }}</span>
                      </label>
                    </div>
                    
                    <!-- Checkboxes -->
                    <div *ngSwitchCase="'checkbox'" class="checkbox-group">
                      <label 
                        *ngFor="let option of fieldControl.get('options')?.value"
                        class="checkbox-option">
                        <input type="checkbox" [value]="option.value" disabled>
                        <span>{{ option.label }}</span>
                      </label>
                    </div>
                    
                    <!-- Date Input -->
                    <input 
                      *ngSwitchCase="'date'"
                      type="date" 
                      class="form-control"
                      disabled>
                    
                    <!-- Boolean Toggle -->
                    <div *ngSwitchCase="'boolean'" class="boolean-preview">
                      <label class="boolean-toggle-preview">
                        <input type="checkbox" disabled>
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">Yes/No</span>
                      </label>
                    </div>
                    
                    <!-- File Upload -->
                    <div *ngSwitchCase="'file'" class="file-upload-preview">
                      <span class="material-icons">upload_file</span>
                      <span>Choose file or drag here</span>
                    </div>
                    
                    <!-- Default -->
                    <input 
                      *ngSwitchDefault
                      type="text" 
                      class="form-control"
                      [placeholder]="fieldControl.get('placeholder')?.value"
                      disabled>
                  </div>
                  
                  <!-- Help Text -->
                  <div *ngIf="fieldControl.get('helpText')?.value" class="field-help-text">
                    {{ fieldControl.get('helpText')?.value }}
                  </div>
                </div>
              </div>
          </div>
        </div>
      </div>

        <!-- Field Properties Panel -->
        <div class="field-properties" [class.show]="showFieldProperties && selectedField">
        <div class="properties-header">
          <h3>
            <span class="material-icons">tune</span>
            Field Properties
          </h3>
          <button 
            type="button" 
            class="btn btn-link btn-sm"
            (click)="showFieldProperties = false">
            <span class="material-icons">close</span>
          </button>
        </div>
        
        <div class="properties-content" *ngIf="selectedField">
          <form [formGroup]="builderForm">
            <!-- Find the selected field in the form array and bind to it -->
            <div *ngFor="let fieldControl of fieldsArray.controls; let i = index">
              <div *ngIf="fieldControl.get('id')?.value === selectedField.id" [formGroup]="$any(fieldControl)">
                
                <!-- Basic Properties -->
                <div class="property-section">
                  <h4>Basic Properties</h4>
                  
                  <div class="form-group">
                    <label>Field Label *</label>
                    <input type="text" class="form-control" formControlName="label">
                  </div>
                  
                  <div class="form-group">
                    <label>Field Name *</label>
                    <input type="text" class="form-control" formControlName="name">
                  </div>
                  
                  <div class="form-group">
                    <label>Placeholder Text</label>
                    <input type="text" class="form-control" formControlName="placeholder">
                  </div>
                  
                  <div class="form-group">
                    <label>Help Text</label>
                    <textarea class="form-control" formControlName="helpText" rows="2"></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label>Default Value</label>
                    <input type="text" class="form-control" formControlName="defaultValue">
                  </div>
                </div>

                <!-- Layout Settings -->
                <div class="property-section">
                  <h4>Layout & Positioning</h4>
                  
                  <div class="form-group">
                    <label>Field Width</label>
                    <select class="form-control" formControlName="width">
                      <option value="full">Full Width (100%)</option>
                      <option value="half">Half Width (50%)</option>
                      <option value="third">Third Width (33%)</option>
                      <option value="quarter">Quarter Width (25%)</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label>Column Position</label>
                    <select class="form-control" formControlName="columnPosition">
                      <option value="left">Left Column</option>
                      <option value="right">Right Column</option>
                      <option value="center">Center</option>
                    </select>
                  </div>
                </div>

                <!-- Field Options (for select, radio, checkbox) -->
                <div 
                  class="property-section"
                  *ngIf="fieldControl.get('type')?.value === 'select' || 
                         fieldControl.get('type')?.value === 'multiselect' ||
                         fieldControl.get('type')?.value === 'radio' || 
                         fieldControl.get('type')?.value === 'checkbox'">
                  <h4>Options</h4>
                  
                  <div formArrayName="options">
                    <div 
                      *ngFor="let optionControl of getOptionsControls(fieldControl); let j = index"
                      class="option-item"
                      [formGroupName]="j">
                      <div class="form-group">
                        <input type="text" class="form-control" formControlName="label" placeholder="Option Label">
                      </div>
                      <div class="form-group">
                        <input type="text" class="form-control" formControlName="value" placeholder="Option Value">
                      </div>
                      <button 
                        type="button" 
                        class="btn btn-link btn-sm text-danger"
                        (click)="removeOption(i, j)">
                        <span class="material-icons">delete</span>
                      </button>
                    </div>
                    
                    <button 
                      type="button" 
                      class="btn btn-outline btn-sm"
                      (click)="addOption(i)">
                      <span class="material-icons">add</span>
                      Add Option
                    </button>
                  </div>
                </div>

                <!-- Field Settings -->
                <div class="property-section">
                  <h4>Field Settings</h4>
                  
                  <div class="checkbox-group">
                    <label class="checkbox-option">
                      <input type="checkbox" formControlName="isRequired">
                      <span>Required Field</span>
                    </label>
                    
                    <label class="checkbox-option">
                      <input type="checkbox" formControlName="isReadonly">
                      <span>Read Only</span>
                    </label>
                    
                    <label class="checkbox-option">
                      <input type="checkbox" formControlName="isHidden">
                      <span>Hidden Field</span>
                    </label>
                    
                    <label class="checkbox-option">
                      <input type="checkbox" formControlName="isPhiField">
                      <span>Contains PHI Data</span>
                    </label>
                  </div>
                </div>

                <!-- Validation Rules -->
                <div class="property-section">
                  <h4>Validation Rules</h4>
                  
                  <div formArrayName="validationRules">
                    <div 
                      *ngFor="let ruleControl of getValidationRulesControls(fieldControl); let k = index"
                      class="validation-rule-item"
                      [formGroupName]="k">
                      
                      <div class="form-group">
                        <select class="form-control" formControlName="type">
                          <option value="">Select Rule Type</option>
                          <option 
                            *ngFor="let rule of validationRules"
                            [value]="rule.type">
                            {{ rule.label }}
                          </option>
                        </select>
                      </div>
                      
                      <div class="form-group" *ngIf="ruleControl.get('type')?.value && getValidationRule(ruleControl.get('type')?.value)?.hasValue">
                        <input 
                          type="text" 
                          class="form-control" 
                          formControlName="value"
                          placeholder="Rule Value">
                      </div>
                      
                      <div class="form-group">
                        <input 
                          type="text" 
                          class="form-control" 
                          formControlName="message"
                          placeholder="Error Message">
                      </div>
                      
                      <button 
                        type="button" 
                        class="btn btn-link btn-sm text-danger"
                        (click)="removeValidationRule(i, k)">
                        <span class="material-icons">delete</span>
                      </button>
                    </div>
                    
                    <button 
                      type="button" 
                      class="btn btn-outline btn-sm"
                      (click)="addValidationRule(i)">
                      <span class="material-icons">add</span>
                      Add Validation Rule
                    </button>
                  </div>
                </div>

                <!-- Audit Trail Settings -->
                <div class="property-section" formGroupName="auditTrail">
                  <h4>Audit Trail</h4>
                  
                  <div class="checkbox-group">
                    <label class="checkbox-option">
                      <input type="checkbox" formControlName="trackChanges">
                      <span>Track Field Changes</span>
                    </label>
                    
                    <label class="checkbox-option">
                      <input type="checkbox" formControlName="reasonRequired">
                      <span>Require Change Reason</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Preview Tab -->
    <div *ngIf="isActiveTab('preview')" class="preview-panel">
      <div class="preview-header">
        <h3>
          <span class="material-icons">preview</span>
          Form Preview
        </h3>
        <div class="preview-actions">
          <button type="button" class="btn btn-outline btn-sm">
            <span class="material-icons">devices</span>
            Responsive View
          </button>
        </div>
      </div>
      
      <div class="preview-content">
        <!-- Use the actual form-preview component with live template data -->
        <app-form-preview 
          [template]="getCurrentTemplateData()"
          [readonly]="false"
          (formDataChanged)="onPreviewDataChanged($event)"
          (formSubmitted)="onPreviewSubmitted($event)"
          (formSaved)="onPreviewSaved($event)">
        </app-form-preview>
      </div>
    </div>

  </div>

  <!-- Unsaved Changes Warning -->
  <div *ngIf="hasUnsavedChanges" class="unsaved-changes-warning">
    <span class="material-icons">warning</span>
    <span>You have unsaved changes</span>
  </div>
</div>
