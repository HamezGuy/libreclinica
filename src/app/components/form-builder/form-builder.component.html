<!-- Form Builder Component -->
<div class="form-builder" [class.modal-mode]="isModal">
  
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-spinner">
      <span class="material-icons rotating">sync</span>
      <p>{{ 'form-builder.loading_template' | translate }}</p>
    </div>
  </div>

  <!-- Builder Header -->
  <div class="builder-header">
    <div class="header-left">
      <h2>
        <span class="material-icons">build</span>
        {{ currentTemplate?.name || ('form-builder.new_form_template' | translate) }}
      </h2>
      <div class="template-status">
        <span class="status-badge" [ngClass]="currentTemplate?.status">
          {{ currentTemplate?.status || ('form-builder.draft' | translate) }}
        </span>
        <span class="version-badge">v{{ builderForm.get('version')?.value }}</span>
      </div>
    </div>

    <div class="header-center">
      <div class="tab-navigation">
        <button type="button" class="tab-btn" [class.active]="activeTab === 'information'" (click)="switchTab('information')">
          <span class="material-icons">info</span>{{ 'form-builder.form_information' | translate }}</button>
        <button type="button" class="tab-btn" [class.active]="activeTab === 'design'" (click)="switchTab('design')">
          <span class="material-icons">design_services</span>{{ 'form-builder.build_form' | translate }}</button>
        <button type="button" class="tab-btn" [class.active]="activeTab === 'preview'" (click)="switchTab('preview')">
          <span class="material-icons">visibility</span>{{ 'form-builder.preview' | translate }}</button>
      </div>
    </div>

    <div class="header-right">
      <div class="action-buttons">
        <button type="button" class="btn btn-outline btn-sm" (click)="previewTemplate()" [disabled]="isLoading">
          <span class="material-icons">visibility</span>{{ 'form-builder.preview' | translate }}</button>
        
        <button type="button" class="btn btn-primary btn-sm" (click)="saveTemplate()" [disabled]="!canSave || isSaving">
          <span class="material-icons">{{ isSaving ? 'sync' : 'save' }}</span>
          {{ isSaving ? ('form-builder.saving' | translate) : ('form-builder.save' | translate) }}
        </button>
        
        <button type="button" class="btn btn-success btn-sm" (click)="publishTemplate()" [disabled]="!canPublish" *ngIf="currentTemplate?.status === 'draft'">
          <span class="material-icons">publish</span>{{ 'form-builder.publish' | translate }}</button>
        
        <button type="button" class="btn btn-link btn-sm" (click)="closeBuilder()">
          <span class="material-icons">close</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Save Feedback Message -->
  <div *ngIf="saveMessageVisible" class="save-message" [ngClass]="saveMessageType">
    <div class="message-content">
      <span class="material-icons">{{ saveMessageType === 'success' ? 'check_circle' : 'error' }}</span>
      <span class="message-text">{{ saveMessage }}</span>
      <button type="button" class="close-btn" (click)="hideSaveMessage()">
        <span class="material-icons">close</span>
      </button>
    </div>
  </div>

  <!-- Builder Content -->
  <div class="builder-content">
    
    <!-- Form Information Tab (formerly Settings) -->
    <div *ngIf="activeTab === 'information'" class="settings-panel">
      <div class="settings-header">
        <h3>
          <span class="material-icons">info</span>{{ 'form-builder.form_information' | translate }}</h3>
      </div>
      
      <div class="settings-content">
        <form [formGroup]="builderForm">
          
          <!-- Basic Settings -->
          <div class="settings-section">
            <h4>{{ 'form-builder.basic_information' | translate }}</h4>
            
            <div class="form-group" [class.error]="builderForm.get('name')?.invalid && builderForm.get('name')?.touched">
              <label for="template-name">{{ 'form-builder.template_name' | translate }}<span class="required">*</span></label>
              <input type="text" id="template-name" formControlName="name" class="form-control" [placeholder]="'form-builder.enter_template_name' | translate">
              <span class="error-message" *ngIf="builderForm.get('name')?.invalid && builderForm.get('name')?.touched">{{ 'form-builder.template_name_is_required_minimum_3_characters' | translate }}</span>
            </div>

            <div class="form-group">
              <label for="template-description">{{ 'common.description' | translate }}</label>
              <textarea id="template-description" formControlName="description" rows="3" class="form-control" [placeholder]="'form-builder.describe_the_purpose_of_this_form_template' | translate"></textarea>
            </div>

            <div class="form-row">
              <div class="form-group" [class.error]="builderForm.get('category')?.invalid && builderForm.get('category')?.touched">
                <label for="template-category">{{ 'form-builder.category' | translate }}<span class="required">*</span></label>
                <select id="template-category" formControlName="category" class="form-control">
                  <option value="">{{ 'form-builder.select_category' | translate }}</option>
                  <option value="clinical">{{ 'form-builder.clinical' | translate }}</option>
                  <option value="administrative">{{ 'form-builder.administrative' | translate }}</option>
                  <option value="research">{{ 'form-builder.research' | translate }}</option>
                  <option value="survey">{{ 'form-builder.survey' | translate }}</option>
                  <option value="consent">{{ 'form-builder.consent' | translate }}</option>
                  <option value="other">{{ 'form-builder.other' | translate }}</option>
                </select>
                <span class="error-message" *ngIf="builderForm.get('category')?.invalid && builderForm.get('category')?.touched">{{ 'form-builder.please_select_a_category' | translate }}</span>
              </div>

              <div class="form-group" [class.error]="builderForm.get('version')?.invalid && builderForm.get('version')?.touched">
                <label for="template-version">{{ 'form-builder.version' | translate }}<span class="required">*</span></label>
                <input type="number" id="template-version" formControlName="version" min="1" step="1" class="form-control">
                <span class="error-message" *ngIf="builderForm.get('version')?.invalid && builderForm.get('version')?.touched">{{ 'form-builder.version_is_required' | translate }}</span>
              </div>
            </div>

            <div class="form-group" [class.error]="builderForm.get('templateType')?.invalid && builderForm.get('templateType')?.touched">
              <label for="template-type">{{ 'form-builder.template_type' | translate }}<span class="required">*</span></label>
              <select id="template-type" formControlName="templateType" class="form-control">
                <option value="">{{ 'form-builder.select_template_type' | translate }}</option>
                <option value="form">{{ 'form-builder.standard_form' | translate }}</option>
                <option value="patient_template">{{ 'form-builder.patient_template_phi' | translate }}</option>
                <option value="study_subject">{{ 'form-builder.study_subject_form' | translate }}</option>
              </select>
              <span class="error-message" *ngIf="builderForm.get('templateType')?.invalid && builderForm.get('templateType')?.touched">{{ 'form-builder.please_select_a_template_type' | translate }}</span>
            </div>
          </div>

          <!-- Form Behavior -->
          <div class="settings-section">
            <h4>{{ 'form-builder.form_behavior' | translate }}</h4>
            
            <div class="checkbox-group">
              <label class="checkbox-option">
                <input type="checkbox" formControlName="isPhiForm">
                <span class="checkbox-label">{{ 'form-builder.contains_phi_protected_health_information' | translate }}</span>
                <span class="checkbox-description">{{ 'form-builder.enable_additional_security_and_audit_features' | translate }}</span>
              </label>

              <label class="checkbox-option">
                <input type="checkbox" formControlName="requiresSignature">
                <span class="checkbox-label">{{ 'form-builder.requires_electronic_signature' | translate }}</span>
                <span class="checkbox-description">{{ 'form-builder.users_must_sign_the_form_upon_submission' | translate }}</span>
              </label>

              <label class="checkbox-option">
                <input type="checkbox" formControlName="allowPartialSave">
                <span class="checkbox-label">{{ 'form-builder.allow_partial_save' | translate }}</span>
                <span class="checkbox-description">{{ 'form-builder.users_can_save_incomplete_forms_as_drafts' | translate }}</span>
              </label>
            </div>

            <div class="form-group">
              <label for="max-submissions">{{ 'form-builder.maximum_submissions_per_user' | translate }}</label>
              <input type="number" id="max-submissions" formControlName="maxSubmissions" min="0" class="form-control" [placeholder]="'form-builder.0_for_unlimited' | translate">
              <span class="help-text">{{ 'form-builder.leave_as_0_for_unlimited_submissions' | translate }}</span>
            </div>

            <div class="form-group">
              <label for="expiration-date">{{ 'form-builder.expiration_date' | translate }}</label>
              <input type="date" id="expiration-date" formControlName="expirationDate" class="form-control">
              <span class="help-text">{{ 'form-builder.form_will_not_accept_submissions_after_this_date' | translate }}</span>
            </div>
          </div>

          <!-- Additional Settings -->
          <div class="settings-section">
            <h4>{{ 'form-builder.additional_settings' | translate }}</h4>
            
            <div class="form-group">
              <label for="instructions">{{ 'form-builder.form_instructions' | translate }}</label>
              <textarea id="instructions" formControlName="instructions" rows="4" class="form-control" [placeholder]="'form-builder.instructions_shown_to_users_before_filling_the_for' | translate"></textarea>
            </div>

            <div class="form-group">
              <label for="custom-css">{{ 'form-builder.custom_css' | translate }}</label>
              <textarea id="custom-css" formControlName="customCss" rows="4" placeholder="/* Custom styles for this form */" class="form-control" style="font-family: monospace;"></textarea>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Build Form Tab (formerly Design) -->
    <div *ngIf="activeTab === 'design'" class="design-panel" [class.properties-shown]="showFieldProperties && selectedField">
      
      <!-- Field Toolbox -->
      <div class="field-toolbox">
        <div class="toolbox-header">
          <h3>
            <span class="material-icons">widgets</span>{{ 'form-builder.field_types' | translate }}</h3>
        </div>
        
        <div class="toolbox-content">
          <!-- Basic Fields -->
          <div class="field-category">
            <h4>
              <span class="material-icons">text_fields</span>{{ 'form-builder.basic_fields' | translate }}</h4>
            <div class="field-type-list" cdkDropList id="basic-fields" cdkDropListSortingDisabled="true" [cdkDropListData]="basicFields" [cdkDropListConnectedTo]="['form-canvas']">
              <div *ngFor="let fieldType of basicFields" class="field-type-item" cdkDrag [cdkDragData]="fieldType.type" [title]="fieldType.description" (click)="addFieldToCanvas(fieldType.type)">
                <span class="material-icons">{{ fieldType.icon }}</span>
                <span class="field-label">{{ 'form-builder.' + fieldType.translationKey | translate }}</span>
              </div>
            </div>
          </div>

          <!-- Advanced Fields -->
          <div class="field-category">
            <h4>
              <span class="material-icons">tune</span>{{ 'form-builder.advanced_fields' | translate }}</h4>
            <div class="field-type-list" cdkDropList id="advanced-fields" cdkDropListSortingDisabled="true" [cdkDropListData]="advancedFields" [cdkDropListConnectedTo]="['form-canvas']">
              <div *ngFor="let fieldType of advancedFields" class="field-type-item" cdkDrag [cdkDragData]="fieldType.type" [title]="fieldType.description" (click)="addFieldToCanvas(fieldType.type)">
                <span class="material-icons">{{ fieldType.icon }}</span>
                <span class="field-label">{{ 'form-builder.' + fieldType.translationKey | translate }}</span>
              </div>
            </div>
          </div>

          <!-- Clinical Fields -->
          <div class="field-category">
            <h4>
              <span class="material-icons">local_hospital</span>{{ 'form-builder.clinical_fields' | translate }}</h4>
            <div class="field-type-list" cdkDropList id="clinical-fields" cdkDropListSortingDisabled="true" [cdkDropListData]="clinicalFields" [cdkDropListConnectedTo]="['form-canvas']">
              <div *ngFor="let fieldType of clinicalFields" class="field-type-item" cdkDrag [cdkDragData]="fieldType.type" [title]="fieldType.description" (click)="addFieldToCanvas(fieldType.type)">
                <span class="material-icons">{{ fieldType.icon }}</span>
                <span class="field-label">{{ 'form-builder.' + fieldType.translationKey | translate }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Canvas -->
      <div class="form-canvas">
        <div class="canvas-header">
          <h3>
            <span class="material-icons">article</span>{{ 'form-builder.form_layout' | translate }}</h3>
          <div class="canvas-actions">
            <button type="button" class="btn btn-link btn-sm" [title]="'form-builder.clear_all_fields' | translate">
              <span class="material-icons">clear_all</span>
            </button>
          </div>
        </div>
        
        <div class="canvas-content">
          <!-- Form Fields Drop Zone -->
          <div class="form-fields-container" cdkDropList id="form-canvas" [cdkDropListConnectedTo]="['basic-fields', 'advanced-fields', 'clinical-fields']" [cdkDropListData]="fieldsArray.controls" (cdkDropListDropped)="onFieldDrop($event)">
            
            <!-- Empty State -->
            <div *ngIf="fieldsArray.length === 0" class="empty-canvas">
              <span class="material-icons">drag_indicator</span>
              <p>{{ 'form-builder.drag_field_types_from_the_toolbox_to_start_buildin' | translate }}</p>
            </div>

            <!-- Form Fields -->
            <div *ngFor="let fieldControl of fieldsArray.controls; let i = index" class="form-field-item" cdkDrag [class.selected]="selectedField?.id === fieldControl.get('id')?.value" (click)="selectField(fieldControl.value)">
                
                <div class="field-drag-handle" cdkDragHandle>
                  <span class="material-icons">drag_indicator</span>
                </div>
                
                <div class="field-content">
                  <div class="field-header">
                    <div class="field-info">
                      <span>{{ 'form-builder.hidden_field' | translate }}</span>
                      <span class="field-type-icon material-icons">
                        {{ getFieldIcon(fieldControl.get('type')?.value) }}
                    </span>
                    <span class="field-label">{{ fieldControl.get('label')?.value }}</span>
                    <span *ngIf="fieldControl.get('isRequired')?.value" class="required-indicator">*</span>
                    <span *ngIf="fieldControl.get('isPhiField')?.value" class="phi-indicator" [title]="'form-builder.contains_phi' | translate">
                      <span class="material-icons">security</span>
                    </span>
                  </div>
                  
                  <div class="field-actions">
                    <button type="button" class="btn btn-link btn-sm" (click)="duplicateField(i); $event.stopPropagation()" [title]="'form-builder.duplicate_field' | translate">
                      <span class="material-icons">content_copy</span>
                    </button>
                    <button type="button" class="btn btn-link btn-sm text-danger" (click)="deleteField(i); $event.stopPropagation()" [title]="'form-builder.delete_field' | translate">
                      <span class="material-icons">delete</span>
                    </button>
                  </div>
                </div>
                
                <div class="field-preview">
                  <!-- Field preview based on type -->
                  <div [ngSwitch]="fieldControl.get('type')?.value" class="field-input-preview">
                    
                    <!-- Text Input -->
                    <input *ngSwitchCase="'text'" type="text" class="form-control" [placeholder]="fieldControl.get('placeholder')?.value" disabled>
                    
                    <!-- Textarea -->
                    <textarea *ngSwitchCase="'textarea'" class="form-control" [placeholder]="fieldControl.get('placeholder')?.value" rows="3" disabled></textarea>
                    
                    <!-- Number Input -->
                    <input *ngSwitchCase="'number'" type="number" class="form-control" [placeholder]="fieldControl.get('placeholder')?.value" disabled>
                    
                    <!-- Select Dropdown -->
                    <select *ngSwitchCase="'select'" class="form-control" disabled>
                      <option value="">{{ fieldControl.get('placeholder')?.value || ('form-builder.select_an_option' | translate) }}</option>
                      <option *ngFor="let option of fieldControl.get('options')?.value" [value]="option.value">
                        {{ option.label }}
                      </option>
                    </select>
                    
                    <!-- Multi-Select Dropdown -->
                    <div *ngSwitchCase="'multiselect'" class="multiselect-preview">
                      <div class="multiselect-display">
                        <span class="multiselect-placeholder" *ngIf="!fieldControl.get('options')?.value?.length">
                          {{ fieldControl.get('placeholder')?.value || ('form-builder.select_multiple_options' | translate) }}
                        </span>
                        <div class="multiselect-options" *ngIf="fieldControl.get('options')?.value?.length">
                          <div class="multiselect-option" *ngFor="let option of fieldControl.get('options')?.value">
                            <input type="checkbox" [value]="option.value" disabled>
                            <span>{{ option.label }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Radio Buttons -->
                    <div *ngSwitchCase="'radio'" class="radio-group">
                      <label *ngFor="let option of fieldControl.get('options')?.value" class="radio-option">
                        <input type="radio" [name]="fieldControl.get('name')?.value" [value]="option.value" disabled>
                        <span>{{ option.label }}</span>
                      </label>
                    </div>
                    
                    <!-- Checkbox Group -->
                    <div *ngSwitchCase="'checkbox'" class="checkbox-group-preview">
                      <label *ngFor="let option of fieldControl.get('options')?.value" class="checkbox-option">
                        <input type="checkbox" [value]="option.value" disabled>
                        <span>{{ option.label }}</span>
                      </label>
                    </div>
                    
                    <!-- Multi-select field preview -->
                    <div *ngSwitchCase="'multiselect'" class="multiselect-preview">
                      <div *ngIf="fieldControl.get('options')?.value?.length === 0" class="multiselect-placeholder">{{ 'form-builder.no_options_configured' | translate }}</div>
                      <div *ngFor="let option of fieldControl.get('options')?.value" class="multiselect-option">
                        <input type="checkbox" [value]="option.value" disabled>
                        <span>{{ option.label }}</span>
                      </div>
                    </div>
                    
                    <!-- Date Input -->
                    <input *ngSwitchCase="'date'" type="date" class="form-control" disabled>
                    
                    <!-- Time Input with AM/PM -->
                    <div *ngSwitchCase="'time'" class="time-input-preview">
                      <div class="time-input-container">
                        <input type="time" class="form-control time-field" [placeholder]="fieldControl.get('placeholder')?.value || 'Select time'" disabled>
                        <div class="time-period">
                          <button type="button" class="time-period-btn active" disabled>{{ 'form-builder.am' | translate }}</button>
                          <button type="button" class="time-period-btn" disabled>{{ 'form-builder.pm' | translate }}</button>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Boolean Toggle -->
                    <div *ngSwitchCase="'boolean'" class="boolean-preview">
                      <label class="boolean-toggle-preview">
                        <input type="checkbox" disabled>
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">{{ 'form-builder.yesno' | translate }}</span>
                      </label>
                    </div>
                    
                    <!-- File Upload -->
                    <div *ngSwitchCase="'file'" class="file-upload-preview">
                      <span class="material-icons">upload_file</span>
                      <span>{{ 'form-builder.choose_file_or_drag_here' | translate }}</span>
                    </div>
                    
                    <!-- Clinical Fields -->
                    <!-- Height -->
                    <div *ngSwitchCase="'height'" class="clinical-field-preview">
                      <div class="input-with-unit">
                        <input type="number" class="form-control" [placeholder]="fieldControl.get('placeholder')?.value || 'Enter height'" disabled>
                        <span class="unit-label">{{ getUnitConfigForField('height', getClinicalFieldUnit(fieldControl.get('id')?.value))?.label || 'cm' }}</span>
                        <button type="button" class="unit-toggle" (click)="toggleClinicalFieldUnit(fieldControl.get('id')?.value, 'height')" [title]="'form-builder.switch_units' | translate">
                          <span class="material-icons">swap_horiz</span>
                        </button>
                      </div>
                    </div>
                    
                    <!-- Weight -->
                    <div *ngSwitchCase="'weight'" class="clinical-field-preview">
                      <div class="input-with-unit">
                        <input type="number" class="form-control" [placeholder]="fieldControl.get('placeholder')?.value || 'Enter weight'" disabled>
                        <span class="unit-label">{{ getUnitConfigForField('weight', getClinicalFieldUnit(fieldControl.get('id')?.value))?.label || 'kg' }}</span>
                        <button type="button" class="unit-toggle" (click)="toggleClinicalFieldUnit(fieldControl.get('id')?.value, 'weight')" [title]="'form-builder.switch_units' | translate">
                          <span class="material-icons">swap_horiz</span>
                        </button>
                      </div>
                    </div>
                    
                    <!-- Temperature -->
                    <div *ngSwitchCase="'temperature'" class="clinical-field-preview">
                      <div class="input-with-unit">
                        <input type="number" class="form-control" [placeholder]="fieldControl.get('placeholder')?.value || 'Enter temperature'" disabled>
                        <span class="unit-label">{{ getUnitConfigForField('temperature', getClinicalFieldUnit(fieldControl.get('id')?.value))?.label || 'Â°C' }}</span>
                        <button type="button" class="unit-toggle" (click)="toggleClinicalFieldUnit(fieldControl.get('id')?.value, 'temperature')" [title]="'form-builder.switch_units' | translate">
                          <span class="material-icons">swap_horiz</span>
                        </button>
                      </div>
                    </div>
                    
                    <!-- Blood Pressure -->
                    <div *ngSwitchCase="'blood_pressure'" class="clinical-field-preview">
                      <div class="bp-inputs-preview">
                        <input type="number" class="form-control bp-input" disabled [placeholder]="'form-builder.systolic' | translate">
                        <span class="bp-separator">/</span>
                        <input type="number" class="form-control bp-input" disabled [placeholder]="'form-builder.diastolic' | translate">
                        <span class="unit-label">{{ 'form-builder.mmhg' | translate }}</span>
                      </div>
                    </div>
                    
                    <!-- Medication -->
                    <div *ngSwitchCase="'medication'" class="clinical-field-preview">
                      <div class="medication-preview">
                        <span class="material-icons">medication</span>
                        <span>{{ 'form-builder.medication_details_form' | translate }}</span>
                      </div>
                    </div>
                    
                    <!-- Diagnosis -->
                    <div *ngSwitchCase="'diagnosis'" class="clinical-field-preview">
                      <div class="diagnosis-preview">
                        <span class="material-icons">local_hospital</span>
                        <span>{{ 'form-builder.diagnosis_with_icd_codes' | translate }}</span>
                      </div>
                    </div>
                    
                    <!-- Default -->
                    <input *ngSwitchDefault type="text" class="form-control" [placeholder]="fieldControl.get('placeholder')?.value" disabled>
                  </div>
                  
                  <!-- Help Text -->
                  <div *ngIf="fieldControl.get('helpText')?.value" class="field-help-text">
                    {{ fieldControl.get('helpText')?.value }}
                  </div>
                </div>
              </div>
          </div>
        </div>
      </div>

        <!-- Field Properties Panel -->
        <div class="field-properties" [class.show]="showFieldProperties && selectedField">
        <div class="properties-header">
          <h3>
            <span class="material-icons">tune</span>
            {{ 'form-builder.field_properties' | translate }}
          </h3>
          <button type="button" class="btn btn-link btn-sm" (click)="showFieldProperties = false">
            <span class="material-icons">close</span>
          </button>
        </div>
        
        <div class="properties-content" *ngIf="selectedField">
          <form [formGroup]="builderForm">
            <!-- Find the selected field in the form array and bind to it -->
            <div *ngFor="let fieldControl of fieldsArray.controls; let i = index">
              <div *ngIf="fieldControl.get('id')?.value === selectedField.id" [formGroup]="$any(fieldControl)">
                
                <!-- Basic Properties -->
                <div class="property-section">
                  <h4>{{ 'form-builder.basic_properties' | translate }}</h4>
                  
                  <div class="form-group">
                    <label>{{ 'form-builder.field_label' | translate }} <span class="required">*</span></label>
                    <input type="text" class="form-control" formControlName="label">
                  </div>
                  
                  <div class="form-group">
                    <label>{{ 'form-builder.field_name' | translate }} <span class="required">*</span></label>
                    <input type="text" class="form-control" formControlName="name">
                  </div>
                  
                  <div class="form-group">
                    <label>{{ 'form-builder.placeholder_text' | translate }}</label>
                    <input type="text" class="form-control" formControlName="placeholder">
                  </div>
                  
                  <div class="form-group">
                    <label>{{ 'form-builder.help_text' | translate }}</label>
                    <textarea class="form-control" formControlName="helpText" rows="2"></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label>{{ 'form-builder.default_value' | translate }}</label>
                    <input type="text" class="form-control" formControlName="defaultValue">
                  </div>
                </div>

                <!-- Clinical Field Settings (for height, weight, temperature, blood_pressure) -->
                <div class="property-section" *ngIf="['height', 'weight', 'temperature', 'blood_pressure'].includes(fieldControl.get('type')?.value)">
                  <h4>{{ 'form-builder.clinical_field_settings' | translate }}</h4>
                  
                  <div class="form-group">
                    <label>{{ 'form-builder.unit_system' | translate }}</label>
                    <div class="unit-toggle-container">
                      <button type="button" class="unit-system-btn" [class.active]="getClinicalFieldUnit(fieldControl.get('id')?.value) === 'metric'" (click)="toggleClinicalFieldUnit(fieldControl.get('id')?.value, fieldControl.get('type')?.value)">
                        <span class="unit-system-label">{{ 'form-builder.metric' | translate }}</span>
                        <span class="unit-value">{{ getUnitConfigForField(fieldControl.get('type')?.value, 'metric')?.label }}</span>
                      </button>
                      <button type="button" class="unit-system-btn" [class.active]="getClinicalFieldUnit(fieldControl.get('id')?.value) === 'imperial'" (click)="toggleClinicalFieldUnit(fieldControl.get('id')?.value, fieldControl.get('type')?.value)">
                        <span class="unit-system-label">{{ 'form-builder.imperial' | translate }}</span>
                        <span class="unit-value">{{ getUnitConfigForField(fieldControl.get('type')?.value, 'imperial')?.label }}</span>
                      </button>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label>{{ 'form-builder.current_unit' | translate }}</label>
                    <input type="text" class="form-control" formControlName="unit" readonly>
                  </div>
                  
                  <div class="form-group">
                    <label>{{ 'form-builder.minimum_value' | translate }}</label>
                    <input type="number" class="form-control" formControlName="min">
                  </div>
                  
                  <div class="form-group">
                    <label>{{ 'form-builder.maximum_value' | translate }}</label>
                    <input type="number" class="form-control" formControlName="max">
                  </div>
                </div>

                <!-- Layout & Positioning -->
                <div class="property-section">
                  <h4>{{ 'form-builder.layout_positioning' | translate }}</h4>
                  
                  <div class="form-group">
                    <label>{{ 'form-builder.field_width' | translate }}</label>
                    <select class="form-control" formControlName="width">
                      <option value="100">{{ 'form-builder.full_width_100' | translate }}</option>
                      <option value="50">{{ 'form-builder.half_width_50' | translate }}</option>
                      <option value="33">{{ 'form-builder.third_width_33' | translate }}</option>
                      <option value="25">{{ 'form-builder.quarter_width_25' | translate }}</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label>{{ 'form-builder.column_position' | translate }}</label>
                    <select class="form-control" formControlName="columnPosition">
                      <option value="left">{{ 'form-builder.left_column' | translate }}</option>
                      <option value="right">{{ 'form-builder.right_column' | translate }}</option>
                      <option value="center">{{ 'form-builder.center' | translate }}</option>
                    </select>
                  </div>
                </div>

                <!-- Field Options (for select, radio, checkbox) -->
                <div class="property-section" *ngIf="fieldControl.get('type')?.value === 'select' || 
                         fieldControl.get('type')?.value === 'multiselect' ||
                         fieldControl.get('type')?.value === 'radio' || 
                         fieldControl.get('type')?.value === 'checkbox'">
                  <h4>{{ 'form-builder.options' | translate }}</h4>
                  
                  <div formArrayName="options">
                    <div *ngFor="let optionControl of getOptionsControls(fieldControl); let j = index" class="option-item" [formGroupName]="j">
                      <div class="form-group">
                        <input type="text" class="form-control" formControlName="label" [placeholder]="'form-builder.option_label' | translate">
                      </div>
                      <div class="form-group">
                        <input type="text" class="form-control" formControlName="value" [placeholder]="'form-builder.option_value' | translate">
                      </div>
                      <button type="button" class="btn btn-link btn-sm text-danger" (click)="removeOption(i, j)">
                        <span class="material-icons">delete</span>
                      </button>
                    </div>
                    
                    <button type="button" class="btn btn-outline btn-sm" (click)="addOption(i)">
                      <span class="material-icons">add</span>{{ 'form-builder.add_option' | translate }}</button>
                  </div>
                </div>

                <!-- Field Settings -->
                <div class="property-section">
                  <h4>{{ 'form-builder.field_settings' | translate }}</h4>
                  
                  <div class="checkbox-group">
                    <label class="checkbox-option">
                      <input type="checkbox" formControlName="isRequired">
                      <span>{{ 'form-builder.required_field' | translate }}</span>
                    </label>
                    
                    <label class="checkbox-option">
                      <input type="checkbox" formControlName="isReadonly">
                      <span>{{ 'form-builder.read_only' | translate }}</span>
                    </label>
                    
                    <label class="checkbox-option">
                      <input type="checkbox" formControlName="isHidden">
                      <span>{{ 'form-builder.hidden_field' | translate }}</span>
                    </label>
                    
                    <label class="checkbox-option">
                      <input type="checkbox" formControlName="isPhiField">
                      <span>{{ 'form-builder.contains_phi_data' | translate }}</span>
                    </label>
                  </div>
                </div>

                <!-- Validation Rules -->
                <div class="property-section">
                  <h4>{{ 'form-builder.validation_rules' | translate }}</h4>
                  
                  <div formArrayName="validationRules">
                    <div *ngFor="let ruleControl of getValidationRulesControls(fieldControl); let k = index" class="validation-rule-item" [formGroupName]="k">
                      
                      <div class="form-group">
                        <select class="form-control" formControlName="type">
                          <option value="">{{ 'form-builder.select_rule_type' | translate }}</option>
                          <option *ngFor="let rule of validationRules" [value]="rule.type">
                            {{ 'form-builder.' + rule.label | translate }}
                          </option>
                        </select>
                      </div>
                      
                      <div class="form-group" *ngIf="ruleControl.get('type')?.value && getValidationRule(ruleControl.get('type')?.value)?.hasValue">
                        <input type="text" class="form-control" formControlName="value" [placeholder]="'form-builder.rule_value' | translate">
                      </div>
                      
                      <div class="form-group">
                        <input type="text" class="form-control" formControlName="message" [placeholder]="'form-builder.error_message' | translate">
                      </div>
                      
                      <button type="button" class="btn btn-link btn-sm text-danger" (click)="removeValidationRule(i, k)">
                        <span class="material-icons">delete</span>
                      </button>
                    </div>
                    
                    <button type="button" class="btn btn-outline btn-sm" (click)="addValidationRule(i)">
                      <span class="material-icons">add</span>{{ 'form-builder.add_validation_rule' | translate }}</button>
                  </div>
                </div>

                <!-- Visibility Conditions (Branching Logic) -->
                <div class="property-section">
                  <h4>
                    <span class="material-icons">account_tree</span>
                    {{ 'form-builder.visibility_conditions' | translate }}
                    <small class="text-muted">{{ 'form-builder.branching_logic' | translate }}</small>
                  </h4>
                  
                  <div formArrayName="visibilityConditions">
                    <div *ngFor="let conditionControl of getVisibilityConditionsArray(i).controls; let m = index" 
                         class="visibility-condition-item" [formGroupName]="m">
                      
                      <!-- Logical Operator (for multiple conditions) -->
                      <div class="form-group" *ngIf="m > 0">
                        <select class="form-control form-control-sm" formControlName="logicalOperator">
                          <option value="and">{{ 'form-builder.and' | translate }}</option>
                          <option value="or">{{ 'form-builder.or' | translate }}</option>
                        </select>
                      </div>
                      
                      <div class="condition-row">
                        <!-- Field Selection -->
                        <div class="form-group">
                          <label>{{ 'form-builder.when_field' | translate }}</label>
                          <select class="form-control" formControlName="questionId">
                            <option value="">{{ 'form-builder.select_field' | translate }}</option>
                            <option *ngFor="let availableField of getAvailableFieldsForConditions(i)" 
                                    [value]="availableField.name">
                              {{ availableField.label }} ({{ availableField.name }})
                            </option>
                          </select>
                        </div>
                        
                        <!-- Operator Selection -->
                        <div class="form-group">
                          <label>{{ 'form-builder.operator' | translate }}</label>
                          <select class="form-control" formControlName="operator">
                            <option value="">{{ 'form-builder.select_operator' | translate }}</option>
                            <ng-container *ngIf="conditionControl.get('questionId')?.value">
                              <option *ngFor="let op of getConditionOperators(getFieldTypeByName(conditionControl.get('questionId')?.value))" 
                                      [value]="op.value">
                                {{ op.label }}
                              </option>
                            </ng-container>
                          </select>
                        </div>
                        
                        <!-- Value Input -->
                        <div class="form-group" *ngIf="!['is-answered', 'is-not-answered'].includes(conditionControl.get('operator')?.value)">
                          <label>{{ 'form-builder.value' | translate }}</label>
                          
                          <!-- For select fields, show options dropdown -->
                          <select class="form-control" formControlName="value" 
                                  *ngIf="isSelectField(conditionControl.get('questionId')?.value) && 
                                         ['equals', 'not-equals', 'selected', 'not-selected'].includes(conditionControl.get('operator')?.value)">
                            <option value="">{{ 'form-builder.select_option' | translate }}</option>
                            <option *ngFor="let opt of getFieldOptions(conditionControl.get('questionId')?.value)" 
                                    [value]="opt.value">
                              {{ opt.label }}
                            </option>
                          </select>
                          
                          <!-- For other fields, show text input -->
                          <input type="text" class="form-control" formControlName="value" 
                                 *ngIf="!isSelectField(conditionControl.get('questionId')?.value) || 
                                        !['equals', 'not-equals', 'selected', 'not-selected'].includes(conditionControl.get('operator')?.value)"
                                 [placeholder]="'form-builder.enter_value' | translate">
                        </div>
                        
                        <!-- Remove Button -->
                        <button type="button" class="btn btn-link btn-sm text-danger remove-condition-btn" 
                                (click)="removeVisibilityCondition(i, m)"
                                [title]="'form-builder.remove_condition' | translate">
                          <span class="material-icons">close</span>
                        </button>
                      </div>
                    </div>
                    
                    <!-- Add Condition Button -->
                    <button type="button" class="btn btn-outline-primary btn-sm" (click)="addVisibilityCondition(i)">
                      <span class="material-icons">add</span>
                      {{ 'form-builder.add_visibility_condition' | translate }}
                    </button>
                    
                    <!-- Help Text -->
                    <div class="help-text mt-2">
                      <small class="text-muted">
                        <span class="material-icons">info</span>
                        {{ 'form-builder.visibility_conditions_help' | translate }}
                      </small>
                    </div>
                  </div>
                </div>

                <!-- Audit Trail Settings -->
                <div class="property-section" formGroupName="auditTrail">
                  <h4>{{ 'form-builder.audit_trail' | translate }}</h4>
                  
                  <div class="checkbox-group">
                    <label class="checkbox-option">
                      <input type="checkbox" formControlName="trackChanges">
                      <span>{{ 'form-builder.track_field_changes' | translate }}</span>
                    </label>
                    
                    <label class="checkbox-option">
                      <input type="checkbox" formControlName="reasonRequired">
                      <span>{{ 'form-builder.require_change_reason' | translate }}</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Preview Tab -->
    <div *ngIf="isActiveTab('preview')" class="preview-panel">
      <div class="preview-header">
        <h3>
          <span class="material-icons">visibility</span>{{ 'form-builder.form_preview' | translate }}</h3>
        <div class="preview-actions">
          <button type="button" class="btn btn-outline btn-sm">
            <span class="material-icons">devices</span>{{ 'form-builder.responsive_view' | translate }}</button>
        </div>
      </div>
      
      <div class="preview-content">
        <!-- Use the actual form-preview component with live template data -->
        <app-form-preview [template]="getCurrentTemplateData()" [readonly]="false" (formDataChanged)="onPreviewDataChanged($event)" (formSubmitted)="onPreviewSubmitted($event)" (formSaved)="onPreviewSaved($event)">
        </app-form-preview>
      </div>
    </div>

  </div>

  <!-- Unsaved Changes Warning -->
  <div *ngIf="hasUnsavedChanges" class="unsaved-changes-warning">
    <span class="material-icons">warning</span>
    <span>{{ 'form-builder.you_have_unsaved_changes' | translate }}</span>
  </div>
</div>